<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>F1 Duel</title>
  <script src="https://telegram.org/js/telegram-web-app.js"></script>
  <style>
    :root{
      --bg:#0f1115;--card:#171a22;--muted:#9aa3b2;--text:#fff;
      --accent:#8cffc1;--danger:#ff5c5c;--line:#252a36;--shadow:0 12px 30px rgba(0,0,0,.35);
      --r:16px;
    }
    *{box-sizing:border-box}
    body{margin:0;font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif;background:var(--bg);color:var(--text)}
    .app{min-height:100vh;padding-bottom:86px}
    .topbar{position:sticky;top:0;z-index:10;background:rgba(15,17,21,.92);backdrop-filter:blur(10px);border-bottom:1px solid var(--line);padding:14px 16px;display:flex;align-items:center;justify-content:space-between;gap:12px}
    .brand{display:flex;align-items:center;gap:10px;font-weight:900}
    .chip{font-size:12px;padding:6px 10px;border:1px solid var(--line);border-radius:999px;color:var(--muted);white-space:nowrap}
    .container{padding:16px}
    .row{display:flex;gap:12px;flex-wrap:wrap}
    .card{background:var(--card);border:1px solid var(--line);border-radius:var(--r);box-shadow:var(--shadow);padding:14px}
    .card h2{margin:0 0 8px 0;font-size:16px}
    .muted{color:var(--muted)}
    .btn{appearance:none;border:none;cursor:pointer;border-radius:12px;padding:12px 14px;font-size:15px;font-weight:900;width:100%}
    .btn.primary{background:var(--accent);color:#07110c}
    .btn.ghost{background:transparent;border:1px solid var(--line);color:var(--text)}
    .btn.danger{background:var(--danger);color:#1a0b0b}
    .grid{display:grid;grid-template-columns:1fr 1fr;gap:12px}
    .tile{
      background:linear-gradient(180deg,rgba(140,255,193,.10),rgba(255,255,255,0));
      border:1px solid var(--line);border-radius:var(--r);padding:14px;min-height:120px;
      display:flex;flex-direction:column;justify-content:space-between;cursor:pointer;user-select:none
    }
    .tile .t{font-weight:950}
    .tile .d{font-size:12px;color:var(--muted);margin-top:6px}
    .pill{display:inline-flex;align-items:center;gap:8px;padding:10px 12px;border:1px solid var(--line);border-radius:14px;background:rgba(255,255,255,.02)}
    .kv{display:flex;justify-content:space-between;gap:12px;padding:10px 0;border-top:1px solid var(--line)}.kv:first-child{border-top:none;padding-top:0}
    .nav{
      position:fixed;left:0;right:0;bottom:0;height:72px;background:rgba(15,17,21,.92);backdrop-filter:blur(10px);
      border-top:1px solid var(--line);display:flex;padding:10px 10px 14px;gap:10px;z-index:20
    }
    .nav button{
      flex:1;border:none;background:transparent;color:var(--muted);border-radius:14px;padding:10px 8px;font-size:12px;cursor:pointer;
      display:flex;flex-direction:column;align-items:center;justify-content:center;gap:6px
    }
    .nav button.active{color:var(--text);background:rgba(140,255,193,.12);border:1px solid rgba(140,255,193,.25)}
    .icon{font-size:18px;line-height:1}
    .hidden{display:none!important}
    .note{font-size:12px;color:var(--muted);margin-top:10px;line-height:1.35}
    .toast{
      position:fixed;left:50%;bottom:86px;transform:translateX(-50%);
      background:rgba(0,0,0,.75);color:#fff;padding:10px 12px;border-radius:12px;border:1px solid rgba(255,255,255,.12);
      box-shadow:var(--shadow);font-size:13px;z-index:999;max-width:90vw;text-align:center;
      opacity:0;pointer-events:none;transition:opacity .18s ease
    }
    .toast.show{opacity:1}

    /* --- Penalty visuals --- */
    .stage{
      position:relative;width:100%;max-width:420px;margin:0 auto 14px;height:260px;border-radius:16px;border:1px solid var(--line);overflow:hidden;
      background:
        radial-gradient(500px 240px at 50% 15%, rgba(255,255,255,.12), rgba(255,255,255,0)),
        linear-gradient(180deg, rgba(140,255,193,.07), rgba(0,0,0,0)),
        #0b0d12;
    }
    .net{
      position:absolute;left:24px;right:24px;top:26px;height:120px;border-radius:16px;
      border:2px solid rgba(255,255,255,.25);
      box-shadow:0 18px 50px rgba(0,0,0,.45) inset;
    }
    .net:before{
      content:"";position:absolute;inset:0;
      background-image:
        linear-gradient(rgba(255,255,255,.10) 1px, transparent 1px),
        linear-gradient(90deg, rgba(255,255,255,.10) 1px, transparent 1px);
      background-size: 24px 24px;
      opacity:.55;border-radius:16px;
    }
    .goalLine{
      position:absolute;left:24px;right:24px;top:146px;height:2px;background:rgba(255,255,255,.20);
    }
    .keeper{
      position:absolute;top:78px;left:50%;transform:translateX(-50%);
      width:52px;height:52px;border-radius:18px;
      background:rgba(255,255,255,.16);
      border:1px solid rgba(255,255,255,.20);
      box-shadow:0 10px 24px rgba(0,0,0,.35);
    }
    .keeper:after{
      content:"";position:absolute;left:10px;right:10px;bottom:-18px;height:18px;border-radius:0 0 14px 14px;
      background:rgba(255,255,255,.10);border:1px solid rgba(255,255,255,.10);
    }
    .ball{
      position:absolute;left:50%;bottom:18px;transform:translateX(-50%);
      width:22px;height:22px;border-radius:50%;
      background: radial-gradient(circle at 30% 30%, #fff, #cfd6e6);
      box-shadow:0 10px 20px rgba(0,0,0,.35);
    }
    .flash{position:absolute;inset:0;opacity:0;transition:opacity .15s ease}
    .aimDot{
      position:absolute;width:10px;height:10px;border-radius:50%;
      background:rgba(140,255,193,.9);box-shadow:0 0 18px rgba(140,255,193,.6);
      opacity:.0;transition:opacity .12s ease;
    }
    .aimDot.show{opacity:1}
    .hudSmall{font-size:12px;color:var(--muted);text-align:center;margin-top:6px}

    @keyframes kickL { from{transform:translateX(-50%) translateY(0) scale(1)} to{transform:translateX(-220%) translateY(-175px) scale(.55)} }
    @keyframes kickC { from{transform:translateX(-50%) translateY(0) scale(1)} to{transform:translateX(-50%) translateY(-190px) scale(.55)} }
    @keyframes kickR { from{transform:translateX(-50%) translateY(0) scale(1)} to{transform:translateX(120%) translateY(-175px) scale(.55)} }
    @keyframes keepL { from{transform:translateX(-50%)} to{transform:translateX(-155%)} }
    @keyframes keepC { from{transform:translateX(-50%)} to{transform:translateX(-50%)} }
    @keyframes keepR { from{transform:translateX(-50%)} to{transform:translateX(55%)} }

    /* Integrated timing bar (overlay) */
    .timingWrap{
      position:absolute;left:14px;right:14px;bottom:10px;
      border:1px solid rgba(255,255,255,.12);border-radius:14px;
      padding:10px;background:rgba(0,0,0,.25);
      backdrop-filter: blur(6px);
    }
    .timingBar{height:10px;border-radius:999px;background:rgba(255,255,255,.10);position:relative;overflow:hidden}
    .timingIdeal{position:absolute;top:0;bottom:0;border-radius:999px;background:rgba(140,255,193,.32)}
    .timingNeedle{position:absolute;top:-6px;width:2px;height:22px;background:#fff;box-shadow:0 0 14px rgba(255,255,255,.35)}
    .timingHead{display:flex;justify-content:space-between;gap:10px;margin-bottom:6px;font-size:12px;color:var(--muted)}
    .badge{font-size:12px;padding:6px 10px;border-radius:999px;border:1px solid rgba(255,255,255,.12);background:rgba(255,255,255,.04);color:var(--muted)}

    /* D-pad */
    .pad{
      width:160px;margin: 8px auto 0;
      display:grid;grid-template-columns:1fr 1fr 1fr;grid-template-rows:1fr 1fr 1fr;gap:10px;
    }
    .pad button{
      border:none;border-radius:14px;
      background:rgba(255,255,255,.05);
      border:1px solid rgba(255,255,255,.10);
      color:#fff;font-weight:950;font-size:16px;padding:12px 0;
      cursor:pointer;
    }
    .pad button:active{transform:scale(.98)}
    .pad .c{grid-column:2;grid-row:2}
    .pad .u{grid-column:2;grid-row:1}
    .pad .l{grid-column:1;grid-row:2}
    .pad .r{grid-column:3;grid-row:2}

    /* --- Pong: field look --- */
    .pongCanvas{
      width:100%;max-width:440px;
      border:1px solid var(--line);
      border-radius:18px;
      display:block;margin:0 auto;
      background:#0b0d12;
    }
  </style>
</head>
<body>
  <div class="app">
    <div class="topbar">
      <div class="brand"><span>üèÅ F1 Duel</span><span id="envChip" class="chip">WebApp</span></div>
      <div class="chip" id="userChip">–ì–æ—Å—Ç—å</div>
    </div>

    <main class="container">
      <!-- GAMES -->
      <section id="page-games">
        <div class="card" style="margin-bottom:12px;">
          <h2>–í—ã–±–æ—Ä –∏–≥—Ä—ã</h2>
          <div class="muted">Reaction ‚Ä¢ Penalty (FIFA-style —É–ø—Ä–∞–≤–ª–µ–Ω–∏–µ + —Ç–∞–π–º–∏–Ω–≥) ‚Ä¢ Ping Pong (–ø–æ–ª–µ + ‚Äú—á–µ–ª–æ–≤–µ—á–Ω—ã–π‚Äù –±–æ—Ç).</div>
        </div>

        <div class="grid">
          <div class="tile" onclick="openGame('reaction')">
            <div><div class="t">‚ö° Reaction Duel</div><div class="d">–°–∫–æ—Ä–æ—Å—Ç—å —Ä–µ–∞–∫—Ü–∏–∏</div></div>
            <div class="muted" style="font-size:12px;">–û—Ç–∫—Ä—ã—Ç—å</div>
          </div>
          <div class="tile" onclick="openGame('penalty')">
            <div><div class="t">‚öΩÔ∏è Penalty Duel</div><div class="d">D-pad + —Ç–∞–π–º–∏–Ω–≥ –∑–∞ –≤—Ä–µ–º—è</div></div>
            <div class="muted" style="font-size:12px;">–û—Ç–∫—Ä—ã—Ç—å</div>
          </div>
          <div class="tile" onclick="openGame('pong')">
            <div><div class="t">üèì Ping Pong</div><div class="d">–ü–æ–ª–µ + –±–æ—Ç –∫–∞–∫ —á–µ–ª–æ–≤–µ–∫</div></div>
            <div class="muted" style="font-size:12px;">–û—Ç–∫—Ä—ã—Ç—å</div>
          </div>
          <div class="tile" onclick="toast('–°–∫–æ—Ä–æ üôÇ')">
            <div><div class="t">üß† Quiz Sprint</div><div class="d">–ü–æ–∑–∂–µ</div></div>
            <div class="muted" style="font-size:12px;">–°–∫–æ—Ä–æ</div>
          </div>
        </div>

        <div class="note">–ó–≤—É–∫ –∏ –≤–∏–±—Ä–∞—Ü–∏–∏ –≤–∫–ª—é—á–∞—é—Ç—Å—è –ø–æ—Å–ª–µ –ø–µ—Ä–≤–æ–≥–æ —Ç–∞–ø–∞ (—Ç–∞–∫ —É—Å—Ç—Ä–æ–µ–Ω—ã –±—Ä–∞—É–∑–µ—Ä—ã).</div>
      </section>

      <!-- WALLET -->
      <section id="page-wallet" class="hidden">
        <div class="card">
          <h2>–ë–∞–ª–∞–Ω—Å</h2>
          <div class="row" style="margin: 10px 0 14px;">
            <div class="pill" style="flex:1; justify-content:space-between;"><span>ü™ô Coins</span><strong id="coinsVal">0</strong></div>
            <div class="pill" style="flex:1; justify-content:space-between;"><span>‚≠ê Stars</span><strong id="starsVal">0</strong></div>
          </div>
          <div class="kv"><span class="muted">–£—Ä–æ–≤–µ–Ω—å</span><strong id="levelVal">1</strong></div>
          <div class="kv"><span class="muted">–ü–æ–±–µ–¥—ã</span><strong id="winsVal">0</strong></div>
          <div class="kv"><span class="muted">–ò–≥—Ä—ã</span><strong id="playsVal">0</strong></div>

          <div style="margin-top:14px;" class="row">
            <button class="btn primary" onclick="addCoins(10); toast('+10 coins')">+10 coins (—Ç–µ—Å—Ç)</button>
            <button class="btn ghost" onclick="convertCoinsToStars()">coins ‚Üí stars</button>
          </div>
          <button style="margin-top:10px;" class="btn danger" onclick="resetProgress()">–°–±—Ä–æ—Å–∏—Ç—å –ø—Ä–æ–≥—Ä–µ—Å—Å</button>
          <div class="note">–ü–æ–∫–∞ –≤—Å—ë –ª–æ–∫–∞–ª—å–Ω–æ (localStorage). –î–ª—è PvP –Ω—É–∂–µ–Ω backend.</div>
        </div>
      </section>

      <!-- PROFILE -->
      <section id="page-profile" class="hidden">
        <div class="card">
          <h2>–õ–∏—á–Ω—ã–π –∫–∞–±–∏–Ω–µ—Ç</h2>
          <div class="muted" id="profileLine">‚Äî</div>
          <div style="margin-top:14px;">
            <div class="kv"><span class="muted">–ù–∏–∫</span><strong id="nickVal">‚Äî</strong></div>
            <div class="kv"><span class="muted">Telegram ID</span><strong id="tgidVal">‚Äî</strong></div>
            <div class="kv"><span class="muted">–°—Ç–∞—Ç—É—Å</span><strong id="statusVal">–ù–æ–≤–∏—á–æ–∫</strong></div>
          </div>
          <div style="margin-top:14px;" class="row">
            <button class="btn ghost" onclick="toast('–°–∫–æ—Ä–æ üôÇ')">–ù–∞—Å—Ç—Ä–æ–π–∫–∏</button>
            <button class="btn primary" onclick="go('games')">–ò–≥—Ä–∞—Ç—å</button>
          </div>
        </div>
      </section>

      <!-- REACTION -->
      <section id="page-reaction" class="hidden">
        <div class="card" style="margin-bottom:12px;">
          <h2>‚ö° Reaction Duel</h2><div class="muted">–ñ–º–∏ ¬´–ñ–¥–∞—Ç—å —Å—Ç–∞—Ä—Ç¬ª, –∑–∞—Ç–µ–º —Ç–∞–ø –ø–æ —Å–∏–≥–Ω–∞–ª—É. –§–∞–ª—å—Å—Ç–∞—Ä—Ç ‚Äî —à—Ç—Ä–∞—Ñ.</div>
        </div>
        <div class="card">
          <div id="light" style="width:120px;height:120px;border-radius:50%;margin:8px auto 18px;background:red;box-shadow:0 0 20px red;"></div>
          <button id="startBtn" class="btn primary">–ñ–¥–∞—Ç—å —Å—Ç–∞—Ä—Ç</button>
          <div id="result" style="margin-top:14px;font-size:20px;font-weight:950;"></div>
          <div class="note">+5 coins (–∏ +3 –µ—Å–ª–∏ &lt;250ms). –§–∞–ª—å—Å—Ç–∞—Ä—Ç ‚àí2.</div>
          <button style="margin-top:12px;" class="btn ghost" onclick="go('games')">‚Üê –ù–∞–∑–∞–¥</button>
        </div>
      </section>

      <!-- PENALTY -->
      <section id="page-penalty" class="hidden">
        <div class="card" style="margin-bottom:12px;">
          <h2>‚öΩÔ∏è Penalty Duel</h2>
          <div class="muted">
            –ö–∞–∫ –≤ FIFA: –≤—ã–±–∏—Ä–∞–µ—à—å –Ω–∞–ø—Ä–∞–≤–ª–µ–Ω–∏–µ (–≥–µ–π–º–ø–∞–¥) ‚Üí —Ç–∞–π–º–∏–Ω–≥ –∏–¥—ë—Ç —Å—Ä–∞–∑—É ‚Üí –∑–∞ –æ–≥—Ä–∞–Ω–∏—á–µ–Ω–Ω–æ–µ –≤—Ä–µ–º—è –∂–º—ë—à—å ¬´–£–î–ê–†¬ª.
          </div>
        </div>

        <div class="card">
          <div class="row" style="margin:0 0 12px;">
            <div class="pill" style="flex:1; justify-content:space-between;"><span>ü•Ö –ì–æ–ª—ã</span><strong id="penScore">0</strong></div>
            <div class="pill" style="flex:1; justify-content:space-between;"><span>üéØ –£–¥–∞—Ä</span><strong id="penShot">1/5</strong></div>
          </div>

          <div id="penStage" class="stage">
            <div class="net"></div>
            <div class="goalLine"></div>

            <div id="penAimL" class="aimDot" style="left:74px; top:58px;"></div>
            <div id="penAimC" class="aimDot" style="left:50%; top:48px; transform:translateX(-50%);"></div>
            <div id="penAimR" class="aimDot" style="right:74px; top:58px;"></div>

            <div id="keeper" class="keeper"></div>
            <div id="ball" class="ball"></div>
            <div id="penFlash" class="flash"></div>

            <!-- timing overlay -->
            <div id="timingWrap" class="timingWrap hidden">
              <div class="timingHead">
                <span id="timingText">–¢–∞–π–º–∏–Ω–≥</span>
                <span class="badge" id="timingTimer">1.2s</span>
              </div>
              <div class="timingBar">
                <div class="timingIdeal" id="timingIdeal"></div>
                <div class="timingNeedle" id="timingNeedle"></div>
              </div>
            </div>
          </div>

          <div class="hudSmall" id="penHint">–í—ã–±–µ—Ä–∏ –Ω–∞–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –Ω–∞ –≥–µ–π–º–ø–∞–¥–µ –Ω–∏–∂–µ.</div>

          <div class="pad" style="margin-top:10px;">
            <button class="u" onclick="penPick('C')">‚¨ÜÔ∏è</button>
            <button class="l" onclick="penPick('L')">‚¨ÖÔ∏è</button>
            <button class="c" onclick="penPick('C')">üéØ</button>
            <button class="r" onclick="penPick('R')">‚û°Ô∏è</button>
          </div>

          <div class="row" style="margin-top:12px;">
            <button id="penShootBtn" class="btn primary" onclick="penShootTap()">–£–î–ê–†</button>
            <button class="btn ghost" onclick="penRestart()">–ó–∞–Ω–æ–≤–æ —Å–µ—Ä–∏—é</button>
          </div>

          <div id="penMsg" style="margin-top:12px;text-align:center;font-size:18px;font-weight:950;"></div>
          <div id="penSub" class="muted" style="margin-top:6px;text-align:center;"></div>

          <div class="note">
            –ì–æ–ª: +2 coins; –ü–æ–±–µ–¥–∞ (3+ –∏–∑ 5): +10 coins –∏ +1 win.
          </div>

          <button style="margin-top:12px;" class="btn ghost" onclick="go('games')">‚Üê –ù–∞–∑–∞–¥</button>
        </div>
      </section>

      <!-- PONG -->
      <section id="page-pong" class="hidden">
        <div class="card" style="margin-bottom:12px;">
          <h2>üèì Ping Pong</h2>
          <div class="muted">–ü–æ–ª–µ –∫–∞–∫ –ø–æ–ª–µ, –ø–ª–∞—Ç—Ñ–æ—Ä–º—ã —Å–∫—Ä—É–≥–ª–µ–Ω—ã, –±–æ—Ç –¥–≤–∏–≥–∞–µ—Ç—Å—è ‚Äú–ø–æ-—á–µ–ª–æ–≤–µ—á–µ—Å–∫–∏‚Äù. –ü–æ–±–µ–¥–∞ –¥–æ 3 –æ—á–∫–æ–≤.</div>
        </div>
        <div class="card">
          <div class="row" style="margin:0 0 12px;">
            <div class="pill" style="flex:1; justify-content:space-between;"><span>üôÇ –¢—ã</span><strong id="pongMe">0</strong></div>
            <div class="pill" style="flex:1; justify-content:space-between;"><span>ü§ñ –ë–æ—Ç</span><strong id="pongAi">0</strong></div>
          </div>
          <div class="row" style="margin:0 0 12px;">
            <div class="pill" style="flex:1; justify-content:space-between;"><span>üî• –†–æ–∑—ã–≥—Ä—ã—à</span><strong id="pongRally">0</strong></div>
            <div class="pill" style="flex:1; justify-content:space-between;"><span>‚ö° –°–ª–æ–∂–Ω–æ—Å—Ç—å</span><strong id="pongDiff">1.0</strong></div>
          </div>
          <canvas id="pongCanvas" class="pongCanvas" width="440" height="560"></canvas>
          <div class="row" style="margin-top:12px;">
            <button id="pongStartBtn" class="btn primary" onclick="pongStart()">–°—Ç–∞—Ä—Ç</button>
            <button class="btn ghost" onclick="pongReset()">–°–±—Ä–æ—Å</button>
          </div>
          <button style="margin-top:12px;" class="btn ghost" onclick="pongStop(); go('games')">‚Üê –ù–∞–∑–∞–¥</button>
          <div class="note">–¢–∞–ø –ø–æ –ø–æ–ª—é = power-shot (–∫–æ–≥–¥–∞ –º—è—á –±–ª–∏–∑–∫–æ). –°–ª–æ–∂–Ω–æ—Å—Ç—å —Ä–∞—Å—Ç—ë—Ç –ø–ª–∞–≤–Ω–æ –≤–Ω—É—Ç—Ä–∏ —Ä–æ–∑—ã–≥—Ä—ã—à–∞, –ø–æ—ç—Ç–æ–º—É –∏–≥—Ä–∞ –∏–¥—ë—Ç –±—ã—Å—Ç—Ä–µ–µ.</div>
        </div>
      </section>

    </main>
  </div>

  <nav class="nav">
    <button id="tab-games" onclick="go('games')"><div class="icon">üéÆ</div><div>–ò–≥—Ä—ã</div></button>
    <button id="tab-wallet" onclick="go('wallet')"><div class="icon">üí∞</div><div>–ë–∞–ª–∞–Ω—Å</div></button>
    <button id="tab-profile" onclick="go('profile')"><div class="icon">üë§</div><div>–ö–∞–±–∏–Ω–µ—Ç</div></button>
  </nav>

  <div id="toast" class="toast"></div>

<script>
  // Telegram
  const tg = window.Telegram?.WebApp;
  try{ tg?.ready(); tg?.expand(); }catch(e){}

  // Haptics
  function hImpact(type="light"){ try{ tg?.HapticFeedback?.impactOccurred(type); }catch(e){} }
  function hNote(type="success"){ try{ tg?.HapticFeedback?.notificationOccurred(type); }catch(e){} }
  function hSelect(){ try{ tg?.HapticFeedback?.selectionChanged(); }catch(e){} }

  // Audio (WebAudio)
  let audioUnlocked=false, audioCtx=null;
  function unlockAudio(){
    if(audioUnlocked) return;
    try{
      audioCtx = new (window.AudioContext || window.webkitAudioContext)();
      const o=audioCtx.createOscillator(), g=audioCtx.createGain();
      o.connect(g); g.connect(audioCtx.destination);
      g.gain.value=0.0001; o.start(); o.stop(audioCtx.currentTime+0.01);
      audioUnlocked=true;
    }catch(e){}
  }
  function beep(freq=440,dur=0.08,vol=0.06,type="sine"){
    if(!audioCtx) return;
    const t=audioCtx.currentTime;
    const o=audioCtx.createOscillator(); const g=audioCtx.createGain();
    o.type=type; o.frequency.value=freq;
    g.gain.setValueAtTime(0.0001,t);
    g.gain.exponentialRampToValueAtTime(vol,t+0.01);
    g.gain.exponentialRampToValueAtTime(0.0001,t+dur);
    o.connect(g); g.connect(audioCtx.destination);
    o.start(t); o.stop(t+dur+0.02);
  }
  const sKick=()=>{beep(140,0.06,0.08,"triangle");beep(90,0.08,0.05,"sine");};
  const sGoal=()=>{beep(660,0.08,0.08,"sine");beep(880,0.10,0.08,"sine");};
  const sSave=()=>{beep(220,0.10,0.06,"square");};
  const sMiss=()=>{beep(180,0.14,0.05,"sawtooth");};

  // Helpers
  function clamp(v,min,max){ return Math.max(min, Math.min(max, v)); }

  // Local state
  const storeKey="f1duel_state_v3";
  const defaultState={coins:0,stars:0,wins:0,plays:0};
  const state=(()=>{ try{const r=localStorage.getItem(storeKey); return r?{...defaultState,...JSON.parse(r)}:{...defaultState}; }catch(e){ return {...defaultState}; } })();
  const toastEl=document.getElementById("toast"); let toastTimer=null;
  function toast(t){ toastEl.textContent=t; toastEl.classList.add("show"); clearTimeout(toastTimer); toastTimer=setTimeout(()=>toastEl.classList.remove("show"), 1600); }
  function saveState(){ localStorage.setItem(storeKey, JSON.stringify(state)); renderWallet(); }
  function calcLevel(){ const score=state.coins+state.stars*50; return Math.max(1, Math.floor(score/200)+1); }
  function renderWallet(){
    document.getElementById("coinsVal").textContent=state.coins;
    document.getElementById("starsVal").textContent=state.stars;
    document.getElementById("winsVal").textContent=state.wins;
    document.getElementById("playsVal").textContent=state.plays;
    document.getElementById("levelVal").textContent=calcLevel();
  }
  function addCoins(n){ state.coins=Math.max(0, state.coins+n); saveState(); }
  function convertCoinsToStars(){
    const rate=100;
    if(state.coins<rate){ toast(`–ù—É–∂–Ω–æ –º–∏–Ω–∏–º—É–º ${rate} coins`); return; }
    const s=Math.floor(state.coins/rate);
    state.coins-=s*rate; state.stars+=s; saveState(); toast(`–û–±–º–µ–Ω: +${s} ‚≠ê`);
  }
  function resetProgress(){ Object.assign(state,{...defaultState}); saveState(); toast("–ü—Ä–æ–≥—Ä–µ—Å—Å —Å–±—Ä–æ—à–µ–Ω"); }

  // Routing
  const pages=["games","wallet","profile","reaction","penalty","pong"];
  function go(page){
    pages.forEach(p=>document.getElementById("page-"+p).classList.toggle("hidden", p!==page));
    ["games","wallet","profile"].forEach(t=>document.getElementById("tab-"+t).classList.toggle("active", t===page));
    if(page==="reaction"||page==="penalty"||page==="pong"){
      document.getElementById("tab-games").classList.add("active");
      ["wallet","profile"].forEach(t=>document.getElementById("tab-"+t).classList.remove("active"));
    }
    location.hash="#"+page;
  }
  function openGame(id){ if(id==="reaction")go("reaction"); if(id==="penalty")go("penalty"); if(id==="pong")go("pong"); }

  // Header info
  const envChip=document.getElementById("envChip"), userChip=document.getElementById("userChip");
  envChip.textContent=tg?"Telegram WebApp":"Browser";
  const user=tg?.initDataUnsafe?.user;
  if(user){
    const nick=user.username||user.first_name||"Player";
    userChip.textContent="@"+nick;
    document.getElementById("nickVal").textContent=nick;
    document.getElementById("tgidVal").textContent=user.id;
    document.getElementById("profileLine").textContent=`–ü—Ä–∏–≤–µ—Ç, ${nick}.`;
  } else {
    document.getElementById("profileLine").textContent="–û—Ç–∫—Ä–æ–π —á–µ—Ä–µ–∑ Telegram, —á—Ç–æ–±—ã –ø–æ–¥—Ç—è–Ω—É–ª—Å—è –ø—Ä–æ—Ñ–∏–ª—å.";
  }

  // =========================
  // REACTION
  // =========================
  const light=document.getElementById("light"), startBtn=document.getElementById("startBtn"), result=document.getElementById("result");
  let startTime=0, waiting=false, timer=null;
  function setLight(c){ light.style.background=c; light.style.boxShadow=(c==="lime")?"0 0 30px lime":"0 0 20px red"; }
  startBtn.onclick=()=>{
    unlockAudio(); hImpact("light");
    if(waiting) return;
    result.textContent=""; setLight("red"); waiting=true; startBtn.textContent="–ñ–î–ò‚Ä¶";
    timer=setTimeout(()=>{ setLight("lime"); startTime=Date.now(); hImpact("medium"); beep(520,0.06,0.05,"sine"); }, 1800+Math.random()*2600);
  };
  light.onclick=()=>{
    unlockAudio();
    if(!waiting) return;
    if(!startTime){
      clearTimeout(timer);
      result.textContent="‚ùå –§–∞–ª—å—Å—Ç–∞—Ä—Ç! ‚àí2 coins";
      addCoins(-2); toast("–§–∞–ª—å—Å—Ç–∞—Ä—Ç ‚àí2"); hNote("error"); sMiss();
      waiting=false; startTime=0; startBtn.textContent="–ï—â—ë —Ä–∞–∑";
      return;
    }
    const r=Date.now()-startTime;
    state.plays += 1;
    let reward=5; if(r<250) reward += 3;
    addCoins(reward); saveState();
    result.textContent=`‚ö° ${r} –º—Å  ‚Ä¢  +${reward} coins`;
    toast(`+${reward} coins`); hNote("success"); sGoal();
    waiting=false; startTime=0; startBtn.textContent="–ï—â—ë —Ä–∞–∑";
  };

  // =========================
  // PENALTY (FIFA-ish control + integrated timing)
  // =========================
  const penScoreEl=document.getElementById("penScore");
  const penShotEl=document.getElementById("penShot");
  const penMsgEl=document.getElementById("penMsg");
  const penSubEl=document.getElementById("penSub");
  const penHint=document.getElementById("penHint");
  const penShootBtn=document.getElementById("penShootBtn");

  const penStage=document.getElementById("penStage");
  const ballEl=document.getElementById("ball");
  const keeperEl=document.getElementById("keeper");
  const flashEl=document.getElementById("penFlash");

  const aimL=document.getElementById("penAimL");
  const aimC=document.getElementById("penAimC");
  const aimR=document.getElementById("penAimR");

  const timingWrap=document.getElementById("timingWrap");
  const timingIdeal=document.getElementById("timingIdeal");
  const timingNeedle=document.getElementById("timingNeedle");
  const timingTimer=document.getElementById("timingTimer");
  const timingText=document.getElementById("timingText");

  let penShot=1, penGoals=0, penActive=true;

  let penDir=null;
  let penLocked=false;

  // timing state
  let barOn=false, barT=0, barV=0, barLastTs=0;
  let idealA=0.40, idealB=0.60;
  let timeLeft=1.2; // seconds to tap shot
  let timeoutHandle=null;

  function penRender(){
    penScoreEl.textContent=penGoals;
    penShotEl.textContent=`${Math.min(penShot,5)}/5`;
  }
  function penRestart(){
    unlockAudio(); hImpact("light");
    penShot=1; penGoals=0; penActive=true;
    penDir=null; penLocked=false;
    penMsgEl.textContent=""; penSubEl.textContent="";
    penHint.textContent="–í—ã–±–µ—Ä–∏ –Ω–∞–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –Ω–∞ –≥–µ–π–º–ø–∞–¥–µ –Ω–∏–∂–µ.";
    penShootBtn.disabled=false; penShootBtn.textContent="–£–î–ê–†";
    hideAim(); resetPenaltyAnim(); stopTiming(true);
    penRender();
    toast("–ù–æ–≤–∞—è —Å–µ—Ä–∏—è");
  }
  function hideAim(){ aimL.classList.remove("show"); aimC.classList.remove("show"); aimR.classList.remove("show"); }
  function showAim(d){
    hideAim();
    (d==="L"?aimL:d==="C"?aimC:aimR).classList.add("show");
  }
  function resetPenaltyAnim(){
    ballEl.style.animation=""; ballEl.style.transform="translateX(-50%)";
    keeperEl.style.animation=""; keeperEl.style.transform="translateX(-50%)";
    flashEl.style.opacity="0";
  }

  function newIdealWindow(){
    // –±–æ–ª–µ–µ "—Ä–µ–∞–ª—å–Ω–æ": –∑–æ–Ω–∞ –∏–¥–µ–∞–ª–∞ –Ω–µ –º–∏–∫—Ä–æ—Å–∫–æ–ø–∏—á–µ—Å–∫–∞—è
    const size = 0.18 + Math.random()*0.06; // 0.18..0.24
    const center = 0.36 + Math.random()*0.28; // 0.36..0.64
    idealA = center - size/2; idealB = center + size/2;
    timingIdeal.style.left = (idealA*100)+"%";
    timingIdeal.style.width = ((idealB-idealA)*100)+"%";
  }

  function startTiming(){
    barOn=true; barT=0; barLastTs=0;
    timeLeft = 1.25; // –Ω–µ–º–Ω–æ–≥–æ –±–æ–ª—å—à–µ, —á—Ç–æ–±—ã "–ø–æ–ø–∞—Å—Ç—å –±—ã–ª–æ —Ä–µ–∞–ª—å–Ω–æ"
    timingWrap.classList.remove("hidden");
    newIdealWindow();
    penLocked=true;
    penHint.textContent="–°–µ–π—á–∞—Å —Ç–∞–π–º–∏–Ω–≥ –∏–¥—ë—Ç. –ñ–º–∏ ¬´–£–î–ê–†¬ª –ø–æ–∫–∞ –Ω–µ –∫–æ–Ω—á–∏–ª–æ—Å—å –≤—Ä–µ–º—è.";
    timingText.textContent="–¢–∞–π–º–∏–Ω–≥ —É–¥–∞—Ä–∞";
    hImpact("medium"); beep(420,0.06,0.05,"sine");

    // ticking
    function tick(ts){
      if(!barOn) return;
      if(!barLastTs) barLastTs = ts;
      const dt = (ts - barLastTs)/1000;
      barLastTs = ts;

      // needle speed (FIFA-ish)
      const speed = 2.1;
      barT += dt * speed;
      barV = 0.5 + 0.5*Math.sin(barT*2.2*Math.PI);
      timingNeedle.style.left = (barV*100)+"%";

      timeLeft = Math.max(0, timeLeft - dt);
      timingTimer.textContent = timeLeft.toFixed(1) + "s";

      if(timeLeft<=0){
        // auto-shot if user didn't tap
        penShootTap(true);
        return;
      }
      requestAnimationFrame(tick);
    }
    requestAnimationFrame(tick);
  }

  function stopTiming(hide){
    barOn=false;
    if(timeoutHandle){ clearTimeout(timeoutHandle); timeoutHandle=null; }
    if(hide) timingWrap.classList.add("hidden");
  }

  function chooseKeeper(){
    // keeper human-ish: —á–∞—â–µ —Ü–µ–Ω—Ç—Ä, –Ω–æ –Ω–µ –≤—Å–µ–≥–¥–∞
    const r=Math.random();
    if(r<0.42) return "C";
    return Math.random()<0.5 ? "L" : "R";
  }

  function animatePenalty(dir, keeper){
    resetPenaltyAnim();
    void ballEl.offsetWidth;

    const animBall = dir==="L" ? "kickL" : dir==="C" ? "kickC" : "kickR";
    const animKeeper = keeper==="L" ? "keepL" : keeper==="C" ? "keepC" : "keepR";
    ballEl.style.animation = `${animBall} .34s ease-out forwards`;
    keeperEl.style.animation = `${animKeeper} .30s ease-out forwards`;

    hImpact("medium"); sKick();
  }

  // public pick
  window.penPick = (d)=>{
    unlockAudio(); hSelect();
    if(!penActive) return;
    if(penLocked) return;

    penDir=d;
    showAim(d);
    penMsgEl.textContent = d==="L"?"‚¨ÖÔ∏è –õ–µ–≤–æ":d==="C"?"‚¨ÜÔ∏è –¶–µ–Ω—Ç—Ä":"‚û°Ô∏è –ü—Ä–∞–≤–æ";
    penSubEl.textContent = "–°–µ–π—á–∞—Å –Ω–∞—á–Ω—ë—Ç—Å—è —Ç–∞–π–º–∏–Ω–≥ ‚Äî –±—É–¥—å –≥–æ—Ç–æ–≤.";
    startTiming();
  };

  // tap to shoot (user must hit during timing)
  window.penShootTap = (auto=false)=>{
    unlockAudio();
    if(!penActive) return;

    // if no direction picked -> do nothing
    if(!penDir){
      toast("–°–Ω–∞—á–∞–ª–∞ –≤—ã–±–µ—Ä–∏ –Ω–∞–ø—Ä–∞–≤–ª–µ–Ω–∏–µ");
      hNote("error"); sMiss();
      return;
    }
    // if timing not running -> ignore
    if(!penLocked || !barOn){
      toast("–¢–∞–π–º–∏–Ω–≥ –µ—â—ë –Ω–µ –∏–¥—ë—Ç");
      return;
    }

    stopTiming(true);

    const inIdeal = (barV>=idealA && barV<=idealB);
    const center = (idealA+idealB)/2;
    const centerDist = Math.abs(barV-center);
    let power = 1.0 - clamp(centerDist*2.2, 0, 1); // 0..1
    power = clamp(power + (inIdeal?0.10:-0.10), 0, 1);

    const keeper = chooseKeeper();
    animatePenalty(penDir, keeper);

    // more realistic outcome:
    // miss chance low unless far from ideal or too much power
    const out = inIdeal ? 0 : Math.min(Math.abs(barV-idealA), Math.abs(barV-idealB));
    const missChance = clamp((inIdeal?0.03:0.10 + out*0.65) + (power>0.88?0.06:0), 0.03, 0.36);

    let missed=false, saved=false;
    if(Math.random() < missChance){
      missed=true;
    } else {
      const sameDir = (keeper===penDir);
      const saveBase = sameDir ? 0.48 : 0.18;
      const saveChance = clamp(saveBase - power*0.28, 0.08, 0.62);
      saved = (Math.random() < saveChance);
    }

    // feedback a bit later
    setTimeout(()=>{
      if(missed){
        penMsgEl.textContent = auto ? "‚è±Ô∏è –í–†–ï–ú–Ø –í–´–®–õ–û ‚Äî –ú–ò–ú–û!" : "‚ùå –ú–ò–ú–û!";
        penSubEl.textContent = `–¢–∞–π–º–∏–Ω–≥: ${inIdeal?"–∏–¥–µ–∞–ª":"–º–∏–º–æ"} ‚Ä¢ —Å–∏–ª–∞: ${Math.round(power*100)}%`;
        flashEl.style.background="rgba(255,92,92,.18)"; flashEl.style.opacity="1"; setTimeout(()=>flashEl.style.opacity="0",120);
        hNote("error"); sMiss();
      } else if(saved){
        penMsgEl.textContent = "üß§ –°–ï–ô–í!";
        penSubEl.textContent = `–í—Ä–∞—Ç–∞—Ä—å: ${keeper==="L"?"–ª–µ–≤–æ":keeper==="C"?"—Ü–µ–Ω—Ç—Ä":"–ø—Ä–∞–≤–æ"} ‚Ä¢ —Å–∏–ª–∞: ${Math.round(power*100)}%`;
        flashEl.style.background="rgba(255,92,92,.18)"; flashEl.style.opacity="1"; setTimeout(()=>flashEl.style.opacity="0",120);
        hNote("error"); sSave();
      } else {
        penGoals += 1;
        addCoins(2);
        penMsgEl.textContent = "‚öΩÔ∏è –ì–û–û–û–õ! +2 coins";
        penSubEl.textContent = `–¢–∞–π–º–∏–Ω–≥: ${inIdeal?"–∏–¥–µ–∞–ª":"–Ω–æ—Ä–º"} ‚Ä¢ —Å–∏–ª–∞: ${Math.round(power*100)}%`;
        flashEl.style.background="rgba(140,255,193,.18)"; flashEl.style.opacity="1"; setTimeout(()=>flashEl.style.opacity="0",120);
        hNote("success"); sGoal();
      }

      penShot += 1;
      penRender();

      // reset shot state
      setTimeout(()=>{
        resetPenaltyAnim();
        penDir=null; hideAim();
        penLocked=false;
        penHint.textContent="–í—ã–±–µ—Ä–∏ –Ω–∞–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –Ω–∞ –≥–µ–π–º–ø–∞–¥–µ –Ω–∏–∂–µ.";
        if(penShot===6){
          penActive=false;
          state.plays += 1;
          if(penGoals>=3){
            state.wins += 1;
            addCoins(10);
            penMsgEl.textContent = `üèÜ –ü–æ–±–µ–¥–∞! ${penGoals}/5 ‚Ä¢ +10 coins`;
            hNote("success"); sGoal();
          } else {
            penMsgEl.textContent = `–°–µ—Ä–∏—è –æ–∫–æ–Ω—á–µ–Ω–∞: ${penGoals}/5`;
          }
          saveState();
          penShootBtn.disabled=true;
        }
      }, 280);
    }, 220);
  };

  // =========================
  // PONG (field + human-like AI + smoother difficulty)
  // =========================
  const canvas=document.getElementById("pongCanvas");
  const ctx=canvas.getContext("2d");

  const pongMeEl=document.getElementById("pongMe");
  const pongAiEl=document.getElementById("pongAi");
  const pongRallyEl=document.getElementById("pongRally");
  const pongDiffEl=document.getElementById("pongDiff");
  const pongStartBtn=document.getElementById("pongStartBtn");

  const W=canvas.width, H=canvas.height;

  let pongRunning=false, rafId=null;

  const p1={w:110,h:14,x:W/2-55,y:H-34};   // player (rounded)
  const p2={w:110,h:14,x:W/2-55,y:22};     // AI (rounded)
  const ball={r:7,x:W/2,y:H/2,vx:3.1,vy:3.6};

  let me=0, ai=0;
  let rally=0;           // within a point
  let diff=1.0;          // shown difficulty
  let powerUntil=0;      // power-shot window
  let aiLag=0.10;        // human reaction delay seconds
  let aiError=10;        // px error
  let aiBias=0;          // drift
  let lastPointTime=0;

  function roundRect(x,y,w,h,r){
    const rr = Math.min(r, w/2, h/2);
    ctx.beginPath();
    ctx.moveTo(x+rr,y);
    ctx.arcTo(x+w,y,x+w,y+h,rr);
    ctx.arcTo(x+w,y+h,x,y+h,rr);
    ctx.arcTo(x,y+h,x,y,rr);
    ctx.arcTo(x,y,x+w,y,rr);
    ctx.closePath();
  }
  function clampX(v){ return clamp(v, 0, W); }

  function resetBall(towardsPlayer){
    ball.x=W/2; ball.y=H/2;
    rally=0;
    diff=1.0;
    // human-like ai params reset
    aiLag = 0.09 + Math.random()*0.10;
    aiError = 10 + Math.random()*10;
    aiBias = (Math.random()*2-1)*14;

    const base=3.0 + Math.random()*0.8;
    ball.vx = (Math.random()>.5?1:-1)*base;
    ball.vy = (towardsPlayer?1:-1)*(3.2 + Math.random()*1.0);
    lastPointTime=performance.now();
    hudPong();
  }
  function hudPong(){
    pongMeEl.textContent=me;
    pongAiEl.textContent=ai;
    pongRallyEl.textContent=rally;
    pongDiffEl.textContent=diff.toFixed(1);
  }

  function drawField(){
    // grass
    ctx.clearRect(0,0,W,H);
    ctx.fillStyle="#0b2a15";
    ctx.fillRect(0,0,W,H);

    // stripes
    ctx.globalAlpha=.08;
    for(let i=0;i<10;i++){
      ctx.fillStyle = (i%2===0) ? "#ffffff" : "#000000";
      ctx.fillRect(0, i*(H/10), W, H/10);
    }
    ctx.globalAlpha=1;

    // lines
    ctx.strokeStyle="rgba(255,255,255,.22)";
    ctx.lineWidth=2;

    // outer border
    ctx.strokeRect(14,14,W-28,H-28);

    // center line
    ctx.beginPath();
    ctx.moveTo(14, H/2);
    ctx.lineTo(W-14, H/2);
    ctx.stroke();

    // center circle
    ctx.beginPath();
    ctx.arc(W/2, H/2, 54, 0, Math.PI*2);
    ctx.stroke();

    // center dot
    ctx.fillStyle="rgba(255,255,255,.22)";
    ctx.beginPath();
    ctx.arc(W/2, H/2, 3, 0, Math.PI*2);
    ctx.fill();
  }

  function drawPong(){
    drawField();

    // paddles
    ctx.fillStyle="#8cffc1";
    roundRect(p1.x, p1.y, p1.w, p1.h, 10);
    ctx.fill();

    ctx.fillStyle="rgba(255,255,255,.25)";
    roundRect(p2.x, p2.y, p2.w, p2.h, 10);
    ctx.fill();

    // ball
    const now=performance.now();
    const powerActive = now < powerUntil;
    ctx.fillStyle = powerActive ? "#8cffc1" : "#ffffff";
    ctx.beginPath();
    ctx.arc(ball.x, ball.y, ball.r, 0, Math.PI*2);
    ctx.fill();

    // little glow on power
    if(powerActive){
      ctx.globalAlpha=.18;
      ctx.fillStyle="#8cffc1";
      ctx.fillRect(14, H-110, W-28, 96);
      ctx.globalAlpha=1;
    }
  }

  function collide(p, b){
    return (b.x + b.r > p.x && b.x - b.r < p.x + p.w && b.y + b.r > p.y && b.y - b.r < p.y + p.h);
  }

  function aiHumanMove(dt){
    // difficulty grows smoothly within a rally (faster earlier so game doesn't drag)
    // curve: diff = 1 + 0.10*rally + timeSincePoint*0.15, capped
    const t = (performance.now() - lastPointTime)/1000;
    diff = clamp(1.0 + rally*0.10 + t*0.16, 1.0, 2.0);

    // "human" target: slightly lagged and with error + bias
    const targetX = ball.x - p2.w/2 + aiBias;

    // reaction lag: sometimes bot "hesitates" a bit when ball changes direction
    const speed = (3.2 + diff*1.8); // px per frame-ish
    // add micro random walk (human hand jitter)
    const jitter = (Math.random()*2-1) * (0.6 + diff*0.5);

    // error increases when ball fast: simulate misses
    const err = aiError + (Math.abs(ball.vy)*0.8);

    // move toward target with smoothing and "wrong-way" feint sometimes
    let desired = targetX + (Math.random()*2-1)*err;
    // occasional feint (rare)
    if(Math.random() < 0.012 * diff){
      desired += (Math.random()<0.5 ? -1 : 1) * (18 + Math.random()*24);
    }

    const dx = (desired - p2.x);
    const step = clamp(dx, -speed, speed);
    p2.x = clamp(p2.x + step + jitter, 14, W-14 - p2.w);
  }

  function pongReset(){
    pongStop();
    me=0; ai=0;
    p1.x=W/2-p1.w/2; p2.x=W/2-p2.w/2;
    resetBall(true);
    pongStartBtn.textContent="–°—Ç–∞—Ä—Ç";
    hudPong();
    drawPong();
  }

  function pongStart(){
    unlockAudio();
    if(pongRunning) return;
    pongRunning=true;
    pongStartBtn.textContent="–ò–¥—ë—Ç‚Ä¶";
    toast("–ü–æ–µ—Ö–∞–ª–∏!");
    loop();
  }
  function pongStop(){
    pongRunning=false;
    if(rafId) cancelAnimationFrame(rafId);
    rafId=null;
  }

  function endPong(){
    pongStop();
    state.plays += 1;
    if(me >= 3){
      state.wins += 1;
      addCoins(15);
      toast("üèÜ –ü–æ–±–µ–¥–∞! +15 coins");
      hNote("success"); sGoal();
    } else {
      toast("–ü–æ—Ä–∞–∂–µ–Ω–∏–µ üòÑ");
      hNote("error"); sMiss();
    }
    saveState();
    pongStartBtn.textContent="–°—ã–≥—Ä–∞—Ç—å –µ—â—ë";
  }

  let lastTs=0;
  function loop(ts){
    if(!pongRunning) return;
    if(!lastTs) lastTs=ts;
    const dt = Math.min(0.035, (ts-lastTs)/1000);
    lastTs=ts;

    // AI
    aiHumanMove(dt);

    // ball move (smooth difficulty: speed multiplier grows with diff)
    const speedMul = 1.0 + (diff-1.0)*0.9;
    ball.x += ball.vx * speedMul;
    ball.y += ball.vy * speedMul;

    // walls
    if(ball.x - ball.r <= 14 || ball.x + ball.r >= W-14){
      ball.vx *= -1;
      ball.x = clamp(ball.x, 14+ball.r, (W-14)-ball.r);
      beep(260,0.04,0.03,"sine");
    }

    // collisions
    if(ball.vy > 0 && collide(p1, ball)){
      ball.vy *= -1;
      const hit = (ball.x - (p1.x + p1.w/2)) / (p1.w/2);
      ball.vx += hit * 1.15;
      ball.vx = clamp(ball.vx, -6.2, 6.2);
      rally += 1;
      hImpact("light");
      beep(520,0.04,0.03,"triangle");

      // power-shot if active
      if(performance.now() < powerUntil){
        ball.vx += hit * 1.6;
        ball.vy *= 1.06;
        hImpact("medium");
        beep(740,0.05,0.05,"triangle");
        toast("‚ö° Power-shot!");
        powerUntil = 0;
      }
      hudPong();
    }

    if(ball.vy < 0 && collide(p2, ball)){
      ball.vy *= -1;
      const hit = (ball.x - (p2.x + p2.w/2)) / (p2.w/2);
      ball.vx += hit * 0.85;
      ball.vx = clamp(ball.vx, -6.2, 6.2);
      beep(360,0.04,0.03,"square");
      hudPong();
    }

    // scoring
    if(ball.y - ball.r <= 14){
      me += 1;
      toast("–û—á–∫–æ —Ç–µ–±–µ!");
      beep(840,0.06,0.04,"sine");
      resetBall(false);
    }
    if(ball.y + ball.r >= H-14){
      ai += 1;
      toast("–û—á–∫–æ –±–æ—Ç—É");
      beep(180,0.08,0.04,"square");
      resetBall(true);
    }
    hudPong();

    if(me >= 3 || ai >= 3){
      endPong();
      drawPong();
      return;
    }

    drawPong();
    rafId = requestAnimationFrame(loop);
  }

  // Player control
  function setPaddleFromClientX(clientX){
    const rect=canvas.getBoundingClientRect();
    const x=(clientX-rect.left)*(W/rect.width);
    p1.x = clamp(x - p1.w/2, 14, W-14 - p1.w);
  }
  canvas.addEventListener("mousemove",(e)=>setPaddleFromClientX(e.clientX));
  canvas.addEventListener("touchmove",(e)=>{e.preventDefault();setPaddleFromClientX(e.touches[0].clientX)},{passive:false});

  // Power-shot
  function triggerPower(){
    if(!pongRunning) return;
    powerUntil = performance.now() + 220;
    hImpact("light");
  }
  canvas.addEventListener("mousedown",()=>{unlockAudio();triggerPower();});
  canvas.addEventListener("touchstart",(e)=>{e.preventDefault();unlockAudio();triggerPower();},{passive:false});

  // Boot
  renderWallet();
  penRender();
  pongReset();
  const initial=(location.hash||"#games").slice(1);
  go(pages.includes(initial)?initial:"games");
</script>
</body>
</html>



