<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>F1 Duel</title>
  <script src="https://telegram.org/js/telegram-web-app.js"></script>
  <style>
    :root{--bg:#0f1115;--card:#171a22;--muted:#9aa3b2;--text:#fff;--accent:#8cffc1;--danger:#ff5c5c;--line:#252a36;--shadow:0 12px 30px rgba(0,0,0,.35);--r:16px}
    *{box-sizing:border-box}body{margin:0;font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif;background:var(--bg);color:var(--text)}
    .app{min-height:100vh;padding-bottom:86px}
    .topbar{position:sticky;top:0;z-index:10;background:rgba(15,17,21,.92);backdrop-filter:blur(10px);border-bottom:1px solid var(--line);padding:14px 16px;display:flex;align-items:center;justify-content:space-between;gap:12px}
    .brand{display:flex;align-items:center;gap:10px;font-weight:800}
    .chip{font-size:12px;padding:6px 10px;border:1px solid var(--line);border-radius:999px;color:var(--muted);white-space:nowrap}
    .container{padding:16px}.row{display:flex;gap:12px;flex-wrap:wrap}
    .card{background:var(--card);border:1px solid var(--line);border-radius:var(--r);box-shadow:var(--shadow);padding:14px}
    .card h2{margin:0 0 8px 0;font-size:16px}.muted{color:var(--muted)}
    .btn{appearance:none;border:none;cursor:pointer;border-radius:12px;padding:12px 14px;font-size:15px;font-weight:700;width:100%}
    .btn.primary{background:var(--accent);color:#07110c}.btn.ghost{background:transparent;border:1px solid var(--line);color:var(--text)}.btn.danger{background:var(--danger);color:#1a0b0b}
    .grid{display:grid;grid-template-columns:1fr 1fr;gap:12px}
    .tile{background:linear-gradient(180deg,rgba(140,255,193,.10),rgba(255,255,255,0));border:1px solid var(--line);border-radius:var(--r);padding:14px;min-height:120px;display:flex;flex-direction:column;justify-content:space-between;cursor:pointer;user-select:none}
    .tile .t{font-weight:850}.tile .d{font-size:12px;color:var(--muted);margin-top:6px}
    .pill{display:inline-flex;align-items:center;gap:8px;padding:10px 12px;border:1px solid var(--line);border-radius:14px;background:rgba(255,255,255,.02)}
    .kv{display:flex;justify-content:space-between;gap:12px;padding:10px 0;border-top:1px solid var(--line)}.kv:first-child{border-top:none;padding-top:0}
    .nav{position:fixed;left:0;right:0;bottom:0;height:72px;background:rgba(15,17,21,.92);backdrop-filter:blur(10px);border-top:1px solid var(--line);display:flex;padding:10px 10px 14px;gap:10px;z-index:20}
    .nav button{flex:1;border:none;background:transparent;color:var(--muted);border-radius:14px;padding:10px 8px;font-size:12px;cursor:pointer;display:flex;flex-direction:column;align-items:center;justify-content:center;gap:6px}
    .nav button.active{color:var(--text);background:rgba(140,255,193,.12);border:1px solid rgba(140,255,193,.25)}
    .icon{font-size:18px;line-height:1}.hidden{display:none!important}
    .note{font-size:12px;color:var(--muted);margin-top:10px;line-height:1.35}
    .toast{position:fixed;left:50%;bottom:86px;transform:translateX(-50%);background:rgba(0,0,0,.75);color:#fff;padding:10px 12px;border-radius:12px;border:1px solid rgba(255,255,255,.12);box-shadow:var(--shadow);font-size:13px;z-index:999;max-width:90vw;text-align:center;opacity:0;pointer-events:none;transition:opacity .18s ease}
    .toast.show{opacity:1}
  </style>
</head>
<body>
  <div class="app">
    <div class="topbar">
      <div class="brand"><span>üèÅ F1 Duel</span><span id="envChip" class="chip">WebApp</span></div>
      <div class="chip" id="userChip">–ì–æ—Å—Ç—å</div>
    </div>

    <main class="container">
      <!-- GAMES -->
      <section id="page-games">
        <div class="card" style="margin-bottom:12px;">
          <h2>–í—ã–±–æ—Ä –∏–≥—Ä—ã</h2>
          <div class="muted">Reaction ‚Ä¢ Penalty ‚Ä¢ Ping Pong (—É—Å–∫–æ—Ä–µ–Ω–∏–µ, power-shot, –∫–æ–º–±–æ).</div>
        </div>

        <div class="grid">
          <div class="tile" onclick="openGame('reaction')">
            <div><div class="t">‚ö° Reaction Duel</div><div class="d">–°–∫–æ—Ä–æ—Å—Ç—å —Ä–µ–∞–∫—Ü–∏–∏ ‚Ä¢ 1 –∏–≥—Ä–æ–∫</div></div>
            <div class="muted" style="font-size:12px;">–û—Ç–∫—Ä—ã—Ç—å</div>
          </div>
          <div class="tile" onclick="openGame('penalty')">
            <div><div class="t">‚öΩÔ∏è Penalty Duel</div><div class="d">–°–µ—Ä–∏—è 5 —É–¥–∞—Ä–æ–≤</div></div>
            <div class="muted" style="font-size:12px;">–û—Ç–∫—Ä—ã—Ç—å</div>
          </div>
          <div class="tile" onclick="openGame('pong')">
            <div><div class="t">üèì Ping Pong</div><div class="d">–£—Å–∫–æ—Ä–µ–Ω–∏–µ ‚Ä¢ power-shot ‚Ä¢ –∫–æ–º–±–æ</div></div>
            <div class="muted" style="font-size:12px;">–û—Ç–∫—Ä—ã—Ç—å</div>
          </div>
          <div class="tile" onclick="toast('–°–∫–æ—Ä–æ üôÇ')">
            <div><div class="t">üß† Quiz Sprint</div><div class="d">–ü–æ–∑–∂–µ</div></div>
            <div class="muted" style="font-size:12px;">–°–∫–æ—Ä–æ</div>
          </div>
        </div>

        <div class="note">Pong: –¥–≤–∏–≥–∞–µ—à—å –ø–ª–∞—Ç—Ñ–æ—Ä–º—É, –∞ —Ç–∞–ø –ø–æ –ø–æ–ª—é –¥–∞—ë—Ç power-shot (–æ–∫–Ω–æ ~220–º—Å).</div>
      </section>

      <!-- WALLET -->
      <section id="page-wallet" class="hidden">
        <div class="card">
          <h2>–ë–∞–ª–∞–Ω—Å</h2>
          <div class="row" style="margin: 10px 0 14px;">
            <div class="pill" style="flex:1; justify-content:space-between;"><span>ü™ô Coins</span><strong id="coinsVal">0</strong></div>
            <div class="pill" style="flex:1; justify-content:space-between;"><span>‚≠ê Stars</span><strong id="starsVal">0</strong></div>
          </div>
          <div class="kv"><span class="muted">–£—Ä–æ–≤–µ–Ω—å</span><strong id="levelVal">1</strong></div>
          <div class="kv"><span class="muted">–ü–æ–±–µ–¥—ã</span><strong id="winsVal">0</strong></div>
          <div class="kv"><span class="muted">–ò–≥—Ä—ã</span><strong id="playsVal">0</strong></div>

          <div style="margin-top:14px;" class="row">
            <button class="btn primary" onclick="addCoins(10); toast('+10 coins')">+10 coins (—Ç–µ—Å—Ç)</button>
            <button class="btn ghost" onclick="convertCoinsToStars()">coins ‚Üí stars</button>
          </div>
          <button style="margin-top:10px;" class="btn danger" onclick="resetProgress()">–°–±—Ä–æ—Å–∏—Ç—å –ø—Ä–æ–≥—Ä–µ—Å—Å</button>
          <div class="note">–ü–æ–∫–∞ –≤—Å—ë –ª–æ–∫–∞–ª—å–Ω–æ (localStorage). –î–ª—è PvP –Ω—É–∂–µ–Ω backend.</div>
        </div>
      </section>

      <!-- PROFILE -->
      <section id="page-profile" class="hidden">
        <div class="card">
          <h2>–õ–∏—á–Ω—ã–π –∫–∞–±–∏–Ω–µ—Ç</h2>
          <div class="muted" id="profileLine">‚Äî</div>
          <div style="margin-top:14px;">
            <div class="kv"><span class="muted">–ù–∏–∫</span><strong id="nickVal">‚Äî</strong></div>
            <div class="kv"><span class="muted">Telegram ID</span><strong id="tgidVal">‚Äî</strong></div>
            <div class="kv"><span class="muted">–°—Ç–∞—Ç—É—Å</span><strong id="statusVal">–ù–æ–≤–∏—á–æ–∫</strong></div>
          </div>
          <div style="margin-top:14px;" class="row">
            <button class="btn ghost" onclick="toast('–°–∫–æ—Ä–æ üôÇ')">–ù–∞—Å—Ç—Ä–æ–π–∫–∏</button>
            <button class="btn primary" onclick="go('games')">–ò–≥—Ä–∞—Ç—å</button>
          </div>
        </div>
      </section>

      <!-- REACTION -->
      <section id="page-reaction" class="hidden">
        <div class="card" style="margin-bottom:12px;">
          <h2>‚ö° Reaction Duel</h2><div class="muted">–ñ–º–∏ ¬´–ñ–¥–∞—Ç—å —Å—Ç–∞—Ä—Ç¬ª, –∑–∞—Ç–µ–º —Ç–∞–ø –ø–æ —Å–∏–≥–Ω–∞–ª—É. –§–∞–ª—å—Å—Ç–∞—Ä—Ç ‚Äî —à—Ç—Ä–∞—Ñ.</div>
        </div>
        <div class="card">
          <div id="light" style="width:120px;height:120px;border-radius:50%;margin:8px auto 18px;background:red;box-shadow:0 0 20px red;"></div>
          <button id="startBtn" class="btn primary">–ñ–¥–∞—Ç—å —Å—Ç–∞—Ä—Ç</button>
          <div id="result" style="margin-top:14px;font-size:20px;font-weight:850;"></div>
          <div class="note">+5 coins (–∏ +3 –µ—Å–ª–∏ &lt;250ms). –§–∞–ª—å—Å—Ç–∞—Ä—Ç ‚àí2.</div>
          <button style="margin-top:12px;" class="btn ghost" onclick="go('games')">‚Üê –ù–∞–∑–∞–¥</button>
        </div>
      </section>

      <!-- PENALTY -->
      <section id="page-penalty" class="hidden">
        <div class="card" style="margin-bottom:12px;">
          <h2>‚öΩÔ∏è Penalty Duel</h2><div class="muted">–í—ã–±–µ—Ä–∏ –Ω–∞–ø—Ä–∞–≤–ª–µ–Ω–∏–µ —É–¥–∞—Ä–∞. 5 —É–¥–∞—Ä–æ–≤.</div>
        </div>
        <div class="card">
          <div class="row" style="margin:0 0 12px;">
            <div class="pill" style="flex:1; justify-content:space-between;"><span>ü•Ö –ì–æ–ª—ã</span><strong id="penScore">0</strong></div>
            <div class="pill" style="flex:1; justify-content:space-between;"><span>üéØ –£–¥–∞—Ä</span><strong id="penShot">1/5</strong></div>
          </div>
          <div style="width:100%;max-width:420px;margin:0 auto 14px;padding:14px;border-radius:16px;border:1px solid var(--line);background:linear-gradient(180deg,rgba(140,255,193,.08),rgba(255,255,255,0));">
            <div style="text-align:center;font-weight:900;margin-bottom:10px;">–í–´–ë–û–† –£–î–ê–†–ê</div>
            <div style="display:grid;grid-template-columns:1fr 1fr 1fr;gap:10px;">
              <button class="btn ghost" onclick="penShoot('L')">‚¨ÖÔ∏è –õ–µ–≤–æ</button>
              <button class="btn ghost" onclick="penShoot('C')">‚¨ÜÔ∏è –¶–µ–Ω—Ç—Ä</button>
              <button class="btn ghost" onclick="penShoot('R')">‚û°Ô∏è –ü—Ä–∞–≤–æ</button>
            </div>
            <div id="penMsg" style="margin-top:12px;text-align:center;font-size:18px;font-weight:900;"></div>
            <div id="penSub" class="muted" style="margin-top:6px;text-align:center;"></div>
          </div>
          <button id="penRestartBtn" class="btn primary" onclick="penRestart()">–ù–∞—á–∞—Ç—å —Å–µ—Ä–∏—é</button>
          <button style="margin-top:12px;" class="btn ghost" onclick="go('games')">‚Üê –ù–∞–∑–∞–¥</button>
          <div class="note">+2 coins –∑–∞ –≥–æ–ª. –ü–æ–±–µ–¥–∞ (3+) +10 coins –∏ +1 win.</div>
        </div>
      </section>

      <!-- PONG -->
      <section id="page-pong" class="hidden">
        <div class="card" style="margin-bottom:12px;">
          <h2>üèì Ping Pong</h2>
          <div class="muted">–î–≤–∏–≥–∞–π –ø–ª–∞—Ç—Ñ–æ—Ä–º—É. Power-shot: —Ç–∞–ø –ø–æ –ø–æ–ª—é –≤ –º–æ–º–µ–Ω—Ç —É–¥–∞—Ä–∞.</div>
        </div>
        <div class="card">
          <div class="row" style="margin:0 0 12px;">
            <div class="pill" style="flex:1; justify-content:space-between;"><span>üôÇ –¢—ã</span><strong id="pongMe">0</strong></div>
            <div class="pill" style="flex:1; justify-content:space-between;"><span>ü§ñ –ë–æ—Ç</span><strong id="pongAi">0</strong></div>
          </div>
          <div class="row" style="margin:0 0 12px;">
            <div class="pill" style="flex:1; justify-content:space-between;"><span>üî• –ö–æ–º–±–æ</span><strong id="pongCombo">0</strong></div>
            <div class="pill" style="flex:1; justify-content:space-between;"><span>‚ö° –°–∫–æ—Ä–æ—Å—Ç—å</span><strong id="pongSpeed">x1.0</strong></div>
          </div>
          <canvas id="pongCanvas" width="420" height="520" style="width:100%;max-width:420px;border:1px solid var(--line);border-radius:16px;background:#0b0d12;display:block;margin:0 auto;"></canvas>
          <div class="row" style="margin-top:12px;">
            <button id="pongStartBtn" class="btn primary" onclick="pongStart()">–°—Ç–∞—Ä—Ç</button>
            <button class="btn ghost" onclick="pongReset()">–°–±—Ä–æ—Å</button>
          </div>
          <button style="margin-top:12px;" class="btn ghost" onclick="pongStop(); go('games')">‚Üê –ù–∞–∑–∞–¥</button>
          <div class="note">–ü–æ–±–µ–¥–∞ (5:?) +15 coins –∏ +1 win. –ö–æ–º–±–æ 3/5/8 ‚Üí +1/+2/+4 coins.</div>
        </div>
      </section>
    </main>
  </div>

  <nav class="nav">
    <button id="tab-games" onclick="go('games')"><div class="icon">üéÆ</div><div>–ò–≥—Ä—ã</div></button>
    <button id="tab-wallet" onclick="go('wallet')"><div class="icon">üí∞</div><div>–ë–∞–ª–∞–Ω—Å</div></button>
    <button id="tab-profile" onclick="go('profile')"><div class="icon">üë§</div><div>–ö–∞–±–∏–Ω–µ—Ç</div></button>
  </nav>

  <div id="toast" class="toast"></div>

<script>
  const tg = window.Telegram?.WebApp; try{tg?.ready();tg?.expand()}catch(e){}
  const storeKey="f1duel_state_v1", defaultState={coins:0,stars:0,wins:0,plays:0};
  const state=(()=>{try{const r=localStorage.getItem(storeKey);return r?{...defaultState,...JSON.parse(r)}:{...defaultState}}catch(e){return {...defaultState}}})();
  const toastEl=document.getElementById("toast"); let toastTimer=null;
  function toast(t){try{tg?.HapticFeedback?.impactOccurred("light")}catch(e){} toastEl.textContent=t;toastEl.classList.add("show");clearTimeout(toastTimer);toastTimer=setTimeout(()=>toastEl.classList.remove("show"),1600)}
  function saveState(){localStorage.setItem(storeKey,JSON.stringify(state));renderWallet()}
  function calcLevel(){const score=state.coins+state.stars*50;return Math.max(1,Math.floor(score/200)+1)}
  function renderWallet(){document.getElementById("coinsVal").textContent=state.coins;document.getElementById("starsVal").textContent=state.stars;document.getElementById("winsVal").textContent=state.wins;document.getElementById("playsVal").textContent=state.plays;document.getElementById("levelVal").textContent=calcLevel()}
  function addCoins(n){state.coins=Math.max(0,state.coins+n);saveState()}
  function convertCoinsToStars(){const rate=100;if(state.coins<rate){toast(`–ù—É–∂–Ω–æ –º–∏–Ω–∏–º—É–º ${rate} coins`);return;}const s=Math.floor(state.coins/rate);state.coins-=s*rate;state.stars+=s;saveState();toast(`–û–±–º–µ–Ω: +${s} ‚≠ê`)}
  function resetProgress(){Object.assign(state,{...defaultState});saveState();toast("–ü—Ä–æ–≥—Ä–µ—Å—Å —Å–±—Ä–æ—à–µ–Ω")}

  const pages=["games","wallet","profile","reaction","penalty","pong"];
  function go(page){
    pages.forEach(p=>document.getElementById("page-"+p).classList.toggle("hidden",p!==page));
    ["games","wallet","profile"].forEach(t=>document.getElementById("tab-"+t).classList.toggle("active",t===page));
    if(page==="reaction"||page==="penalty"||page==="pong"){document.getElementById("tab-games").classList.add("active");["wallet","profile"].forEach(t=>document.getElementById("tab-"+t).classList.remove("active"))}
    location.hash="#"+page;
  }
  function openGame(id){ if(id==="reaction")go("reaction"); if(id==="penalty")go("penalty"); if(id==="pong")go("pong"); }

  const envChip=document.getElementById("envChip"), userChip=document.getElementById("userChip");
  envChip.textContent=tg?"Telegram WebApp":"Browser";
  const user=tg?.initDataUnsafe?.user;
  if(user){
    const nick=user.username||user.first_name||"Player";
    userChip.textContent="@"+nick;
    document.getElementById("nickVal").textContent=nick;
    document.getElementById("tgidVal").textContent=user.id;
    document.getElementById("profileLine").textContent=`–ü—Ä–∏–≤–µ—Ç, ${nick}.`;
  } else {
    document.getElementById("profileLine").textContent="–û—Ç–∫—Ä–æ–π —á–µ—Ä–µ–∑ Telegram, —á—Ç–æ–±—ã –ø–æ–¥—Ç—è–Ω—É–ª—Å—è –ø—Ä–æ—Ñ–∏–ª—å.";
  }

  // REACTION
  const light=document.getElementById("light"), startBtn=document.getElementById("startBtn"), result=document.getElementById("result");
  let startTime=0, waiting=false, timer=null;
  function setLight(c){light.style.background=c;light.style.boxShadow=(c==="lime")?"0 0 30px lime":"0 0 20px red";}
  startBtn.onclick=()=>{ if(waiting)return; result.textContent=""; setLight("red"); waiting=true; startBtn.textContent="–ñ–î–ò‚Ä¶";
    timer=setTimeout(()=>{setLight("lime");startTime=Date.now();try{tg?.HapticFeedback?.impactOccurred("medium")}catch(e){}}, 2000+Math.random()*3000);
  };
  light.onclick=()=>{ if(!waiting)return;
    if(!startTime){clearTimeout(timer); result.textContent="‚ùå –§–∞–ª—å—Å—Ç–∞—Ä—Ç! ‚àí2 coins"; addCoins(-2); toast("–§–∞–ª—å—Å—Ç–∞—Ä—Ç ‚àí2"); waiting=false; startTime=0; startBtn.textContent="–ï—â—ë —Ä–∞–∑"; return;}
    const r=Date.now()-startTime; state.plays+=1; let reward=5; if(r<250)reward+=3; addCoins(reward); saveState();
    result.textContent=`‚ö° ${r} –º—Å  ‚Ä¢  +${reward} coins`; toast(`+${reward} coins`); try{tg?.HapticFeedback?.notificationOccurred("success")}catch(e){}
    waiting=false; startTime=0; startBtn.textContent="–ï—â—ë —Ä–∞–∑";
  };

  // PENALTY
  const penScoreEl=document.getElementById("penScore"), penShotEl=document.getElementById("penShot"), penMsgEl=document.getElementById("penMsg"), penSubEl=document.getElementById("penSub"), penRestartBtn=document.getElementById("penRestartBtn");
  let penShot=1, penGoals=0, penActive=false;
  function penRender(){penScoreEl.textContent=penGoals;penShotEl.textContent=`${Math.min(penShot,5)}/5`;}
  function penRestart(){penShot=1;penGoals=0;penActive=true;penRestartBtn.textContent="–°–µ—Ä–∏—è –∏–¥—ë—Ç‚Ä¶";penMsgEl.textContent="–í—ã–±–∏—Ä–∞–π –Ω–∞–ø—Ä–∞–≤–ª–µ–Ω–∏–µ";penSubEl.textContent="";penRender();toast("–°—Ç–∞—Ä—Ç —Å–µ—Ä–∏–∏")}
  function penShoot(dir){
    if(!penActive){toast("–ù–∞–∂–º–∏ ¬´–ù–∞—á–∞—Ç—å —Å–µ—Ä–∏—é¬ª");return;} if(penShot>5){toast("–°–µ—Ä–∏—è –∑–∞–∫–æ–Ω—á–∏–ª–∞—Å—å");return;}
    const keeper=["L","C","R"][Math.floor(Math.random()*3)], isGoal=dir!==keeper, map={L:"–ª–µ–≤–æ",C:"—Ü–µ–Ω—Ç—Ä",R:"–ø—Ä–∞–≤–æ"};
    if(isGoal){penGoals+=1;addCoins(2);penMsgEl.textContent="‚öΩÔ∏è –ì–û–û–û–õ! +2 coins";toast("+2 coins");try{tg?.HapticFeedback?.notificationOccurred("success")}catch(e){}}
    else{penMsgEl.textContent="üß§ –°–µ–π–≤!";toast("–°–µ–π–≤");try{tg?.HapticFeedback?.notificationOccurred("error")}catch(e){}}
    penSubEl.textContent=`–¢—ã: ${map[dir]} ‚Ä¢ –í—Ä–∞—Ç–∞—Ä—å: ${map[keeper]}`;
    penShot+=1;penRender();
    if(penShot===6){penActive=false;state.plays+=1;
      if(penGoals>=3){state.wins+=1;addCoins(10);saveState();penMsgEl.textContent=`üèÜ –ü–æ–±–µ–¥–∞! ${penGoals}/5 ‚Ä¢ +10 coins`;toast("–ü–æ–±–µ–¥–∞ +10")}
      else{saveState();penMsgEl.textContent=`–°–µ—Ä–∏—è –æ–∫–æ–Ω—á–µ–Ω–∞: ${penGoals}/5`;toast("–°–µ—Ä–∏—è –∑–∞–≤–µ—Ä—à–µ–Ω–∞")}
      penRestartBtn.textContent="–°—ã–≥—Ä–∞—Ç—å –µ—â—ë —Ä–∞–∑";
    }
  }

  // PONG (tasty)
  const canvas=document.getElementById("pongCanvas"), ctx=canvas.getContext("2d");
  const pongMeEl=document.getElementById("pongMe"), pongAiEl=document.getElementById("pongAi"), pongComboEl=document.getElementById("pongCombo"), pongSpeedEl=document.getElementById("pongSpeed"), pongStartBtn=document.getElementById("pongStartBtn");
  let pongRunning=false, rafId=null;
  const W=canvas.width, H=canvas.height;
  const paddle={w:96,h:12,x:W/2-48,y:H-28}, aiPaddle={w:96,h:12,x:W/2-48,y:16};
  const ball={r:7,x:W/2,y:H/2,vx:3.2,vy:3.6};
  let meScore=0, aiScore=0, speedMult=1.0, rally=0, powerUntil=0, lastHitByPlayer=false;

  function clamp(v,min,max){return Math.max(min,Math.min(max,v))}
  function collideRectCircle(px,py,pw,ph,cx,cy,cr){
    const closestX=clamp(cx,px,px+pw), closestY=clamp(cy,py,py+ph);
    const dx=cx-closestX, dy=cy-closestY; return (dx*dx+dy*dy)<=cr*cr;
  }
  function pongHud(){pongMeEl.textContent=meScore;pongAiEl.textContent=aiScore;pongComboEl.textContent=rally;pongSpeedEl.textContent="x"+speedMult.toFixed(1)}
  function pongResetBall(towardsPlayer){
    ball.x=W/2; ball.y=H/2; speedMult=1.0; rally=0; lastHitByPlayer=false;
    const base=3.0+Math.random()*1.0;
    ball.vx=(Math.random()>.5?1:-1)*base;
    ball.vy=(towardsPlayer?1:-1)*(3.2+Math.random()*1.2);
    pongHud();
  }
  function pongReset(){
    pongStop();
    meScore=0; aiScore=0;
    paddle.x=W/2-paddle.w/2; aiPaddle.x=W/2-aiPaddle.w/2;
    pongResetBall(true);
    pongStartBtn.textContent="–°—Ç–∞—Ä—Ç";
    pongHud(); drawPong();
  }
  function pongStart(){ if(pongRunning)return; pongRunning=true; pongStartBtn.textContent="–ò–¥—ë—Ç‚Ä¶"; toast("–ü–æ–µ—Ö–∞–ª–∏!"); loop(); }
  function pongStop(){ pongRunning=false; if(rafId)cancelAnimationFrame(rafId); rafId=null; }

  function comboBonus(){
    let b=0; if(rally===3)b=1; if(rally===5)b=2; if(rally===8)b=4;
    if(b){addCoins(b); toast(`–ö–æ–º–±–æ ${rally}! +${b} coins`); try{tg?.HapticFeedback?.notificationOccurred("success")}catch(e){}}
  }
  function aiSpeed(){
    const base=2.8, scoreBoost=(aiScore+meScore)*0.12, speedBoost=(speedMult-1.0)*0.9;
    return clamp(base+scoreBoost+speedBoost,2.8,5.6);
  }
  function drawPong(){
    ctx.clearRect(0,0,W,H);
    ctx.fillStyle="#0b0d12"; ctx.fillRect(0,0,W,H);
    ctx.globalAlpha=.35; ctx.fillStyle="#fff";
    for(let y=0;y<H;y+=18) ctx.fillRect(W/2-2,y,4,10);
    ctx.globalAlpha=1;
    ctx.fillStyle="#8cffc1"; ctx.fillRect(paddle.x,paddle.y,paddle.w,paddle.h);
    ctx.fillStyle="#9aa3b2"; ctx.fillRect(aiPaddle.x,aiPaddle.y,aiPaddle.w,aiPaddle.h);
    const now=performance.now(), powerActive=now<powerUntil;
    if(powerActive){ctx.globalAlpha=.18;ctx.fillStyle="#8cffc1";ctx.fillRect(0,H-90,W,90);ctx.globalAlpha=1;}
    ctx.beginPath(); ctx.arc(ball.x,ball.y,ball.r,0,Math.PI*2);
    ctx.fillStyle=powerActive?"#8cffc1":"#fff"; ctx.fill();
    ctx.globalAlpha=.9; ctx.font="800 16px system-ui"; ctx.fillStyle="#fff";
    ctx.fillText(`x${speedMult.toFixed(1)}  üî•${rally}`, W-92, 26);
    ctx.globalAlpha=1;
  }
  function endPong(){
    pongStop(); state.plays+=1;
    if(meScore>=5){state.wins+=1; addCoins(15); saveState(); toast("üèÜ –ü–æ–±–µ–¥–∞! +15 coins")}
    else{saveState(); toast("–ü–æ—Ä–∞–∂–µ–Ω–∏–µ üòÑ")}
    pongStartBtn.textContent="–°—ã–≥—Ä–∞—Ç—å –µ—â—ë";
  }
  function loop(){
    if(!pongRunning) return;

    const target=ball.x-aiPaddle.w/2, s=aiSpeed();
    aiPaddle.x += clamp(target-aiPaddle.x, -s, s);
    aiPaddle.x = clamp(aiPaddle.x, 0, W-aiPaddle.w);

    ball.x += ball.vx*speedMult;
    ball.y += ball.vy*speedMult;

    if(ball.x-ball.r<=0 || ball.x+ball.r>=W){
      ball.vx*=-1; ball.x=clamp(ball.x, ball.r, W-ball.r);
    }

    if(ball.vy>0 && collideRectCircle(paddle.x,paddle.y,paddle.w,paddle.h,ball.x,ball.y,ball.r)){
      ball.vy*=-1;
      const hit=(ball.x-(paddle.x+paddle.w/2))/(paddle.w/2);
      ball.vx += hit*1.25;
      speedMult = clamp(speedMult + 0.06, 1.0, 2.1);
      rally += 1; lastHitByPlayer=true; comboBonus();

      const now=performance.now();
      if(now<powerUntil){
        ball.vx += hit*1.8;
        speedMult = clamp(speedMult + 0.18, 1.0, 2.4);
        try{tg?.HapticFeedback?.impactOccurred("medium")}catch(e){}
        toast("‚ö° Power-shot!");
        powerUntil=0;
      } else {
        try{tg?.HapticFeedback?.impactOccurred("light")}catch(e){}
      }
      ball.vx = clamp(ball.vx, -6.2, 6.2);
      pongHud();
    }

    if(ball.vy<0 && collideRectCircle(aiPaddle.x,aiPaddle.y,aiPaddle.w,aiPaddle.h,ball.x,ball.y,ball.r)){
      ball.vy*=-1;
      const hit=(ball.x-(aiPaddle.x+aiPaddle.w/2))/(aiPaddle.w/2);
      ball.vx += hit*0.8;
      speedMult = clamp(speedMult + 0.03, 1.0, 2.2);
      if(lastHitByPlayer) lastHitByPlayer=false;
      ball.vx = clamp(ball.vx, -6.2, 6.2);
      pongHud();
    }

    if(ball.y-ball.r<=0){
      meScore += 1; toast("–û—á–∫–æ —Ç–µ–±–µ!"); pongResetBall(false);
    }
    if(ball.y+ball.r>=H){
      aiScore += 1; toast("–û—á–∫–æ –±–æ—Ç—É"); pongResetBall(true);
    }
    pongHud();

    if(meScore>=5 || aiScore>=5){ endPong(); drawPong(); return; }

    drawPong();
    rafId = requestAnimationFrame(loop);
  }

  function setPaddleFromClientX(clientX){
    const rect=canvas.getBoundingClientRect();
    const x=(clientX-rect.left)*(W/rect.width);
    paddle.x=clamp(x-paddle.w/2,0,W-paddle.w);
  }
  canvas.addEventListener("mousemove",(e)=>setPaddleFromClientX(e.clientX));
  canvas.addEventListener("touchmove",(e)=>{e.preventDefault();setPaddleFromClientX(e.touches[0].clientX)},{passive:false});
  function triggerPower(){ if(!pongRunning) return; powerUntil=performance.now()+220; try{tg?.HapticFeedback?.impactOccurred("light")}catch(e){} }
  canvas.addEventListener("mousedown",triggerPower);
  canvas.addEventListener("touchstart",(e)=>{e.preventDefault();triggerPower()},{passive:false});

  // Boot
  renderWallet(); penRender(); pongReset();
  const initial=(location.hash||"#games").slice(1); go(pages.includes(initial)?initial:"games");
</script>
</body>
</html>

