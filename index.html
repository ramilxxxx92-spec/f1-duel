<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>F1 Duel</title>
  <script src="https://telegram.org/js/telegram-web-app.js"></script>
  <style>
    :root{
      --bg:#0f1115;
      --card:#171a22;
      --muted:#9aa3b2;
      --text:#ffffff;
      --accent:#8cffc1;
      --danger:#ff5c5c;
      --line:#252a36;
      --shadow: 0 12px 30px rgba(0,0,0,.35);
      --radius:16px;
    }
    *{box-sizing:border-box}
    body{
      margin:0;
      font-family: system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif;
      background: var(--bg);
      color: var(--text);
    }
    .app{ min-height:100vh; padding-bottom:86px; }
    .topbar{
      position: sticky;
      top:0;
      z-index: 10;
      background: rgba(15,17,21,.92);
      backdrop-filter: blur(10px);
      border-bottom: 1px solid var(--line);
      padding: 14px 16px;
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:12px;
    }
    .brand{
      display:flex; align-items:center; gap:10px;
      font-weight: 800;
      letter-spacing: .2px;
    }
    .chip{
      font-size:12px;
      padding:6px 10px;
      border:1px solid var(--line);
      border-radius: 999px;
      color: var(--muted);
      white-space: nowrap;
    }
    .container{ padding: 16px; }
    .row{ display:flex; gap:12px; flex-wrap:wrap; }
    .card{
      background: var(--card);
      border:1px solid var(--line);
      border-radius: var(--radius);
      box-shadow: var(--shadow);
      padding: 14px;
    }
    .card h2{ margin:0 0 8px 0; font-size:16px; }
    .muted{ color: var(--muted); }
    .btn{
      appearance:none;
      border:none;
      cursor:pointer;
      border-radius: 12px;
      padding: 12px 14px;
      font-size: 15px;
      font-weight: 700;
      width: 100%;
    }
    .btn.primary{ background: var(--accent); color:#07110c; }
    .btn.ghost{ background: transparent; border:1px solid var(--line); color: var(--text); }
    .btn.danger{ background: var(--danger); color:#1a0b0b; }
    .grid{
      display:grid;
      grid-template-columns: 1fr 1fr;
      gap:12px;
    }
    .game-tile{
      background: linear-gradient(180deg, rgba(140,255,193,.10), rgba(255,255,255,0));
      border:1px solid var(--line);
      border-radius: var(--radius);
      padding: 14px;
      min-height: 120px;
      display:flex;
      flex-direction:column;
      justify-content:space-between;
      cursor:pointer;
      user-select:none;
    }
    .game-tile .title{ font-weight: 850; }
    .game-tile .tag{ font-size:12px; color: var(--muted); margin-top:6px; }
    .pill{
      display:inline-flex;
      align-items:center;
      gap:8px;
      padding:10px 12px;
      border:1px solid var(--line);
      border-radius: 14px;
      background: rgba(255,255,255,.02);
    }
    .kv{
      display:flex;
      justify-content:space-between;
      gap:12px;
      padding:10px 0;
      border-top:1px solid var(--line);
    }
    .kv:first-child{ border-top:none; padding-top:0; }
    .nav{
      position: fixed;
      left:0; right:0; bottom:0;
      height: 72px;
      background: rgba(15,17,21,.92);
      backdrop-filter: blur(10px);
      border-top: 1px solid var(--line);
      display:flex;
      padding: 10px 10px 14px;
      gap:10px;
      z-index: 20;
    }
    .nav button{
      flex:1;
      border:none;
      background: transparent;
      color: var(--muted);
      border-radius: 14px;
      padding: 10px 8px;
      font-size: 12px;
      cursor:pointer;
      display:flex;
      flex-direction:column;
      align-items:center;
      justify-content:center;
      gap:6px;
    }
    .nav button.active{
      color: var(--text);
      background: rgba(140,255,193,.12);
      border:1px solid rgba(140,255,193,.25);
    }
    .icon{ font-size:18px; line-height:1; }
    .hidden{ display:none !important; }
    .note{
      font-size: 12px;
      color: var(--muted);
      margin-top: 10px;
      line-height: 1.35;
    }

    /* Simple ‚Äútoast‚Äù */
    .toast{
      position: fixed;
      left: 50%;
      bottom: 86px;
      transform: translateX(-50%);
      background: rgba(0,0,0,.75);
      color: #fff;
      padding: 10px 12px;
      border-radius: 12px;
      border: 1px solid rgba(255,255,255,.12);
      box-shadow: var(--shadow);
      font-size: 13px;
      z-index: 999;
      max-width: 90vw;
      text-align:center;
      opacity: 0;
      pointer-events:none;
      transition: opacity .18s ease;
    }
    .toast.show{ opacity: 1; }
  </style>
</head>

<body>
  <div class="app">
    <div class="topbar">
      <div class="brand">
        <span>üèÅ F1 Duel</span>
        <span id="envChip" class="chip">WebApp</span>
      </div>
      <div class="chip" id="userChip">–ì–æ—Å—Ç—å</div>
    </div>

    <main class="container">

      <!-- GAMES -->
      <section id="page-games">
        <div class="card" style="margin-bottom:12px;">
          <h2>–í—ã–±–æ—Ä –∏–≥—Ä—ã</h2>
          <div class="muted">–í—ã–±–∏—Ä–∞–π —Ä–µ–∂–∏–º. –°–µ–π—á–∞—Å –¥–æ—Å—Ç—É–ø–Ω—ã –¥–≤–µ –∏–≥—Ä—ã (–±–µ–∑ —Å–µ—Ä–≤–µ—Ä–∞, –ª–æ–∫–∞–ª—å–Ω–æ).</div>
        </div>

        <div class="grid">
          <div class="game-tile" onclick="openGame('reaction')">
            <div>
              <div class="title">‚ö° Reaction Duel</div>
              <div class="tag">–°–∫–æ—Ä–æ—Å—Ç—å —Ä–µ–∞–∫—Ü–∏–∏ ‚Ä¢ 1 –∏–≥—Ä–æ–∫</div>
            </div>
            <div class="muted" style="font-size:12px;">–ù–∞–∂–º–∏, —á—Ç–æ–±—ã –æ—Ç–∫—Ä—ã—Ç—å</div>
          </div>

          <div class="game-tile" onclick="openGame('penalty')">
            <div>
              <div class="title">‚öΩÔ∏è Penalty Duel</div>
              <div class="tag">–ü–µ–Ω–∞–ª—å—Ç–∏ ‚Ä¢ —Å–µ—Ä–∏—è 5 —É–¥–∞—Ä–æ–≤</div>
            </div>
            <div class="muted" style="font-size:12px;">–ù–∞–∂–º–∏, —á—Ç–æ–±—ã –æ—Ç–∫—Ä—ã—Ç—å</div>
          </div>

          <div class="game-tile" onclick="toast('–°–∫–æ—Ä–æ –¥–æ–±–∞–≤–∏–º üôÇ')">
            <div>
              <div class="title">üß† Quiz Sprint</div>
              <div class="tag">–í–æ–ø—Ä–æ—Å—ã ‚Ä¢ PvP –ø–æ–∑–∂–µ</div>
            </div>
            <div class="muted" style="font-size:12px;">–°–∫–æ—Ä–æ</div>
          </div>

          <div class="game-tile" onclick="toast('–°–∫–æ—Ä–æ –¥–æ–±–∞–≤–∏–º üôÇ')">
            <div>
              <div class="title">üéØ Tap Rush</div>
              <div class="tag">–¢–∞–ø-–≥–æ–Ω–∫–∞ ‚Ä¢ —Ä–µ–π—Ç–∏–Ω–≥–∏</div>
            </div>
            <div class="muted" style="font-size:12px;">–°–∫–æ—Ä–æ</div>
          </div>
        </div>

        <div class="note">–î–∞–ª—å—à–µ –º–æ–∂–Ω–æ: (1) —Å–¥–µ–ª–∞—Ç—å UI –∫—Ä–∞—Å–∏–≤–µ–µ, (2) –¥–æ–±–∞–≤–∏—Ç—å —Å—Ç–∞–≤–∫–∏ coins, (3) —Å–¥–µ–ª–∞—Ç—å PvP (–Ω—É–∂–µ–Ω —Å–µ—Ä–≤–µ—Ä).</div>
      </section>

      <!-- WALLET -->
      <section id="page-wallet" class="hidden">
        <div class="card">
          <h2>–ë–∞–ª–∞–Ω—Å</h2>

          <div class="row" style="margin: 10px 0 14px;">
            <div class="pill" style="flex:1; justify-content:space-between;">
              <span>ü™ô Coins</span>
              <strong id="coinsVal">0</strong>
            </div>
            <div class="pill" style="flex:1; justify-content:space-between;">
              <span>‚≠ê Stars</span>
              <strong id="starsVal">0</strong>
            </div>
          </div>

          <div class="kv"><span class="muted">–£—Ä–æ–≤–µ–Ω—å</span><strong id="levelVal">1</strong></div>
          <div class="kv"><span class="muted">–ü–æ–±–µ–¥—ã</span><strong id="winsVal">0</strong></div>
          <div class="kv"><span class="muted">–ò–≥—Ä—ã</span><strong id="playsVal">0</strong></div>

          <div style="margin-top:14px;" class="row">
            <button class="btn primary" onclick="addCoins(10)">+10 coins (—Ç–µ—Å—Ç)</button>
            <button class="btn ghost" onclick="convertCoinsToStars()">–û–±–º–µ–Ω—è—Ç—å coins ‚Üí stars</button>
          </div>

          <button style="margin-top:10px;" class="btn danger" onclick="resetProgress()">–°–±—Ä–æ—Å–∏—Ç—å –ø—Ä–æ–≥—Ä–µ—Å—Å</button>
          <div class="note">–ü–æ–∫–∞ –≤—Å—ë —Ö—Ä–∞–Ω–∏—Ç—Å—è –ª–æ–∫–∞–ª—å–Ω–æ (–Ω–∞ —É—Å—Ç—Ä–æ–π—Å—Ç–≤–µ). –î–ª—è PvP –∏ –Ω–∞—Å—Ç–æ—è—â–µ–π —ç–∫–æ–Ω–æ–º–∏–∫–∏ –Ω—É–∂–µ–Ω backend.</div>
        </div>
      </section>

      <!-- PROFILE -->
      <section id="page-profile" class="hidden">
        <div class="card">
          <h2>–õ–∏—á–Ω—ã–π –∫–∞–±–∏–Ω–µ—Ç</h2>
          <div class="muted" id="profileLine">‚Äî</div>

          <div style="margin-top:14px;">
            <div class="kv"><span class="muted">–ù–∏–∫</span><strong id="nickVal">‚Äî</strong></div>
            <div class="kv"><span class="muted">Telegram ID</span><strong id="tgidVal">‚Äî</strong></div>
            <div class="kv"><span class="muted">–°—Ç–∞—Ç—É—Å</span><strong id="statusVal">–ù–æ–≤–∏—á–æ–∫</strong></div>
          </div>

          <div style="margin-top:14px;" class="row">
            <button class="btn ghost" onclick="toast('–°–∫–æ—Ä–æ: –¥–æ—Å—Ç–∏–∂–µ–Ω–∏—è, –∏—Å—Ç–æ—Ä–∏—è –º–∞—Ç—á–µ–π, —Ä–µ—Ñ–µ—Ä–∞–ª—ã')">–ù–∞—Å—Ç—Ä–æ–π–∫–∏ (—Å–∫–æ—Ä–æ)</button>
            <button class="btn primary" onclick="go('games')">–ò–≥—Ä–∞—Ç—å</button>
          </div>

          <div class="note">–ü–æ–∑–∂–µ —Å—é–¥–∞: –¥–æ—Å—Ç–∏–∂–µ–Ω–∏—è, —Ä–µ—Ñ–µ—Ä–∞–ª—ã, –∏—Å—Ç–æ—Ä–∏—è –¥—É—ç–ª–µ–π, –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–µ –∫–æ—à–µ–ª—å–∫–∞ (crypto).</div>
        </div>
      </section>

      <!-- GAME: REACTION -->
      <section id="page-reaction" class="hidden">
        <div class="card" style="margin-bottom:12px;">
          <h2>‚ö° Reaction Duel</h2>
          <div class="muted">–ñ–º–∏ ¬´–ñ–¥–∞—Ç—å —Å—Ç–∞—Ä—Ç¬ª, –∑–∞—Ç–µ–º —Ç–∞–ø–Ω–∏ –ø–æ —Å–∏–≥–Ω–∞–ª—É. –§–∞–ª—å—Å—Ç–∞—Ä—Ç ‚Äî —à—Ç—Ä–∞—Ñ.</div>
        </div>

        <div class="card">
          <div id="light" style="
            width:120px;height:120px;border-radius:50%;
            margin: 8px auto 18px;
            background:red; box-shadow: 0 0 20px red;"></div>

          <button id="startBtn" class="btn primary">–ñ–¥–∞—Ç—å —Å—Ç–∞—Ä—Ç</button>
          <div id="result" style="margin-top:14px; font-size:20px; font-weight:850;"></div>

          <div class="note">–ù–∞–≥—Ä–∞–¥–∞: +5 coins –∑–∞ –≤–∞–ª–∏–¥–Ω—É—é –ø–æ–ø—ã—Ç–∫—É. –ë—ã—Å—Ç—Ä–æ (&lt;250ms): +3 –±–æ–Ω—É—Å. –§–∞–ª—å—Å—Ç–∞—Ä—Ç: ‚àí2 coins.</div>
          <button style="margin-top:12px;" class="btn ghost" onclick="go('games')">‚Üê –ù–∞–∑–∞–¥ –∫ –∏–≥—Ä–∞–º</button>
        </div>
      </section>

      <!-- GAME: PENALTY -->
      <section id="page-penalty" class="hidden">
        <div class="card" style="margin-bottom:12px;">
          <h2>‚öΩÔ∏è Penalty Duel</h2>
          <div class="muted">–í—ã–±–µ—Ä–∏ –Ω–∞–ø—Ä–∞–≤–ª–µ–Ω–∏–µ —É–¥–∞—Ä–∞. –í—Ä–∞—Ç–∞—Ä—å –≤—ã–±–∏—Ä–∞–µ—Ç —Ç–æ–∂–µ. 5 —É–¥–∞—Ä–æ–≤ ‚Äî –∏ –∏—Ç–æ–≥.</div>
        </div>

        <div class="card">
          <div class="row" style="margin: 0 0 12px;">
            <div class="pill" style="flex:1; justify-content:space-between;">
              <span>ü•Ö –ì–æ–ª—ã</span><strong id="penScore">0</strong>
            </div>
            <div class="pill" style="flex:1; justify-content:space-between;">
              <span>üéØ –£–¥–∞—Ä</span><strong id="penShot">1/5</strong>
            </div>
          </div>

          <div style="
            width:100%;
            max-width: 420px;
            margin: 0 auto 14px;
            padding: 14px;
            border-radius: 16px;
            border: 1px solid var(--line);
            background: linear-gradient(180deg, rgba(140,255,193,.08), rgba(255,255,255,0));
          ">
            <div style="text-align:center; font-weight:900; margin-bottom:10px;">–í–´–ë–û–† –£–î–ê–†–ê</div>

            <div style="display:grid; grid-template-columns: 1fr 1fr 1fr; gap:10px;">
              <button class="btn ghost" onclick="penShoot('L')">‚¨ÖÔ∏è –õ–µ–≤–æ</button>
              <button class="btn ghost" onclick="penShoot('C')">‚¨ÜÔ∏è –¶–µ–Ω—Ç—Ä</button>
              <button class="btn ghost" onclick="penShoot('R')">‚û°Ô∏è –ü—Ä–∞–≤–æ</button>
            </div>

            <div id="penMsg" style="margin-top:12px; text-align:center; font-size:18px; font-weight:900;"></div>
            <div id="penSub" class="muted" style="margin-top:6px; text-align:center;"></div>
          </div>

          <button id="penRestartBtn" class="btn primary" onclick="penRestart()">–ù–∞—á–∞—Ç—å —Å–µ—Ä–∏—é</button>
          <button style="margin-top:12px;" class="btn ghost" onclick="go('games')">‚Üê –ù–∞–∑–∞–¥ –∫ –∏–≥—Ä–∞–º</button>

          <div class="note">–ù–∞–≥—Ä–∞–¥–∞: +2 coins –∑–∞ –≥–æ–ª. –ü–æ–±–µ–¥–∞ (3+ –∏–∑ 5): +10 coins –∏ +1 win.</div>
        </div>
      </section>

    </main>
  </div>

  <nav class="nav">
    <button id="tab-games" onclick="go('games')">
      <div class="icon">üéÆ</div>
      <div>–ò–≥—Ä—ã</div>
    </button>
    <button id="tab-wallet" onclick="go('wallet')">
      <div class="icon">üí∞</div>
      <div>–ë–∞–ª–∞–Ω—Å</div>
    </button>
    <button id="tab-profile" onclick="go('profile')">
      <div class="icon">üë§</div>
      <div>–ö–∞–±–∏–Ω–µ—Ç</div>
    </button>
  </nav>

  <div id="toast" class="toast"></div>

<script>
  // --- Telegram init ---
  const tg = window.Telegram?.WebApp;
  try { tg?.ready(); } catch(e){}
  try { tg?.expand(); } catch(e){}

  // --- Local state ---
  const storeKey = "f1duel_state_v1";
  const defaultState = { coins: 0, stars: 0, wins: 0, plays: 0 };
  const state = loadState();

  function loadState(){
    try{
      const raw = localStorage.getItem(storeKey);
      return raw ? { ...defaultState, ...JSON.parse(raw) } : { ...defaultState };
    } catch(e){
      return { ...defaultState };
    }
  }

  function saveState(){
    localStorage.setItem(storeKey, JSON.stringify(state));
    renderWallet();
  }

  // --- UI toast ---
  const toastEl = document.getElementById("toast");
  let toastTimer = null;
  function toast(text){
    try{ tg?.HapticFeedback?.impactOccurred("light"); }catch(e){}
    toastEl.textContent = text;
    toastEl.classList.add("show");
    clearTimeout(toastTimer);
    toastTimer = setTimeout(() => toastEl.classList.remove("show"), 1600);
  }

  // --- Routing ---
  const pages = ["games","wallet","profile","reaction","penalty"];

  function go(page){
    pages.forEach(p => {
      document.getElementById("page-" + p).classList.toggle("hidden", p !== page);
    });

    // Tabs active
    ["games","wallet","profile"].forEach(t => {
      const el = document.getElementById("tab-" + t);
      el.classList.toggle("active", t === page);
    });

    // If inside a game page, keep games tab active
    if(page === "reaction" || page === "penalty"){
      document.getElementById("tab-games").classList.add("active");
      ["wallet","profile"].forEach(t => document.getElementById("tab-"+t).classList.remove("active"));
    }

    location.hash = "#" + page;
  }

  function openGame(id){
    if(id === "reaction") go("reaction");
    if(id === "penalty") go("penalty");
  }

  // --- Header / User ---
  const user = tg?.initDataUnsafe?.user;
  const userChip = document.getElementById("userChip");
  const envChip = document.getElementById("envChip");

  envChip.textContent = tg ? "Telegram WebApp" : "Browser";

  if(user){
    const nick = user.username || user.first_name || "Player";
    userChip.textContent = "@" + nick;
    document.getElementById("nickVal").textContent = nick;
    document.getElementById("tgidVal").textContent = user.id;
    document.getElementById("profileLine").textContent = `–ü—Ä–∏–≤–µ—Ç, ${nick}. –¢—É—Ç –±—É–¥—É—Ç –¥–æ—Å—Ç–∏–∂–µ–Ω–∏—è –∏ –∏—Å—Ç–æ—Ä–∏—è –∏–≥—Ä.`;
  } else {
    document.getElementById("profileLine").textContent = "–û—Ç–∫—Ä–æ–π —á–µ—Ä–µ–∑ Telegram, —á—Ç–æ–±—ã –ø–æ–¥—Ç—è–Ω—É–ª—Å—è –ø—Ä–æ—Ñ–∏–ª—å.";
  }

  // --- Wallet ---
  function calcLevel(){
    const score = state.coins + state.stars * 50;
    return Math.max(1, Math.floor(score / 200) + 1);
  }

  function renderWallet(){
    document.getElementById("coinsVal").textContent = state.coins;
    document.getElementById("starsVal").textContent = state.stars;
    document.getElementById("winsVal").textContent = state.wins;
    document.getElementById("playsVal").textContent = state.plays;
    document.getElementById("levelVal").textContent = calcLevel();
  }

  function addCoins(n){
    state.coins = Math.max(0, state.coins + n);
    saveState();
  }

  function convertCoinsToStars(){
    const rate = 100; // 100 coins = 1 star
    if(state.coins < rate){
      toast(`–ù—É–∂–Ω–æ –º–∏–Ω–∏–º—É–º ${rate} coins`);
      return;
    }
    const starsToAdd = Math.floor(state.coins / rate);
    state.coins -= starsToAdd * rate;
    state.stars += starsToAdd;
    saveState();
    toast(`–û–±–º–µ–Ω: +${starsToAdd} ‚≠ê`);
  }

  function resetProgress(){
    Object.assign(state, { ...defaultState });
    saveState();
    toast("–ü—Ä–æ–≥—Ä–µ—Å—Å —Å–±—Ä–æ—à–µ–Ω");
  }

  // --- Game: Reaction ---
  const light = document.getElementById("light");
  const startBtn = document.getElementById("startBtn");
  const result = document.getElementById("result");

  let startTime = 0;
  let waiting = false;
  let timer = null;

  function setLight(color){
    light.style.background = color;
    light.style.boxShadow = (color === "lime")
      ? "0 0 30px lime"
      : "0 0 20px red";
  }

  startBtn.onclick = () => {
    if (waiting) return;

    result.textContent = "";
    setLight("red");
    waiting = true;
    startBtn.textContent = "–ñ–î–ò‚Ä¶";

    const delay = 2000 + Math.random() * 3000;
    timer = setTimeout(() => {
      setLight("lime");
      startTime = Date.now();
      try{ tg?.HapticFeedback?.impactOccurred("medium"); }catch(e){}
    }, delay);
  };

  light.onclick = () => {
    if (!waiting) return;

    // false start
    if (!startTime){
      clearTimeout(timer);
      result.textContent = "‚ùå –§–∞–ª—å—Å—Ç–∞—Ä—Ç! ‚àí2 coins";
      addCoins(-2);
      toast("–§–∞–ª—å—Å—Ç–∞—Ä—Ç ‚àí2");
      resetReactionRound();
      return;
    }

    const reaction = Date.now() - startTime;
    state.plays += 1;

    let reward = 5;
    if(reaction < 250) reward += 3;

    addCoins(reward);
    saveState();

    result.textContent = `‚ö° ${reaction} –º—Å  ‚Ä¢  +${reward} coins`;
    toast(`+${reward} coins`);
    try{ tg?.HapticFeedback?.notificationOccurred("success"); }catch(e){}
    resetReactionRound();
  };

  function resetReactionRound(){
    waiting = false;
    startTime = 0;
    startBtn.textContent = "–ï—â—ë —Ä–∞–∑";
  }

  // --- Game: Penalty ---
  const penScoreEl = document.getElementById("penScore");
  const penShotEl  = document.getElementById("penShot");
  const penMsgEl   = document.getElementById("penMsg");
  const penSubEl   = document.getElementById("penSub");
  const penRestartBtn = document.getElementById("penRestartBtn");

  let penShot = 1;
  let penGoals = 0;
  let penActive = false;

  function penRender(){
    penScoreEl.textContent = penGoals;
    penShotEl.textContent = `${Math.min(penShot,5)}/5`;
  }

  function penRestart(){
    penShot = 1;
    penGoals = 0;
    penActive = true;
    penRestartBtn.textContent = "–°–µ—Ä–∏—è –∏–¥—ë—Ç‚Ä¶";
    penMsgEl.textContent = "–í—ã–±–∏—Ä–∞–π –Ω–∞–ø—Ä–∞–≤–ª–µ–Ω–∏–µ";
    penSubEl.textContent = "";
    penRender();
    toast("–°—Ç–∞—Ä—Ç —Å–µ—Ä–∏–∏");
  }

  function penShoot(dir){
    if(!penActive){
      toast("–ù–∞–∂–º–∏ ¬´–ù–∞—á–∞—Ç—å —Å–µ—Ä–∏—é¬ª");
      return;
    }
    if(penShot > 5){
      toast("–°–µ—Ä–∏—è –∑–∞–∫–æ–Ω—á–∏–ª–∞—Å—å");
      return;
    }

    const keeper = ["L","C","R"][Math.floor(Math.random()*3)];
    const isGoal = dir !== keeper;

    const map = {L:"–ª–µ–≤–æ", C:"—Ü–µ–Ω—Ç—Ä", R:"–ø—Ä–∞–≤–æ"};

    if(isGoal){
      penGoals += 1;
      addCoins(2);
      penMsgEl.textContent = "‚öΩÔ∏è –ì–û–û–û–õ! +2 coins";
      toast("+2 coins");
      try{ tg?.HapticFeedback?.notificationOccurred("success"); }catch(e){}
    } else {
      penMsgEl.textContent = "üß§ –°–µ–π–≤!";
      toast("–°–µ–π–≤");
      try{ tg?.HapticFeedback?.notificationOccurred("error"); }catch(e){}
    }

    penSubEl.textContent = `–¢—ã: ${map[dir]} ‚Ä¢ –í—Ä–∞—Ç–∞—Ä—å: ${map[keeper]}`;

    penShot += 1;
    penRender();

    if(penShot === 6){
      // —Ñ–∏–Ω–∞–ª
      penActive = false;
      state.plays += 1;

      if(penGoals >= 3){
        state.wins += 1;
        addCoins(10);
        saveState();
        penMsgEl.textContent = `üèÜ –ü–æ–±–µ–¥–∞! ${penGoals}/5 ‚Ä¢ +10 coins`;
        toast("–ü–æ–±–µ–¥–∞ +10");
      } else {
        saveState();
        penMsgEl.textContent = `–°–µ—Ä–∏—è –æ–∫–æ–Ω—á–µ–Ω–∞: ${penGoals}/5`;
        toast("–°–µ—Ä–∏—è –∑–∞–≤–µ—Ä—à–µ–Ω–∞");
      }

      penRestartBtn.textContent = "–°—ã–≥—Ä–∞—Ç—å –µ—â—ë —Ä–∞–∑";
    }
  }

  // --- Boot ---
  renderWallet();
  penRender();

  const initial = (location.hash || "#games").slice(1);
  go(pages.includes(initial) ? initial : "games");
</script>
</body>
</html>

