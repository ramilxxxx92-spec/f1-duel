<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>F1 Duel</title>
  <script src="https://telegram.org/js/telegram-web-app.js"></script>
  <style>
    :root{
      --bg:#0f1115;--card:#171a22;--muted:#9aa3b2;--text:#fff;
      --accent:#8cffc1;--danger:#ff5c5c;--line:#252a36;--shadow:0 12px 30px rgba(0,0,0,.35);
      --r:16px;
    }

    /* prevent selection/copy on mobile webviews */
    html, body{
      margin:0;
      background:var(--bg);
      color:var(--text);
      font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif;
      -webkit-user-select:none;
      user-select:none;
      -webkit-touch-callout:none;
      overscroll-behavior:none;
      height:100%;
    }
    *{box-sizing:border-box;-webkit-tap-highlight-color:transparent}

    .app{min-height:100vh;padding-bottom:86px}
    .topbar{
      position:sticky;top:0;z-index:10;
      background:rgba(15,17,21,.92);
      backdrop-filter:blur(10px);
      border-bottom:1px solid var(--line);
      padding:14px 16px;
      display:flex;align-items:center;justify-content:space-between;gap:12px
    }
    .brand{display:flex;align-items:center;gap:10px;font-weight:900}
    .chip{font-size:12px;padding:6px 10px;border:1px solid var(--line);border-radius:999px;color:var(--muted);white-space:nowrap}
    .container{padding:16px}
    .row{display:flex;gap:12px;flex-wrap:wrap}
    .card{background:var(--card);border:1px solid var(--line);border-radius:var(--r);box-shadow:var(--shadow);padding:14px}
    .card h2{margin:0 0 8px 0;font-size:16px}
    .muted{color:var(--muted);line-height:1.35}
    .btn{appearance:none;border:none;cursor:pointer;border-radius:12px;padding:12px 14px;font-size:15px;font-weight:900;width:100%}
    .btn.primary{background:var(--accent);color:#07110c}
    .btn.ghost{background:transparent;border:1px solid var(--line);color:var(--text)}
    .btn.danger{background:var(--danger);color:#1a0b0b}
    .grid{display:grid;grid-template-columns:1fr 1fr;gap:12px}
    .tile{
      background:linear-gradient(180deg,rgba(140,255,193,.10),rgba(255,255,255,0));
      border:1px solid var(--line);border-radius:var(--r);padding:14px;min-height:120px;
      display:flex;flex-direction:column;justify-content:space-between;cursor:pointer;user-select:none
    }
    .tile .t{font-weight:950}
    .tile .d{font-size:12px;color:var(--muted);margin-top:6px}
    .pill{display:inline-flex;align-items:center;gap:8px;padding:10px 12px;border:1px solid var(--line);border-radius:14px;background:rgba(255,255,255,.02)}
    .kv{display:flex;justify-content:space-between;gap:12px;padding:10px 0;border-top:1px solid var(--line)}
    .kv:first-child{border-top:none;padding-top:0}
    .nav{
      position:fixed;left:0;right:0;bottom:0;height:72px;background:rgba(15,17,21,.92);backdrop-filter:blur(10px);
      border-top:1px solid var(--line);display:flex;padding:10px 10px 14px;gap:10px;z-index:20
    }
    .nav button{
      flex:1;border:none;background:transparent;color:var(--muted);border-radius:14px;padding:10px 8px;font-size:12px;cursor:pointer;
      display:flex;flex-direction:column;align-items:center;justify-content:center;gap:6px
    }
    .nav button.active{color:var(--text);background:rgba(140,255,193,.12);border:1px solid rgba(140,255,193,.25)}
    .icon{font-size:18px;line-height:1}
    .hidden{display:none!important}
    .note{font-size:12px;color:var(--muted);margin-top:10px;line-height:1.35}
    .toast{
      position:fixed;left:50%;bottom:86px;transform:translateX(-50%);
      background:rgba(0,0,0,.75);color:#fff;padding:10px 12px;border-radius:12px;border:1px solid rgba(255,255,255,.12);
      box-shadow:var(--shadow);font-size:13px;z-index:999;max-width:90vw;text-align:center;
      opacity:0;pointer-events:none;transition:opacity .18s ease
    }
    .toast.show{opacity:1}

    /* Pong canvas */
    .pongCanvas{
      width:100%;max-width:440px;
      border:1px solid var(--line);
      border-radius:18px;
      display:block;margin:0 auto;
      background:#0b0d12;
      touch-action:none; /* important for mobile */
    }

    /* Penalty stage */
    .stage{
      position:relative;width:100%;max-width:420px;margin:0 auto;height:300px;
      border-radius:18px;border:1px solid var(--line);overflow:hidden;
      background:
        radial-gradient(520px 240px at 50% 10%, rgba(255,255,255,.12), rgba(255,255,255,0)),
        linear-gradient(180deg, rgba(140,255,193,.06), rgba(0,0,0,0)),
        #0b0d12;
      box-shadow:var(--shadow);
      touch-action:none; /* critical */
    }
    .goal{
      position:absolute;top:28px;left:26px;right:26px;height:130px;
      border:2px solid rgba(255,255,255,.28);border-radius:16px;
      box-shadow:0 18px 50px rgba(0,0,0,.40) inset;
    }
    .goal:before{
      content:"";position:absolute;inset:0;border-radius:16px;
      background-image:
        linear-gradient(rgba(255,255,255,.10) 1px, transparent 1px),
        linear-gradient(90deg, rgba(255,255,255,.10) 1px, transparent 1px);
      background-size:24px 24px;opacity:.55;
    }
    .goalLine{position:absolute;top:160px;left:26px;right:26px;height:2px;background:rgba(255,255,255,.18)}
    .keeper{
      position:absolute;top:88px;left:50%;width:54px;height:54px;transform:translateX(-50%);
      border-radius:18px;background:rgba(255,255,255,.16);
      border:1px solid rgba(255,255,255,.12);box-shadow:0 10px 24px rgba(0,0,0,.35);
    }
    .keeper:after{
      content:"";position:absolute;left:12px;right:12px;bottom:-18px;height:18px;
      border-radius:0 0 14px 14px;background:rgba(255,255,255,.10);border:1px solid rgba(255,255,255,.08);
    }
    .ball{
      position:absolute;bottom:18px;left:50%;width:24px;height:24px;transform:translateX(-50%) scale(1);
      border-radius:50%;background:radial-gradient(circle at 30% 30%, #fff, #cfd6e6);
      box-shadow:0 10px 22px rgba(0,0,0,.45);will-change:transform;
      touch-action:none;-webkit-user-drag:none;
    }
    .aimLine{
      position:absolute;width:2px;background:rgba(140,255,193,.85);
      box-shadow:0 0 16px rgba(140,255,193,.35);transform-origin:bottom center;
      bottom:30px;left:50%;height:0;display:none;border-radius:999px;will-change:transform,height;
    }
    .aimSpot{
      position:absolute;width:10px;height:10px;border-radius:50%;
      background:rgba(140,255,193,.95);box-shadow:0 0 18px rgba(140,255,193,.55);
      opacity:0;transition:opacity .12s ease;
    }
    .aimSpot.show{opacity:1}
    .flash{position:absolute;inset:0;opacity:0;transition:opacity .15s ease}
    .centerText{text-align:center}
    .bigMsg{margin-top:12px;font-size:18px;font-weight:950;min-height:26px}
    .smallMsg{margin-top:6px;color:var(--muted);font-size:13px;min-height:18px}
    @keyframes kickL { from{transform:translateX(-50%) translateY(0) scale(1)} to{transform:translateX(-210%) translateY(-190px) scale(.55)} }
    @keyframes kickC { from{transform:translateX(-50%) translateY(0) scale(1)} to{transform:translateX(-50%) translateY(-205px) scale(.55)} }
    @keyframes kickR { from{transform:translateX(-50%) translateY(0) scale(1)} to{transform:translateX(110%) translateY(-190px) scale(.55)} }
    @keyframes keepL { from{transform:translateX(-50%)} to{transform:translateX(-150%)} }
    @keyframes keepC { from{transform:translateX(-50%)} to{transform:translateX(-50%)} }
    @keyframes keepR { from{transform:translateX(-50%)} to{transform:translateX(50%)} }
  </style>
</head>
<body>
  <div class="app">
    <div class="topbar">
      <div class="brand"><span>üèÅ F1 Duel</span><span id="envChip" class="chip">WebApp</span></div>
      <div class="chip" id="userChip">–ì–æ—Å—Ç—å</div>
    </div>

    <main class="container">
      <!-- GAMES -->
      <section id="page-games">
        <div class="card" style="margin-bottom:12px;">
          <h2>–í—ã–±–æ—Ä –∏–≥—Ä—ã</h2>
          <div class="muted">Reaction Duel ‚Ä¢ Ping Pong ‚Ä¢ Penalty</div>
        </div>

        <div class="grid">
          <div class="tile" onclick="openGame('reaction')">
            <div><div class="t">‚ö° Reaction Duel</div><div class="d">–°–∫–æ—Ä–æ—Å—Ç—å —Ä–µ–∞–∫—Ü–∏–∏</div></div>
            <div class="muted" style="font-size:12px;">–û—Ç–∫—Ä—ã—Ç—å</div>
          </div>
          <div class="tile" onclick="openGame('pong')">
            <div><div class="t">üèì Ping Pong</div><div class="d">–ü–æ–±–µ–¥–∞ –¥–æ 3 –æ—á–∫–æ–≤</div></div>
            <div class="muted" style="font-size:12px;">–û—Ç–∫—Ä—ã—Ç—å</div>
          </div>
          <div class="tile" onclick="openGame('penalty')" style="grid-column: 1 / -1;">
            <div><div class="t">‚öΩ Penalty</div><div class="d">Swipe + Hold: –Ω–∞–ø—Ä–∞–≤–ª–µ–Ω–∏–µ + —Å–∏–ª–∞</div></div>
            <div class="muted" style="font-size:12px;">–û—Ç–∫—Ä—ã—Ç—å</div>
          </div>
        </div>

        <div class="note">–ó–≤—É–∫/–≤–∏–±—Ä–∞—Ü–∏–∏ –≤–∫–ª—é—á–∞—Ç—Å—è –ø–æ—Å–ª–µ –ø–µ—Ä–≤–æ–≥–æ –∫–∞—Å–∞–Ω–∏—è (–æ–≥—Ä–∞–Ω–∏—á–µ–Ω–∏–µ –±—Ä–∞—É–∑–µ—Ä–∞).</div>
      </section>

      <!-- WALLET (—Å—Ç–∞—Ä—ã–π –±–∞–ª–∞–Ω—Å) -->
      <section id="page-wallet" class="hidden">
        <div class="card">
          <h2>–ë–∞–ª–∞–Ω—Å</h2>
          <div class="row" style="margin: 10px 0 14px;">
            <div class="pill" style="flex:1; justify-content:space-between;"><span>ü™ô Coins</span><strong id="coinsVal">0</strong></div>
            <div class="pill" style="flex:1; justify-content:space-between;"><span>‚≠ê Stars</span><strong id="starsVal">0</strong></div>
          </div>
          <div class="kv"><span class="muted">–£—Ä–æ–≤–µ–Ω—å</span><strong id="levelVal">1</strong></div>
          <div class="kv"><span class="muted">–ü–æ–±–µ–¥—ã</span><strong id="winsVal">0</strong></div>
          <div class="kv"><span class="muted">–ò–≥—Ä—ã</span><strong id="playsVal">0</strong></div>

          <div style="margin-top:14px;" class="row">
            <button class="btn primary" onclick="addCoins(10); toast('+10 coins')">+10 coins (—Ç–µ—Å—Ç)</button>
            <button class="btn ghost" onclick="convertCoinsToStars()">coins ‚Üí stars</button>
          </div>
          <button style="margin-top:10px;" class="btn danger" onclick="resetProgress()">–°–±—Ä–æ—Å–∏—Ç—å –ø—Ä–æ–≥—Ä–µ—Å—Å</button>
          <div class="note">–ü–æ–∫–∞ –≤—Å—ë –ª–æ–∫–∞–ª—å–Ω–æ (localStorage). –î–ª—è PvP –Ω—É–∂–µ–Ω backend.</div>
        </div>
      </section>

      <!-- PROFILE -->
      <section id="page-profile" class="hidden">
        <div class="card">
          <h2>–õ–∏—á–Ω—ã–π –∫–∞–±–∏–Ω–µ—Ç</h2>
          <div class="muted" id="profileLine">‚Äî</div>
          <div style="margin-top:14px;">
            <div class="kv"><span class="muted">–ù–∏–∫</span><strong id="nickVal">‚Äî</strong></div>
            <div class="kv"><span class="muted">Telegram ID</span><strong id="tgidVal">‚Äî</strong></div>
            <div class="kv"><span class="muted">–°—Ç–∞—Ç—É—Å</span><strong id="statusVal">–ù–æ–≤–∏—á–æ–∫</strong></div>
          </div>
          <div style="margin-top:14px;" class="row">
            <button class="btn ghost" onclick="toast('–°–∫–æ—Ä–æ üôÇ')">–ù–∞—Å—Ç—Ä–æ–π–∫–∏</button>
            <button class="btn primary" onclick="go('games')">–ò–≥—Ä–∞—Ç—å</button>
          </div>
        </div>
      </section>

      <!-- REACTION -->
      <section id="page-reaction" class="hidden">
        <div class="card" style="margin-bottom:12px;">
          <h2>‚ö° Reaction Duel</h2><div class="muted">–ñ–º–∏ ¬´–ñ–¥–∞—Ç—å —Å—Ç–∞—Ä—Ç¬ª, –∑–∞—Ç–µ–º —Ç–∞–ø –ø–æ —Å–∏–≥–Ω–∞–ª—É. –§–∞–ª—å—Å—Ç–∞—Ä—Ç ‚Äî —à—Ç—Ä–∞—Ñ.</div>
        </div>
        <div class="card">
          <div id="light" style="width:120px;height:120px;border-radius:50%;margin:8px auto 18px;background:red;box-shadow:0 0 20px red;"></div>
          <button id="startBtn" class="btn primary">–ñ–¥–∞—Ç—å —Å—Ç–∞—Ä—Ç</button>
          <div id="result" style="margin-top:14px;font-size:20px;font-weight:950;"></div>
          <div class="note">+5 coins (–∏ +3 –µ—Å–ª–∏ &lt;250ms). –§–∞–ª—å—Å—Ç–∞—Ä—Ç ‚àí2.</div>
          <button style="margin-top:12px;" class="btn ghost" onclick="go('games')">‚Üê –ù–∞–∑–∞–¥</button>
        </div>
      </section>

      <!-- PONG -->
      <section id="page-pong" class="hidden">
        <div class="card" style="margin-bottom:12px;">
          <h2>üèì Ping Pong</h2>
          <div class="muted">–ü–æ–±–µ–¥–∞ –¥–æ 3 –æ—á–∫–æ–≤. –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ: –º—ã—à—å/–ø–∞–ª–µ—Ü.</div>
        </div>
        <div class="card">
          <div class="row" style="margin:0 0 12px;">
            <div class="pill" style="flex:1; justify-content:space-between;"><span>üôÇ –¢—ã</span><strong id="pongMe">0</strong></div>
            <div class="pill" style="flex:1; justify-content:space-between;"><span>ü§ñ –ë–æ—Ç</span><strong id="pongAi">0</strong></div>
          </div>
          <canvas id="pongCanvas" class="pongCanvas" width="440" height="560"></canvas>
          <div class="row" style="margin-top:12px;">
            <button id="pongStartBtn" class="btn primary" onclick="pongStart()">–°—Ç–∞—Ä—Ç</button>
            <button class="btn ghost" onclick="pongReset()">–°–±—Ä–æ—Å</button>
          </div>
          <button style="margin-top:12px;" class="btn ghost" onclick="pongStop(); go('games')">‚Üê –ù–∞–∑–∞–¥</button>
          <div class="note">–¢–∞–ø –ø–æ –ø–æ–ª—é = power-shot –Ω–∞ –∫–æ—Ä–æ—Ç–∫–æ–µ –≤—Ä–µ–º—è.</div>
        </div>
      </section>

      <!-- PENALTY -->
      <section id="page-penalty" class="hidden">
        <div class="card" style="margin-bottom:12px;">
          <h2>‚öΩ Penalty</h2>
          <div class="muted">–ö–æ—Å–Ω–∏—Å—å –º—è—á–∞ ‚Üí —Å–≤–∞–π–ø–Ω–∏ –≤–≤–µ—Ä—Ö (–Ω–∞–ø—Ä–∞–≤–ª–µ–Ω–∏–µ) ‚Üí –¥–µ—Ä–∂–∏ (—Å–∏–ª–∞) ‚Üí –æ—Ç–ø—É—Å—Ç–∏ (—É–¥–∞—Ä).</div>
        </div>

        <div class="card">
          <div class="row" style="margin:0 0 12px;">
            <div class="pill" style="flex:1;justify-content:space-between;"><span>üéØ –£–¥–∞—Ä</span><strong id="penShotTxt">1/5</strong></div>
            <div class="pill" style="flex:1;justify-content:space-between;"><span>ü•Ö –ì–æ–ª—ã</span><strong id="penGoalsTxt">0</strong></div>
          </div>

          <div class="stage" id="penStage">
            <div class="goal"></div>
            <div class="goalLine"></div>

            <div id="spotL" class="aimSpot" style="left:64px; top:58px;"></div>
            <div id="spotC" class="aimSpot" style="left:50%; top:46px; transform:translateX(-50%);"></div>
            <div id="spotR" class="aimSpot" style="right:64px; top:58px;"></div>

            <div class="keeper" id="keeper"></div>
            <div class="aimLine" id="aimLine"></div>
            <div class="ball" id="ball"></div>
            <div class="flash" id="flash"></div>
          </div>

          <div class="centerText">
            <div class="bigMsg" id="penMsg"></div>
            <div class="smallMsg" id="penSub"></div>
          </div>

          <div class="row" style="margin-top:12px;">
            <button class="btn ghost" onclick="penRestart()">–ó–∞–Ω–æ–≤–æ —Å–µ—Ä–∏—é</button>
            <button class="btn primary" onclick="go('games')">‚Üê –ù–∞–∑–∞–¥</button>
          </div>

          <div class="note">–ì–æ–ª: +2 coins. –ü–æ–±–µ–¥–∞ —Å–µ—Ä–∏–∏ (3+ –∏–∑ 5): +10 coins –∏ +1 win.</div>
        </div>
      </section>

    </main>
  </div>

  <nav class="nav">
    <button id="tab-games" onclick="go('games')"><div class="icon">üéÆ</div><div>–ò–≥—Ä—ã</div></button>
    <button id="tab-wallet" onclick="go('wallet')"><div class="icon">üí∞</div><div>–ë–∞–ª–∞–Ω—Å</div></button>
    <button id="tab-profile" onclick="go('profile')"><div class="icon">üë§</div><div>–ö–∞–±–∏–Ω–µ—Ç</div></button>
  </nav>

  <div id="toast" class="toast"></div>

<script>
  // Telegram
  const tg = window.Telegram?.WebApp;
  try{ tg?.ready(); tg?.expand(); }catch(e){}

  // Haptics
  function hImpact(type="light"){ try{ tg?.HapticFeedback?.impactOccurred(type); }catch(e){} }
  function hNote(type="success"){ try{ tg?.HapticFeedback?.notificationOccurred(type); }catch(e){} }
  function hSelect(){ try{ tg?.HapticFeedback?.selectionChanged(); }catch(e){} }

  // Audio (WebAudio)
  let audioUnlocked=false, audioCtx=null;
  function unlockAudio(){
    if(audioUnlocked) return;
    try{
      audioCtx = new (window.AudioContext || window.webkitAudioContext)();
      const o=audioCtx.createOscillator(), g=audioCtx.createGain();
      o.connect(g); g.connect(audioCtx.destination);
      g.gain.value=0.0001; o.start(); o.stop(audioCtx.currentTime+0.01);
      audioUnlocked=true;
    }catch(e){}
  }
  function beep(freq=440,dur=0.08,vol=0.06,type="sine"){
    if(!audioCtx) return;
    const t=audioCtx.currentTime;
    const o=audioCtx.createOscillator(); const g=audioCtx.createGain();
    o.type=type; o.frequency.value=freq;
    g.gain.setValueAtTime(0.0001,t);
    g.gain.exponentialRampToValueAtTime(vol,t+0.01);
    g.gain.exponentialRampToValueAtTime(0.0001,t+dur);
    o.connect(g); g.connect(audioCtx.destination);
    o.start(t); o.stop(t+dur+0.02);
  }

  const sKick=()=>{beep(140,0.06,0.08,"triangle");beep(90,0.08,0.05,"sine");};
  const sGoal=()=>{beep(660,0.08,0.08,"sine");beep(880,0.10,0.08,"sine");};
  const sSave=()=>{beep(220,0.10,0.06,"square");};
  const sMiss=()=>{beep(180,0.14,0.05,"sawtooth");};

  // Helpers
  function clamp(v,min,max){ return Math.max(min, Math.min(max, v)); }

  // Local state (—Å—Ç–∞—Ä—ã–π –±–∞–ª–∞–Ω—Å)
  const storeKey="f1duel_state_v3";
  const defaultState={coins:0,stars:0,wins:0,plays:0};
  const state=(()=>{ try{const r=localStorage.getItem(storeKey); return r?{...defaultState,...JSON.parse(r)}:{...defaultState}; }catch(e){ return {...defaultState}; } })();

  const toastEl=document.getElementById("toast"); let toastTimer=null;
  function toast(t){ toastEl.textContent=t; toastEl.classList.add("show"); clearTimeout(toastTimer); toastTimer=setTimeout(()=>toastEl.classList.remove("show"), 1600); }

  function saveState(){ localStorage.setItem(storeKey, JSON.stringify(state)); renderWallet(); }
  function calcLevel(){ const score=state.coins+state.stars*50; return Math.max(1, Math.floor(score/200)+1); }
  function renderWallet(){
    document.getElementById("coinsVal").textContent=state.coins;
    document.getElementById("starsVal").textContent=state.stars;
    document.getElementById("winsVal").textContent=state.wins;
    document.getElementById("playsVal").textContent=state.plays;
    document.getElementById("levelVal").textContent=calcLevel();
  }
  function addCoins(n){ state.coins=Math.max(0, state.coins+n); saveState(); }
  function convertCoinsToStars(){
    const rate=100;
    if(state.coins<rate){ toast(`–ù—É–∂–Ω–æ –º–∏–Ω–∏–º—É–º ${rate} coins`); return; }
    const s=Math.floor(state.coins/rate);
    state.coins-=s*rate; state.stars+=s; saveState(); toast(`–û–±–º–µ–Ω: +${s} ‚≠ê`);
  }
  function resetProgress(){ Object.assign(state,{...defaultState}); saveState(); toast("–ü—Ä–æ–≥—Ä–µ—Å—Å —Å–±—Ä–æ—à–µ–Ω"); }

  // Routing
  const pages=["games","wallet","profile","reaction","pong","penalty"];
  function go(page){
    pages.forEach(p=>document.getElementById("page-"+p).classList.toggle("hidden", p!==page));
    ["games","wallet","profile"].forEach(t=>document.getElementById("tab-"+t).classList.toggle("active", t===page));
    if(page==="reaction"||page==="pong"||page==="penalty"){
      document.getElementById("tab-games").classList.add("active");
      ["wallet","profile"].forEach(t=>document.getElementById("tab-"+t).classList.remove("active"));
    }
    location.hash="#"+page;
  }
  function openGame(id){
    if(id==="reaction")go("reaction");
    if(id==="pong")go("pong");
    if(id==="penalty")go("penalty");
  }

  // Header info
  const envChip=document.getElementById("envChip"), userChip=document.getElementById("userChip");
  envChip.textContent=tg?"Telegram WebApp":"Browser";
  const user=tg?.initDataUnsafe?.user;
  if(user){
    const nick=user.username||user.first_name||"Player";
    userChip.textContent="@"+nick;
    document.getElementById("nickVal").textContent=nick;
    document.getElementById("tgidVal").textContent=user.id;
    document.getElementById("profileLine").textContent=`–ü—Ä–∏–≤–µ—Ç, ${nick}.`;
  } else {
    document.getElementById("profileLine").textContent="–û—Ç–∫—Ä–æ–π —á–µ—Ä–µ–∑ Telegram, —á—Ç–æ–±—ã –ø–æ–¥—Ç—è–Ω—É–ª—Å—è –ø—Ä–æ—Ñ–∏–ª—å.";
  }

  // =========================
  // REACTION
  // =========================
  const light=document.getElementById("light"), startBtn=document.getElementById("startBtn"), result=document.getElementById("result");
  let startTime=0, waiting=false, timer=null;
  function setLight(c){ light.style.background=c; light.style.boxShadow=(c==="lime")?"0 0 30px lime":"0 0 20px red"; }
  startBtn.onclick=()=>{
    unlockAudio(); hImpact("light");
    if(waiting) return;
    result.textContent=""; setLight("red"); waiting=true; startBtn.textContent="–ñ–î–ò‚Ä¶";
    timer=setTimeout(()=>{ setLight("lime"); startTime=Date.now(); hImpact("medium"); beep(520,0.06,0.05,"sine"); }, 1800+Math.random()*2600);
  };
  light.onclick=()=>{
    unlockAudio();
    if(!waiting) return;
    if(!startTime){
      clearTimeout(timer);
      result.textContent="‚ùå –§–∞–ª—å—Å—Ç–∞—Ä—Ç! ‚àí2 coins";
      addCoins(-2); toast("–§–∞–ª—å—Å—Ç–∞—Ä—Ç ‚àí2"); hNote("error"); beep(180,0.12,0.05,"square");
      waiting=false; startTime=0; startBtn.textContent="–ï—â—ë —Ä–∞–∑";
      return;
    }
    const r=Date.now()-startTime;
    state.plays += 1;
    let reward=5; if(r<250) reward += 3;
    addCoins(reward); saveState();
    result.textContent=`‚ö° ${r} –º—Å  ‚Ä¢  +${reward} coins`;
    toast(`+${reward} coins`); hNote("success"); beep(880,0.08,0.06,"sine");
    waiting=false; startTime=0; startBtn.textContent="–ï—â—ë —Ä–∞–∑";
  };

  // =========================
  // PONG
  // =========================
  const canvas=document.getElementById("pongCanvas");
  const ctx=canvas.getContext("2d");
  const pongMeEl=document.getElementById("pongMe");
  const pongAiEl=document.getElementById("pongAi");
  const pongStartBtn=document.getElementById("pongStartBtn");

  const W=canvas.width, H=canvas.height;

  let pongRunning=false, rafId=null;
  const p1={w:110,h:14,x:W/2-55,y:H-34};
  const p2={w:110,h:14,x:W/2-55,y:22};
  const pb={r:7,x:W/2,y:H/2,vx:3.2,vy:3.6};

  let me=0, ai=0;
  let powerUntil=0;

  function hudPong(){ pongMeEl.textContent=me; pongAiEl.textContent=ai; }
  function resetBall(towardsPlayer){
    pb.x=W/2; pb.y=H/2;
    const base=3.1 + Math.random()*0.8;
    pb.vx = (Math.random()>.5?1:-1)*base;
    pb.vy = (towardsPlayer?1:-1)*(3.2 + Math.random()*1.0);
  }
  function drawPong(){
    ctx.clearRect(0,0,W,H);
    ctx.fillStyle="#0b0d12";
    ctx.fillRect(0,0,W,H);

    ctx.globalAlpha=.18;
    ctx.fillStyle="#ffffff";
    ctx.fillRect(W/2-1, 16, 2, H-32);
    ctx.globalAlpha=1;

    ctx.fillStyle="#8cffc1";
    ctx.fillRect(p1.x, p1.y, p1.w, p1.h);
    ctx.fillStyle="rgba(255,255,255,.25)";
    ctx.fillRect(p2.x, p2.y, p2.w, p2.h);

    const now=performance.now();
    const powerActive = now < powerUntil;
    ctx.fillStyle = powerActive ? "#8cffc1" : "#ffffff";
    ctx.beginPath();
    ctx.arc(pb.x, pb.y, pb.r, 0, Math.PI*2);
    ctx.fill();
  }
  function collide(p, b){
    return (b.x + b.r > p.x && b.x - b.r < p.x + p.w && b.y + b.r > p.y && b.y - b.r < p.y + p.h);
  }
  function aiMove(){
    const target = pb.x - p2.w/2 + (Math.random()*2-1)*8;
    const dx = target - p2.x;
    p2.x += clamp(dx, -4.6, 4.6);
    p2.x = clamp(p2.x, 0, W-p2.w);
  }
  function loop(){
    if(!pongRunning) return;

    aiMove();

    pb.x += pb.vx;
    pb.y += pb.vy;

    if(pb.x - pb.r <= 0 || pb.x + pb.r >= W){
      pb.vx *= -1;
      pb.x = clamp(pb.x, pb.r, W-pb.r);
      beep(260,0.04,0.03,"sine");
    }

    if(pb.vy > 0 && collide(p1, pb)){
      pb.vy *= -1;
      const hit = (pb.x - (p1.x + p1.w/2)) / (p1.w/2);
      pb.vx += hit * 1.15;
      pb.vx = clamp(pb.vx, -6.0, 6.0);
      hImpact("light");
      beep(520,0.04,0.03,"triangle");
      if(performance.now() < powerUntil){
        pb.vx += hit * 1.6;
        pb.vy *= 1.06;
        hImpact("medium");
        beep(740,0.05,0.05,"triangle");
        powerUntil = 0;
      }
    }
    if(pb.vy < 0 && collide(p2, pb)){
      pb.vy *= -1;
      const hit = (pb.x - (p2.x + p2.w/2)) / (p2.w/2);
      pb.vx += hit * 0.85;
      pb.vx = clamp(pb.vx, -6.0, 6.0);
      beep(360,0.04,0.03,"square");
    }

    if(pb.y - pb.r <= 0){
      me += 1; toast("–û—á–∫–æ —Ç–µ–±–µ!"); beep(840,0.06,0.04,"sine");
      resetBall(false); hudPong();
    }
    if(pb.y + pb.r >= H){
      ai += 1; toast("–û—á–∫–æ –±–æ—Ç—É"); beep(180,0.08,0.04,"square");
      resetBall(true); hudPong();
    }

    if(me >= 3 || ai >= 3){
      pongRunning=false;
      state.plays += 1;
      if(me >= 3){
        state.wins += 1;
        addCoins(15);
        toast("üèÜ –ü–æ–±–µ–¥–∞! +15 coins");
        hNote("success");
      } else {
        toast("–ü–æ—Ä–∞–∂–µ–Ω–∏–µ üòÑ");
        hNote("error");
      }
      saveState();
      pongStartBtn.textContent="–°—ã–≥—Ä–∞—Ç—å –µ—â—ë";
      drawPong();
      return;
    }

    drawPong();
    rafId = requestAnimationFrame(loop);
  }
  function pongStart(){
    unlockAudio();
    if(pongRunning) return;
    pongRunning=true;
    pongStartBtn.textContent="–ò–¥—ë—Ç‚Ä¶";
    toast("–ü–æ–µ—Ö–∞–ª–∏!");
    rafId = requestAnimationFrame(loop);
  }
  function pongStop(){
    pongRunning=false;
    if(rafId) cancelAnimationFrame(rafId);
    rafId=null;
  }
  function pongReset(){
    pongStop();
    me=0; ai=0;
    p1.x=W/2-p1.w/2; p2.x=W/2-p2.w/2;
    resetBall(true);
    pongStartBtn.textContent="–°—Ç–∞—Ä—Ç";
    hudPong();
    drawPong();
  }
  function setPaddleFromClientX(clientX){
    const rect=canvas.getBoundingClientRect();
    const x=(clientX-rect.left)*(W/rect.width);
    p1.x = clamp(x - p1.w/2, 0, W - p1.w);
  }
  canvas.addEventListener("mousemove",(e)=>setPaddleFromClientX(e.clientX));
  canvas.addEventListener("touchmove",(e)=>{e.preventDefault();setPaddleFromClientX(e.touches[0].clientX)},{passive:false});

  function triggerPower(){
    if(!pongRunning) return;
    powerUntil = performance.now() + 220;
    hImpact("light");
  }
  canvas.addEventListener("mousedown",()=>{unlockAudio();triggerPower();});
  canvas.addEventListener("touchstart",(e)=>{e.preventDefault();unlockAudio();triggerPower();},{passive:false});

  // =========================
  // PENALTY (Swipe + Hold)
  // =========================
  const penShotTxt=document.getElementById("penShotTxt");
  const penGoalsTxt=document.getElementById("penGoalsTxt");
  const penMsg=document.getElementById("penMsg");
  const penSub=document.getElementById("penSub");

  const penStage=document.getElementById("penStage");
  const ball=document.getElementById("ball");
  const keeper=document.getElementById("keeper");
  const line=document.getElementById("aimLine");
  const flash=document.getElementById("flash");

  const spotL=document.getElementById("spotL");
  const spotC=document.getElementById("spotC");
  const spotR=document.getElementById("spotR");

  let shot=1, goals=0;
  let holding=false;
  let startX=0,startY=0;
  let currentAngle=0;
  let power=0;
  let locked=false;
  let downAt=0;

  function penRender(){
    penShotTxt.textContent=`${Math.min(shot,5)}/5`;
    penGoalsTxt.textContent=`${goals}`;
  }
  function hideSpots(){ spotL.classList.remove("show");spotC.classList.remove("show");spotR.classList.remove("show"); }
  function showSpot(dir){
    hideSpots();
    if(dir==="L") spotL.classList.add("show");
    if(dir==="C") spotC.classList.add("show");
    if(dir==="R") spotR.classList.add("show");
  }
  function resetAnim(){
    ball.style.animation="";
    ball.style.transform="translateX(-50%) scale(1)";
    keeper.style.animation="";
    keeper.style.transform="translateX(-50%)";
    line.style.display="none";
    line.style.height="0px";
    flash.style.opacity="0";
    hideSpots();
  }
  function setFlash(ok){
    flash.style.background = ok ? "rgba(140,255,193,.18)" : "rgba(255,92,92,.18)";
    flash.style.opacity="1";
    setTimeout(()=>flash.style.opacity="0", 140);
  }
  function penRestart(){
    unlockAudio();
    shot=1; goals=0; locked=false; holding=false;
    penMsg.textContent=""; penSub.textContent="–ö–æ—Å–Ω–∏—Å—å –º—è—á–∞ –∏ —Å–≤–∞–π–ø–Ω–∏ –≤–≤–µ—Ä—Ö.";
    penRender(); resetAnim();
    toast("–ù–æ–≤–∞—è —Å–µ—Ä–∏—è");
  }
  function endSeries(){
    locked=true;
    state.plays += 1;

    if(goals>=3){
      state.wins += 1;
      addCoins(10);
      penMsg.textContent=`üèÜ –ü–æ–±–µ–¥–∞ —Å–µ—Ä–∏–∏! ${goals}/5`;
      penSub.textContent="+10 coins ‚Ä¢ +1 win";
      hNote("success"); sGoal();
    }else{
      penMsg.textContent=`–°–µ—Ä–∏—è –æ–∫–æ–Ω—á–µ–Ω–∞: ${goals}/5`;
      penSub.textContent="–ï—â—ë —Ä–∞–∑ ‚Äî –∏ –±—É–¥–µ—Ç –ª—É—á—à–µ.";
      hNote("error"); sMiss();
    }
    saveState();
  }

  // block browser gestures on penalty stage (extra-robust)
  penStage.addEventListener("contextmenu", (e)=>{ e.preventDefault(); }, {passive:false});
  function stageBlock(e){ e.preventDefault(); }
  penStage.addEventListener("touchstart", stageBlock, {passive:false});
  penStage.addEventListener("touchmove", stageBlock, {passive:false});
  penStage.addEventListener("touchend", stageBlock, {passive:false});

  function onTouchStart(e){
    if(locked) return;
    unlockAudio();
    e.preventDefault(); e.stopPropagation();

    const t=e.touches[0];
    startX=t.clientX; startY=t.clientY;
    downAt=Date.now();

    holding=true; power=0; currentAngle=0;
    line.style.display="block";
    line.style.height="0px";
    line.style.transform="translateX(-50%) rotate(0rad)";
    penMsg.textContent="";
    penSub.textContent="–î–µ—Ä–∂–∏ –ø–∞–ª–µ—Ü (—Å–∏–ª–∞ —Ä–∞—Å—Ç—ë—Ç) ‚Üí –æ—Ç–ø—É—Å—Ç–∏ –¥–ª—è —É–¥–∞—Ä–∞.";
    hImpact("light");
  }
  function onTouchMove(e){
    if(!holding || locked) return;
    e.preventDefault(); e.stopPropagation();

    const t=e.touches[0];
    const dx=t.clientX-startX;
    const dy=startY-t.clientY;

    const len=Math.sqrt(dx*dx+dy*dy);
    const maxLen=150;
    const visLen=clamp(len,0,maxLen);

    const safeDy=Math.max(24, dy);
    const angle=Math.atan2(dx, safeDy);
    currentAngle=angle;

    line.style.height=visLen+"px";
    line.style.transform=`translateX(-50%) rotate(${angle}rad)`;

    power = clamp(visLen/110, 0, 1);
    ball.style.transform=`translateX(-50%) scale(${1 + power*0.25})`;

    let dir="C";
    if(angle < -0.28) dir="L";
    else if(angle > 0.28) dir="R";
    showSpot(dir);
    hSelect();
  }
  function onTouchEnd(e){
    if(!holding || locked) return;
    e.preventDefault(); e.stopPropagation();

    holding=false;
    line.style.display="none";

    const holdMs = Date.now() - downAt;
    const holdBoost = clamp((holdMs-160)/900, 0, 0.35);
    const finalPower = clamp(power + holdBoost, 0.15, 1.0);

    let dir="C";
    if(currentAngle < -0.28) dir="L";
    else if(currentAngle > 0.28) dir="R";

    // keeper choice
    const r=Math.random();
    let keeperDir="C";
    if(r < 0.42) keeperDir="C";
    else keeperDir = (Math.random()<0.5) ? "L" : "R";

    resetAnim();
    showSpot(dir);

    const animBall = dir==="L" ? "kickL" : dir==="C" ? "kickC" : "kickR";
    const animKeeper = keeperDir==="L" ? "keepL" : keeperDir==="C" ? "keepC" : "keepR";
    ball.style.animation = `${animBall} .34s ease-out forwards`;
    keeper.style.animation = `${animKeeper} .30s ease-out forwards`;

    hImpact("medium");
    sKick();

    const corner = (dir !== "C");
    const missChance = clamp(
      (finalPower > 0.90 ? 0.12 : 0.05) +
      (corner && finalPower > 0.82 ? 0.10 : 0) +
      (corner ? 0.03 : 0),
      0.03, 0.34
    );
    const missed = Math.random() < missChance;

    let saved=false;
    if(!missed){
      const guessed = (keeperDir === dir);
      const saveBase = guessed ? 0.55 : 0.18;
      const saveChance = clamp(saveBase - finalPower*0.35, 0.06, 0.65);
      saved = Math.random() < saveChance;
    }

    setTimeout(()=>{
      if(missed){
        penMsg.textContent="‚ùå –ú–ò–ú–û!";
        penSub.textContent=`–°–∏–ª–∞: ${Math.round(finalPower*100)}% ‚Äî –æ—Ç–ø—É—Å—Ç–∏ —á—É—Ç—å —Ä–∞–Ω—å—à–µ.`;
        setFlash(false); hNote("error"); sMiss();
      } else if(saved){
        penMsg.textContent="üß§ –°–ï–ô–í!";
        penSub.textContent=`–í—Ä–∞—Ç–∞—Ä—å —É–≥–∞–¥–∞–ª. –°–∏–ª–∞: ${Math.round(finalPower*100)}%`;
        setFlash(false); hNote("error"); sSave();
      } else {
        goals += 1;
        addCoins(2);
        penMsg.textContent="‚öΩÔ∏è –ì–û–û–û–õ! +2 coins";
        penSub.textContent=`–°–∏–ª–∞: ${Math.round(finalPower*100)}%`;
        setFlash(true); hNote("success"); sGoal();
      }

      shot += 1;
      penRender();

      setTimeout(()=>{
        resetAnim();
        if(shot > 5){
          endSeries();
        } else {
          penMsg.textContent="";
          penSub.textContent="–°–ª–µ–¥—É—é—â–∏–π —É–¥–∞—Ä: –∫–æ—Å–Ω–∏—Å—å –º—è—á–∞.";
        }
      }, 260);
    }, 220);
  }

  ball.addEventListener("touchstart", onTouchStart, {passive:false});
  ball.addEventListener("touchmove",  onTouchMove,  {passive:false});
  ball.addEventListener("touchend",   onTouchEnd,   {passive:false});
  ball.addEventListener("touchcancel",onTouchEnd,   {passive:false});

  // Boot
  renderWallet();
  pongReset();
  penRestart();
  const initial=(location.hash||"#games").slice(1);
  go(pages.includes(initial)?initial:"games");
</script>
</body>
</html>

