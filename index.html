<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>F1 Duel</title>
  <script src="https://telegram.org/js/telegram-web-app.js"></script>
  <style>
    :root{--bg:#0f1115;--card:#171a22;--muted:#9aa3b2;--text:#fff;--accent:#8cffc1;--danger:#ff5c5c;--line:#252a36;--shadow:0 12px 30px rgba(0,0,0,.35);--r:16px}
    *{box-sizing:border-box}body{margin:0;font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif;background:var(--bg);color:var(--text)}
    .app{min-height:100vh;padding-bottom:86px}
    .topbar{position:sticky;top:0;z-index:10;background:rgba(15,17,21,.92);backdrop-filter:blur(10px);border-bottom:1px solid var(--line);padding:14px 16px;display:flex;align-items:center;justify-content:space-between;gap:12px}
    .brand{display:flex;align-items:center;gap:10px;font-weight:800}
    .chip{font-size:12px;padding:6px 10px;border:1px solid var(--line);border-radius:999px;color:var(--muted);white-space:nowrap}
    .container{padding:16px}.row{display:flex;gap:12px;flex-wrap:wrap}
    .card{background:var(--card);border:1px solid var(--line);border-radius:var(--r);box-shadow:var(--shadow);padding:14px}
    .card h2{margin:0 0 8px 0;font-size:16px}.muted{color:var(--muted)}
    .btn{appearance:none;border:none;cursor:pointer;border-radius:12px;padding:12px 14px;font-size:15px;font-weight:800;width:100%}
    .btn.primary{background:var(--accent);color:#07110c}.btn.ghost{background:transparent;border:1px solid var(--line);color:var(--text)}.btn.danger{background:var(--danger);color:#1a0b0b}
    .grid{display:grid;grid-template-columns:1fr 1fr;gap:12px}
    .tile{background:linear-gradient(180deg,rgba(140,255,193,.10),rgba(255,255,255,0));border:1px solid var(--line);border-radius:var(--r);padding:14px;min-height:120px;display:flex;flex-direction:column;justify-content:space-between;cursor:pointer;user-select:none}
    .tile .t{font-weight:900}.tile .d{font-size:12px;color:var(--muted);margin-top:6px}
    .pill{display:inline-flex;align-items:center;gap:8px;padding:10px 12px;border:1px solid var(--line);border-radius:14px;background:rgba(255,255,255,.02)}
    .kv{display:flex;justify-content:space-between;gap:12px;padding:10px 0;border-top:1px solid var(--line)}.kv:first-child{border-top:none;padding-top:0}
    .nav{position:fixed;left:0;right:0;bottom:0;height:72px;background:rgba(15,17,21,.92);backdrop-filter:blur(10px);border-top:1px solid var(--line);display:flex;padding:10px 10px 14px;gap:10px;z-index:20}
    .nav button{flex:1;border:none;background:transparent;color:var(--muted);border-radius:14px;padding:10px 8px;font-size:12px;cursor:pointer;display:flex;flex-direction:column;align-items:center;justify-content:center;gap:6px}
    .nav button.active{color:var(--text);background:rgba(140,255,193,.12);border:1px solid rgba(140,255,193,.25)}
    .icon{font-size:18px;line-height:1}.hidden{display:none!important}
    .note{font-size:12px;color:var(--muted);margin-top:10px;line-height:1.35}
    .toast{position:fixed;left:50%;bottom:86px;transform:translateX(-50%);background:rgba(0,0,0,.75);color:#fff;padding:10px 12px;border-radius:12px;border:1px solid rgba(255,255,255,.12);box-shadow:var(--shadow);font-size:13px;z-index:999;max-width:90vw;text-align:center;opacity:0;pointer-events:none;transition:opacity .18s ease}
    .toast.show{opacity:1}

    /* Penalty FIFA-ish animations */
    @keyframes kickToLeft { from { transform: translateX(-50%) translateY(0) scale(1); } to { transform: translateX(-220%) translateY(-160px) scale(.55);} }
    @keyframes kickToCenter{ from { transform: translateX(-50%) translateY(0) scale(1);} to { transform: translateX(-50%) translateY(-175px) scale(.55);} }
    @keyframes kickToRight{ from { transform: translateX(-50%) translateY(0) scale(1);} to { transform: translateX(120%) translateY(-160px) scale(.55);} }

    @keyframes keeperLeft  { from { transform: translateX(-50%); } to { transform: translateX(-160%); } }
    @keyframes keeperCenter{ from { transform: translateX(-50%); } to { transform: translateX(-50%); } }
    @keyframes keeperRight { from { transform: translateX(-50%); } to { transform: translateX(60%); } }

    @keyframes shake { 0%{transform:translateX(0)} 25%{transform:translateX(-2px)} 50%{transform:translateX(2px)} 75%{transform:translateX(-2px)} 100%{transform:translateX(0)} }
    .shake { animation: shake .18s ease; }

    /* Power bar */
    .barWrap{margin-top:10px;border:1px solid var(--line);border-radius:14px;padding:10px;background:rgba(0,0,0,.18)}
    .bar{height:10px;border-radius:999px;background:rgba(255,255,255,.08);position:relative;overflow:hidden}
    .bar .ideal{position:absolute;top:0;bottom:0;border-radius:999px;background:rgba(140,255,193,.35)}
    .bar .needle{position:absolute;top:-6px;width:2px;height:22px;background:#fff;box-shadow:0 0 14px rgba(255,255,255,.35)}
  </style>
</head>
<body>
  <div class="app">
    <div class="topbar">
      <div class="brand"><span>üèÅ F1 Duel</span><span id="envChip" class="chip">WebApp</span></div>
      <div class="chip" id="userChip">–ì–æ—Å—Ç—å</div>
    </div>

    <main class="container">
      <!-- GAMES -->
      <section id="page-games">
        <div class="card" style="margin-bottom:12px;">
          <h2>–í—ã–±–æ—Ä –∏–≥—Ä—ã</h2>
          <div class="muted">Reaction ‚Ä¢ Penalty (FIFA-—Ç–∞–π–º–∏–Ω–≥ + –≤–∏–∑—É–∞–ª + –∑–≤—É–∫) ‚Ä¢ Ping Pong.</div>
        </div>

        <div class="grid">
          <div class="tile" onclick="openGame('reaction')">
            <div><div class="t">‚ö° Reaction Duel</div><div class="d">–°–∫–æ—Ä–æ—Å—Ç—å —Ä–µ–∞–∫—Ü–∏–∏</div></div>
            <div class="muted" style="font-size:12px;">–û—Ç–∫—Ä—ã—Ç—å</div>
          </div>
          <div class="tile" onclick="openGame('penalty')">
            <div><div class="t">‚öΩÔ∏è Penalty Duel</div><div class="d">–¢–∞–π–º–∏–Ω–≥ + —Å–∏–ª–∞ + –∑–æ–Ω–∞ –∏–¥–µ–∞–ª–∞</div></div>
            <div class="muted" style="font-size:12px;">–û—Ç–∫—Ä—ã—Ç—å</div>
          </div>
          <div class="tile" onclick="openGame('pong')">
            <div><div class="t">üèì Ping Pong</div><div class="d">–£—Å–∫–æ—Ä–µ–Ω–∏–µ ‚Ä¢ power-shot ‚Ä¢ –∫–æ–º–±–æ</div></div>
            <div class="muted" style="font-size:12px;">–û—Ç–∫—Ä—ã—Ç—å</div>
          </div>
          <div class="tile" onclick="toast('–°–∫–æ—Ä–æ üôÇ')">
            <div><div class="t">üß† Quiz Sprint</div><div class="d">–ü–æ–∑–∂–µ</div></div>
            <div class="muted" style="font-size:12px;">–°–∫–æ—Ä–æ</div>
          </div>
        </div>

        <div class="note">Penalty: –≤—ã–±–µ—Ä–∏ –Ω–∞–ø—Ä–∞–≤–ª–µ–Ω–∏–µ ‚Üí –Ω–∞–∂–º–∏ ‚Äú–ë–∏—Ç—å‚Äù ‚Üí –ø–æ–π–º–∞–π —Ç–∞–π–º–∏–Ω–≥ –Ω–∞ —à–∫–∞–ª–µ (—Å–∏–ª–∞/—Ç–æ—á–Ω–æ—Å—Ç—å). –í–∏–±—Ä–∞—Ü–∏–∏+–∑–≤—É–∫–∏ –≤–∫–ª—é—á–∞—é—Ç—Å—è –ø–æ—Å–ª–µ –ø–µ—Ä–≤–æ–≥–æ —Ç–∞–ø–∞.</div>
      </section>

      <!-- WALLET -->
      <section id="page-wallet" class="hidden">
        <div class="card">
          <h2>–ë–∞–ª–∞–Ω—Å</h2>
          <div class="row" style="margin: 10px 0 14px;">
            <div class="pill" style="flex:1; justify-content:space-between;"><span>ü™ô Coins</span><strong id="coinsVal">0</strong></div>
            <div class="pill" style="flex:1; justify-content:space-between;"><span>‚≠ê Stars</span><strong id="starsVal">0</strong></div>
          </div>
          <div class="kv"><span class="muted">–£—Ä–æ–≤–µ–Ω—å</span><strong id="levelVal">1</strong></div>
          <div class="kv"><span class="muted">–ü–æ–±–µ–¥—ã</span><strong id="winsVal">0</strong></div>
          <div class="kv"><span class="muted">–ò–≥—Ä—ã</span><strong id="playsVal">0</strong></div>

          <div style="margin-top:14px;" class="row">
            <button class="btn primary" onclick="addCoins(10); toast('+10 coins')">+10 coins (—Ç–µ—Å—Ç)</button>
            <button class="btn ghost" onclick="convertCoinsToStars()">coins ‚Üí stars</button>
          </div>
          <button style="margin-top:10px;" class="btn danger" onclick="resetProgress()">–°–±—Ä–æ—Å–∏—Ç—å –ø—Ä–æ–≥—Ä–µ—Å—Å</button>
          <div class="note">–ü–æ–∫–∞ –≤—Å—ë –ª–æ–∫–∞–ª—å–Ω–æ (localStorage). –î–ª—è PvP –Ω—É–∂–µ–Ω backend.</div>
        </div>
      </section>

      <!-- PROFILE -->
      <section id="page-profile" class="hidden">
        <div class="card">
          <h2>–õ–∏—á–Ω—ã–π –∫–∞–±–∏–Ω–µ—Ç</h2>
          <div class="muted" id="profileLine">‚Äî</div>
          <div style="margin-top:14px;">
            <div class="kv"><span class="muted">–ù–∏–∫</span><strong id="nickVal">‚Äî</strong></div>
            <div class="kv"><span class="muted">Telegram ID</span><strong id="tgidVal">‚Äî</strong></div>
            <div class="kv"><span class="muted">–°—Ç–∞—Ç—É—Å</span><strong id="statusVal">–ù–æ–≤–∏—á–æ–∫</strong></div>
          </div>
          <div style="margin-top:14px;" class="row">
            <button class="btn ghost" onclick="toast('–°–∫–æ—Ä–æ üôÇ')">–ù–∞—Å—Ç—Ä–æ–π–∫–∏</button>
            <button class="btn primary" onclick="go('games')">–ò–≥—Ä–∞—Ç—å</button>
          </div>
        </div>
      </section>

      <!-- REACTION -->
      <section id="page-reaction" class="hidden">
        <div class="card" style="margin-bottom:12px;">
          <h2>‚ö° Reaction Duel</h2><div class="muted">–ñ–º–∏ ¬´–ñ–¥–∞—Ç—å —Å—Ç–∞—Ä—Ç¬ª, –∑–∞—Ç–µ–º —Ç–∞–ø –ø–æ —Å–∏–≥–Ω–∞–ª—É. –§–∞–ª—å—Å—Ç–∞—Ä—Ç ‚Äî —à—Ç—Ä–∞—Ñ.</div>
        </div>
        <div class="card">
          <div id="light" style="width:120px;height:120px;border-radius:50%;margin:8px auto 18px;background:red;box-shadow:0 0 20px red;"></div>
          <button id="startBtn" class="btn primary">–ñ–¥–∞—Ç—å —Å—Ç–∞—Ä—Ç</button>
          <div id="result" style="margin-top:14px;font-size:20px;font-weight:900;"></div>
          <div class="note">+5 coins (–∏ +3 –µ—Å–ª–∏ &lt;250ms). –§–∞–ª—å—Å—Ç–∞—Ä—Ç ‚àí2.</div>
          <button style="margin-top:12px;" class="btn ghost" onclick="go('games')">‚Üê –ù–∞–∑–∞–¥</button>
        </div>
      </section>

      <!-- PENALTY (FIFA-ish) -->
      <section id="page-penalty" class="hidden">
        <div class="card" style="margin-bottom:12px;">
          <h2>‚öΩÔ∏è Penalty Duel</h2>
          <div class="muted">–í—ã–±–µ—Ä–∏ –Ω–∞–ø—Ä–∞–≤–ª–µ–Ω–∏–µ ‚Üí ¬´–ë–∏—Ç—å¬ª ‚Üí –ø–æ–π–º–∞–π —Ç–∞–π–º–∏–Ω–≥. –°–∏–ª–∞+—Ç–æ—á–Ω–æ—Å—Ç—å –≤–ª–∏—è—é—Ç –Ω–∞ –≥–æ–ª/—Å–µ–π–≤/–º–∏–º–æ.</div>
        </div>

        <div class="card">
          <div class="row" style="margin:0 0 12px;">
            <div class="pill" style="flex:1; justify-content:space-between;"><span>ü•Ö –ì–æ–ª—ã</span><strong id="penScore">0</strong></div>
            <div class="pill" style="flex:1; justify-content:space-between;"><span>üéØ –£–¥–∞—Ä</span><strong id="penShot">1/5</strong></div>
          </div>

          <div id="penStage" style="position:relative;width:100%;max-width:420px;margin:0 auto 14px;height:240px;border-radius:16px;border:1px solid var(--line);overflow:hidden;background:radial-gradient(600px 260px at 50% 20%, rgba(255,255,255,.10), rgba(255,255,255,0)),linear-gradient(180deg, rgba(140,255,193,.06), rgba(0,0,0,0)),#0b0d12;">
            <div style="position:absolute; inset:0;background-image:linear-gradient(rgba(255,255,255,.08) 1px, transparent 1px),linear-gradient(90deg, rgba(255,255,255,.08) 1px, transparent 1px);background-size:26px 26px;opacity:.35;"></div>

            <div id="keeper" style="position:absolute;top:48px;left:50%;width:42px;height:42px;transform:translateX(-50%);border-radius:14px;background:rgba(255,255,255,.14);border:1px solid rgba(255,255,255,.18);box-shadow:0 10px 24px rgba(0,0,0,.35);"></div>

            <div id="ball" style="position:absolute;left:50%;bottom:18px;width:20px;height:20px;transform:translateX(-50%);border-radius:50%;background:radial-gradient(circle at 30% 30%, #fff, #cfd6e6);box-shadow:0 10px 20px rgba(0,0,0,.35);"></div>

            <div id="penFlash" style="position:absolute; inset:0;background:rgba(140,255,193,.18);opacity:0;transition:opacity .15s ease;"></div>
          </div>

          <div class="row" style="margin-bottom:10px;">
            <button class="btn ghost" onclick="penPick('L')">‚¨ÖÔ∏è –õ–µ–≤–æ</button>
            <button class="btn ghost" onclick="penPick('C')">‚¨ÜÔ∏è –¶–µ–Ω—Ç—Ä</button>
            <button class="btn ghost" onclick="penPick('R')">‚û°Ô∏è –ü—Ä–∞–≤–æ</button>
          </div>

          <button id="penShootBtn" class="btn primary" onclick="penShootStart()">–ë–∏—Ç—å</button>

          <div id="penBarWrap" class="barWrap hidden">
            <div class="muted" style="display:flex;justify-content:space-between;gap:10px;">
              <span>–¢–∞–π–º–∏–Ω–≥ —É–¥–∞—Ä–∞</span>
              <span id="penBarHint">–ø–æ–π–º–∞–π –∑–æ–Ω—É</span>
            </div>
            <div class="bar" id="penBar">
              <div class="ideal" id="penIdeal"></div>
              <div class="needle" id="penNeedle"></div>
            </div>
          </div>

          <div id="penMsg" style="margin-top:12px;text-align:center;font-size:18px;font-weight:900;"></div>
          <div id="penSub" class="muted" style="margin-top:6px;text-align:center;"></div>

          <div class="note">
            –ù–∞–≥—Ä–∞–¥—ã: –≥–æ–ª +2 coins, –ø–æ–±–µ–¥–∞ (3+ –∏–∑ 5) +10 coins –∏ +1 win.
            –¢–∞–π–º–∏–Ω–≥ –≤–ª–∏—è–µ—Ç: –∏–¥–µ–∞–ª ‚Üí —Å–∏–ª—å–Ω–µ–µ/—Ç–æ—á–Ω–µ–µ; –º–∏–º–æ –∑–æ–Ω—ã ‚Üí —Å–ª–∞–±–µ–µ / —Ä–∏—Å–∫ –ø—Ä–æ–º–∞—Ö–∞.
          </div>
          <button style="margin-top:12px;" class="btn ghost" onclick="go('games')">‚Üê –ù–∞–∑–∞–¥</button>
        </div>
      </section>

      <!-- PONG -->
      <section id="page-pong" class="hidden">
        <div class="card" style="margin-bottom:12px;">
          <h2>üèì Ping Pong</h2>
          <div class="muted">–î–≤–∏–≥–∞–π –ø–ª–∞—Ç—Ñ–æ—Ä–º—É. Power-shot: —Ç–∞–ø –ø–æ –ø–æ–ª—é –≤ –º–æ–º–µ–Ω—Ç —É–¥–∞—Ä–∞. –ö–æ–º–±–æ –¥–∞—ë—Ç coins.</div>
        </div>
        <div class="card">
          <div class="row" style="margin:0 0 12px;">
            <div class="pill" style="flex:1; justify-content:space-between;"><span>üôÇ –¢—ã</span><strong id="pongMe">0</strong></div>
            <div class="pill" style="flex:1; justify-content:space-between;"><span>ü§ñ –ë–æ—Ç</span><strong id="pongAi">0</strong></div>
          </div>
          <div class="row" style="margin:0 0 12px;">
            <div class="pill" style="flex:1; justify-content:space-between;"><span>üî• –ö–æ–º–±–æ</span><strong id="pongCombo">0</strong></div>
            <div class="pill" style="flex:1; justify-content:space-between;"><span>‚ö° –°–∫–æ—Ä–æ—Å—Ç—å</span><strong id="pongSpeed">x1.0</strong></div>
          </div>
          <canvas id="pongCanvas" width="420" height="520" style="width:100%;max-width:420px;border:1px solid var(--line);border-radius:16px;background:#0b0d12;display:block;margin:0 auto;"></canvas>
          <div class="row" style="margin-top:12px;">
            <button id="pongStartBtn" class="btn primary" onclick="pongStart()">–°—Ç–∞—Ä—Ç</button>
            <button class="btn ghost" onclick="pongReset()">–°–±—Ä–æ—Å</button>
          </div>
          <button style="margin-top:12px;" class="btn ghost" onclick="pongStop(); go('games')">‚Üê –ù–∞–∑–∞–¥</button>
          <div class="note">–ü–æ–±–µ–¥–∞ (5:?) +15 coins –∏ +1 win. –ö–æ–º–±–æ 3/5/8 ‚Üí +1/+2/+4 coins.</div>
        </div>
      </section>
    </main>
  </div>

  <nav class="nav">
    <button id="tab-games" onclick="go('games')"><div class="icon">üéÆ</div><div>–ò–≥—Ä—ã</div></button>
    <button id="tab-wallet" onclick="go('wallet')"><div class="icon">üí∞</div><div>–ë–∞–ª–∞–Ω—Å</div></button>
    <button id="tab-profile" onclick="go('profile')"><div class="icon">üë§</div><div>–ö–∞–±–∏–Ω–µ—Ç</div></button>
  </nav>

  <div id="toast" class="toast"></div>

<script>
  // Telegram
  const tg = window.Telegram?.WebApp; try{tg?.ready();tg?.expand()}catch(e){}

  // Haptics
  function hImpact(type="light"){ try{ tg?.HapticFeedback?.impactOccurred(type); }catch(e){} }
  function hNote(type="success"){ try{ tg?.HapticFeedback?.notificationOccurred(type); }catch(e){} }
  function hSelect(){ try{ tg?.HapticFeedback?.selectionChanged(); }catch(e){} }

  // Audio (WebAudio beeps)
  let audioUnlocked=false, audioCtx=null;
  function unlockAudio(){
    if(audioUnlocked) return;
    try{
      audioCtx = new (window.AudioContext || window.webkitAudioContext)();
      const o=audioCtx.createOscillator(), g=audioCtx.createGain();
      o.connect(g); g.connect(audioCtx.destination);
      g.gain.value=0.0001; o.start(); o.stop(audioCtx.currentTime+0.01);
      audioUnlocked=true;
    }catch(e){}
  }
  function beep(freq=440,dur=0.08,vol=0.06,type="sine"){
    if(!audioCtx) return;
    const t=audioCtx.currentTime;
    const o=audioCtx.createOscillator(); const g=audioCtx.createGain();
    o.type=type; o.frequency.value=freq;
    g.gain.setValueAtTime(0.0001,t);
    g.gain.exponentialRampToValueAtTime(vol,t+0.01);
    g.gain.exponentialRampToValueAtTime(0.0001,t+dur);
    o.connect(g); g.connect(audioCtx.destination);
    o.start(t); o.stop(t+dur+0.02);
  }
  const sKick=()=>{beep(140,0.06,0.08,"triangle");beep(90,0.08,0.05,"sine");};
  const sGoal=()=>{beep(660,0.08,0.08,"sine");beep(880,0.10,0.08,"sine");};
  const sSave=()=>{beep(220,0.10,0.06,"square");};
  const sMiss=()=>{beep(180,0.14,0.05,"sawtooth");};

  // State
  const storeKey="f1duel_state_v2", defaultState={coins:0,stars:0,wins:0,plays:0};
  const state=(()=>{try{const r=localStorage.getItem(storeKey);return r?{...defaultState,...JSON.parse(r)}:{...defaultState}}catch(e){return {...defaultState}}})();
  const toastEl=document.getElementById("toast"); let toastTimer=null;
  function toast(t){toastEl.textContent=t;toastEl.classList.add("show");clearTimeout(toastTimer);toastTimer=setTimeout(()=>toastEl.classList.remove("show"),1600)}
  function saveState(){localStorage.setItem(storeKey,JSON.stringify(state));renderWallet()}
  function calcLevel(){const score=state.coins+state.stars*50;return Math.max(1,Math.floor(score/200)+1)}
  function renderWallet(){document.getElementById("coinsVal").textContent=state.coins;document.getElementById("starsVal").textContent=state.stars;document.getElementById("winsVal").textContent=state.wins;document.getElementById("playsVal").textContent=state.plays;document.getElementById("levelVal").textContent=calcLevel()}
  function addCoins(n){state.coins=Math.max(0,state.coins+n);saveState()}
  function convertCoinsToStars(){const rate=100;if(state.coins<rate){toast(`–ù—É–∂–Ω–æ –º–∏–Ω–∏–º—É–º ${rate} coins`);return;}const s=Math.floor(state.coins/rate);state.coins-=s*rate;state.stars+=s;saveState();toast(`–û–±–º–µ–Ω: +${s} ‚≠ê`)}
  function resetProgress(){Object.assign(state,{...defaultState});saveState();toast("–ü—Ä–æ–≥—Ä–µ—Å—Å —Å–±—Ä–æ—à–µ–Ω")}

  // Routing
  const pages=["games","wallet","profile","reaction","penalty","pong"];
  function go(page){
    pages.forEach(p=>document.getElementById("page-"+p).classList.toggle("hidden",p!==page));
    ["games","wallet","profile"].forEach(t=>document.getElementById("tab-"+t).classList.toggle("active",t===page));
    if(page==="reaction"||page==="penalty"||page==="pong"){document.getElementById("tab-games").classList.add("active");["wallet","profile"].forEach(t=>document.getElementById("tab-"+t).classList.remove("active"))}
    location.hash="#"+page;
  }
  function openGame(id){ if(id==="reaction")go("reaction"); if(id==="penalty")go("penalty"); if(id==="pong")go("pong"); }

  // Header
  const envChip=document.getElementById("envChip"), userChip=document.getElementById("userChip");
  envChip.textContent=tg?"Telegram WebApp":"Browser";
  const user=tg?.initDataUnsafe?.user;
  if(user){
    const nick=user.username||user.first_name||"Player";
    userChip.textContent="@"+nick;
    document.getElementById("nickVal").textContent=nick;
    document.getElementById("tgidVal").textContent=user.id;
    document.getElementById("profileLine").textContent=`–ü—Ä–∏–≤–µ—Ç, ${nick}.`;
  } else {
    document.getElementById("profileLine").textContent="–û—Ç–∫—Ä–æ–π —á–µ—Ä–µ–∑ Telegram, —á—Ç–æ–±—ã –ø–æ–¥—Ç—è–Ω—É–ª—Å—è –ø—Ä–æ—Ñ–∏–ª—å.";
  }

  // REACTION
  const light=document.getElementById("light"), startBtn=document.getElementById("startBtn"), result=document.getElementById("result");
  let startTime=0, waiting=false, timer=null;
  function setLight(c){light.style.background=c;light.style.boxShadow=(c==="lime")?"0 0 30px lime":"0 0 20px red";}
  startBtn.onclick=()=>{unlockAudio();hImpact("light");
    if(waiting)return; result.textContent=""; setLight("red"); waiting=true; startBtn.textContent="–ñ–î–ò‚Ä¶";
    timer=setTimeout(()=>{setLight("lime");startTime=Date.now();hImpact("medium");beep(520,0.06,0.05,"sine");}, 2000+Math.random()*3000);
  };
  light.onclick=()=>{unlockAudio();
    if(!waiting)return;
    if(!startTime){clearTimeout(timer); result.textContent="‚ùå –§–∞–ª—å—Å—Ç–∞—Ä—Ç! ‚àí2 coins"; addCoins(-2); toast("–§–∞–ª—å—Å—Ç–∞—Ä—Ç ‚àí2"); hNote("error"); sMiss(); waiting=false; startTime=0; startBtn.textContent="–ï—â—ë —Ä–∞–∑"; return;}
    const r=Date.now()-startTime; state.plays+=1; let reward=5; if(r<250)reward+=3;
    addCoins(reward); saveState();
    result.textContent=`‚ö° ${r} –º—Å  ‚Ä¢  +${reward} coins`; toast(`+${reward} coins`); hNote("success"); sGoal();
    waiting=false; startTime=0; startBtn.textContent="–ï—â—ë —Ä–∞–∑";
  };

  // PENALTY FIFA-ish
  const penScoreEl=document.getElementById("penScore"), penShotEl=document.getElementById("penShot");
  const penMsgEl=document.getElementById("penMsg"), penSubEl=document.getElementById("penSub");
  const penStage=document.getElementById("penStage"), ballEl=document.getElementById("ball"), keeperEl=document.getElementById("keeper"), flashEl=document.getElementById("penFlash");
  const penBarWrap=document.getElementById("penBarWrap"), penBar=document.getElementById("penBar"), penIdeal=document.getElementById("penIdeal"), penNeedle=document.getElementById("penNeedle");
  const penShootBtn=document.getElementById("penShootBtn");

  let penShot=1, penGoals=0, penActive=true;
  let penDir=null; // L/C/R
  let barOn=false, barT=0, barV=0, barId=null; // 0..1
  let idealA=0.42, idealB=0.58; // ideal window
  let pressure=0; // grows when missing
  let penLocked=false;

  function penRender(){
    penScoreEl.textContent=penGoals;
    penShotEl.textContent=`${Math.min(penShot,5)}/5`;
  }
  function penResetAnim(){
    ballEl.style.animation=""; ballEl.style.transform="translateX(-50%)";
    keeperEl.style.animation=""; keeperEl.style.transform="translateX(-50%)";
    penStage.classList.remove("shake");
  }
  function penNewIdeal(){
    // ideal window shifts; pressure makes it smaller
    const size = Math.max(0.08, 0.16 - pressure*0.02);
    const center = 0.30 + Math.random()*0.40;
    idealA = center - size/2;
    idealB = center + size/2;
    penIdeal.style.left = (idealA*100)+"%";
    penIdeal.style.width = ((idealB-idealA)*100)+"%";
  }
  function penPick(d){
    unlockAudio(); hSelect();
    if(penLocked) return;
    penDir=d;
    penMsgEl.textContent = d==="L"?"‚¨ÖÔ∏è –õ–µ–≤–æ":d==="C"?"‚¨ÜÔ∏è –¶–µ–Ω—Ç—Ä":"‚û°Ô∏è –ü—Ä–∞–≤–æ";
    penSubEl.textContent = "–ù–∞–∂–º–∏ ¬´–ë–∏—Ç—å¬ª, –∑–∞—Ç–µ–º –æ—Å—Ç–∞–Ω–æ–≤–∏ —à–∫–∞–ª—É –≤ –∑–µ–ª—ë–Ω–æ–π –∑–æ–Ω–µ.";
  }

  function penShootStart(){
    unlockAudio();
    if(penLocked) return;
    if(!penDir){ toast("–°–Ω–∞—á–∞–ª–∞ –≤—ã–±–µ—Ä–∏ –Ω–∞–ø—Ä–∞–≤–ª–µ–Ω–∏–µ"); hNote("error"); sMiss(); return; }
    // start timing bar
    penLocked=true;
    penShootBtn.textContent="–°–¢–û–ü (—Ç–∞–π–º–∏–Ω–≥)";
    penBarWrap.classList.remove("hidden");
    penNewIdeal();
    barOn=true; barT=0; barV=0;
    penMsgEl.textContent="–¢–ê–ô–ú–ò–ù–ì!";
    penSubEl.textContent="–û—Å—Ç–∞–Ω–æ–≤–∏ —Å—Ç—Ä–µ–ª–∫—É –≤ –∑–µ–ª—ë–Ω–æ–π –∑–æ–Ω–µ";
    hImpact("medium"); beep(420,0.06,0.05,"sine");

    const speed = () => 1.8 + pressure*0.18; // more pressure faster bar
    const tick=(ts)=>{
      if(!barOn) return;
      if(!barId) barId = ts;
      const dt = (ts - barId)/1000;
      barId = ts;
      barT += dt * speed();
      // ping-pong needle
      barV = 0.5 + 0.5*Math.sin(barT*2.2*Math.PI);
      penNeedle.style.left = (barV*100)+"%";
      requestAnimationFrame(tick);
    };
    requestAnimationFrame(tick);

    // second click/tap on button stops and shoots
    penShootBtn.onclick = penShootStop;
  }

  function penShootStop(){
    unlockAudio();
    if(!barOn) return;
    barOn=false;
    penShootBtn.onclick = penShootStart; // restore handler later
    penShootBtn.textContent="–ë–∏—Ç—å";
    penBarWrap.classList.add("hidden");

    // compute "quality"
    const inIdeal = (barV >= idealA && barV <= idealB);
    const dist = inIdeal ? 0 : Math.min(Math.abs(barV-idealA), Math.abs(barV-idealB)); // 0.. ~0.5
    // power: closer to center of ideal => stronger and more accurate
    const idealCenter = (idealA+idealB)/2;
    const centerDist = Math.abs(barV - idealCenter); // 0..0.5
    let power = 1.0 - clamp(centerDist*2.2, 0, 1); // 0..1
    power = clamp(power + (inIdeal?0.15: -dist*1.2), 0, 1);

    // keeper chooses (slightly biased to center when low power)
    const keeper = chooseKeeper(power);
    animatePenalty(penDir, keeper);

    // determine outcome:
    // miss chance rises if out of ideal AND high power
    const missChance = clamp((inIdeal?0:0.18 + dist*1.2) + (power>0.82?0.10:0), 0, 0.55);
    const rnd = Math.random();

    // save chance depends on keeper direction + power (stronger harder to save)
    let saved = false, missed = false;
    if(rnd < missChance){
      missed = true;
    } else {
      const sameDir = keeper === penDir;
      const saveChance = clamp((sameDir?0.58:0.18) - power*0.35, 0.06, 0.72);
      saved = Math.random() < saveChance;
    }

    // finalize a bit later to match animation
    setTimeout(()=>{
      if(missed){
        pressure = clamp(pressure+1, 0, 5);
        penStage.classList.add("shake");
        penMsgEl.textContent = "‚ùå –ú–ò–ú–û!";
        penSubEl.textContent = `–¢–∞–π–º–∏–Ω–≥: ${inIdeal?"–∏–¥–µ–∞–ª":"–º–∏–º–æ –∑–æ–Ω—ã"} ‚Ä¢ —Å–∏–ª–∞: ${Math.round(power*100)}%`;
        hNote("error"); sMiss();
      } else if(saved){
        pressure = clamp(pressure+1, 0, 5);
        penMsgEl.textContent = "üß§ –°–ï–ô–í!";
        penSubEl.textContent = `–í—Ä–∞—Ç–∞—Ä—å —É–≥–∞–¥–∞–ª: ${dirText(keeper)} ‚Ä¢ —Å–∏–ª–∞: ${Math.round(power*100)}%`;
        hNote("error"); sSave();
      } else {
        pressure = clamp(pressure-1, 0, 5);
        penGoals += 1;
        addCoins(2);
        penMsgEl.textContent = "‚öΩÔ∏è –ì–û–û–û–õ! +2 coins";
        penSubEl.textContent = `–¢–∞–π–º–∏–Ω–≥: ${inIdeal?"–∏–¥–µ–∞–ª":"–Ω–æ—Ä–º"} ‚Ä¢ —Å–∏–ª–∞: ${Math.round(power*100)}%`;
        hNote("success"); sGoal();
      }

      penShot += 1;
      penRender();

      // end series
      if(penShot === 6){
        penActive=false;
        state.plays += 1;
        if(penGoals >= 3){
          state.wins += 1;
          addCoins(10);
          penMsgEl.textContent = `üèÜ –ü–æ–±–µ–¥–∞! ${penGoals}/5 ‚Ä¢ +10 coins`;
          penSubEl.textContent = "–•–æ—Ä–æ—à–∞—è —Å–µ—Ä–∏—è.";
          hNote("success"); sGoal();
        } else {
          penMsgEl.textContent = `–°–µ—Ä–∏—è –æ–∫–æ–Ω—á–µ–Ω–∞: ${penGoals}/5`;
          penSubEl.textContent = "–ü–æ–ø—Ä–æ–±—É–π –µ—â—ë —Ä–∞–∑.";
        }
        saveState();
      }

      // reset per-shot
      setTimeout(()=>{
        penResetAnim();
        penLocked=false;
        penDir=null;
        flashEl.style.opacity="0";
        if(!penActive){
          // lock shooting if finished
          penShootBtn.disabled = true;
          penShootBtn.classList.add("ghost");
          penShootBtn.classList.remove("primary");
          penShootBtn.textContent = "–°–µ—Ä–∏—è –∑–∞–≤–µ—Ä—à–µ–Ω–∞";
        }
      }, 280);
    }, 220);
  }

  function animatePenalty(dir, keeper){
    penResetAnim();
    void ballEl.offsetWidth;
    const animBall = dir==="L" ? "kickToLeft" : dir==="C" ? "kickToCenter" : "kickToRight";
    const animKeeper = keeper==="L" ? "keeperLeft" : keeper==="C" ? "keeperCenter" : "keeperRight";
    ballEl.style.animation = `${animBall} .34s ease-out forwards`;
    keeperEl.style.animation = `${animKeeper} .30s ease-out forwards`;
    hImpact("medium"); sKick();

    flashEl.style.background = "rgba(140,255,193,.18)";
    flashEl.style.opacity = "1";
    setTimeout(()=>flashEl.style.opacity="0", 120);
  }

  function chooseKeeper(power){
    // lower power => keeper more central; higher => more random
    const r = Math.random();
    const biasCenter = clamp(0.46 - power*0.22, 0.18, 0.48);
    if(r < biasCenter) return "C";
    return (Math.random()<0.5) ? "L" : "R";
  }
  function dirText(d){ return d==="L"?"–ª–µ–≤–æ":d==="C"?"—Ü–µ–Ω—Ç—Ä":"–ø—Ä–∞–≤–æ"; }
  function clamp(v,min,max){ return Math.max(min,Math.min(max,v)); }

  // PONG (tasty)
  const canvas=document.getElementById("pongCanvas"), ctx=canvas.getContext("2d");
  const pongMeEl=document.getElementById("pongMe"), pongAiEl=document.getElementById("pongAi"), pongComboEl=document.getElementById("pongCombo"), pongSpeedEl=document.getElementById("pongSpeed"), pongStartBtn=document.getElementById("pongStartBtn");
  let pongRunning=false, rafId=null;
  const W=canvas.width, H=canvas.height;
  const paddle={w:96,h:12,x:W/2-48,y:H-28}, aiPaddle={w:96,h:12,x:W/2-48,y:16};
  const ball={r:7,x:W/2,y:H/2,vx:3.2,vy:3.6};
  let meScore=0, aiScore=0, speedMult=1.0, rally=0, powerUntil=0, lastHitByPlayer=false;

  function collideRectCircle(px,py,pw,ph,cx,cy,cr){
    const closestX=clamp(cx,px,px+pw), closestY=clamp(cy,py,py+ph);
    const dx=cx-closestX, dy=cy-closestY; return (dx*dx+dy*dy)<=cr*cr;
  }
  function pongHud(){pongMeEl.textContent=meScore;pongAiEl.textContent=aiScore;pongComboEl.textContent=rally;pongSpeedEl.textContent="x"+speedMult.toFixed(1)}
  function pongResetBall(towardsPlayer){
    ball.x=W/2; ball.y=H/2; speedMult=1.0; rally=0; lastHitByPlayer=false;
    const base=3.0+Math.random()*1.0;
    ball.vx=(Math.random()>.5?1:-1)*base;
    ball.vy=(towardsPlayer?1:-1)*(3.2+Math.random()*1.2);
    pongHud();
  }
  function pongReset(){
    pongStop(); meScore=0; aiScore=0;
    paddle.x=W/2-paddle.w/2; aiPaddle.x=W/2-aiPaddle.w/2;
    pongResetBall(true);
    pongStartBtn.textContent="–°—Ç–∞—Ä—Ç";
    pongHud(); drawPong();
  }
  function pongStart(){unlockAudio(); if(pongRunning)return; pongRunning=true; pongStartBtn.textContent="–ò–¥—ë—Ç‚Ä¶"; toast("–ü–æ–µ—Ö–∞–ª–∏!"); loop(); }
  function pongStop(){pongRunning=false; if(rafId)cancelAnimationFrame(rafId); rafId=null;}
  function comboBonus(){
    let b=0; if(rally===3)b=1; if(rally===5)b=2; if(rally===8)b=4;
    if(b){addCoins(b); toast(`–ö–æ–º–±–æ ${rally}! +${b} coins`); hNote("success"); beep(740,0.06,0.05,"sine")}
  }
  function aiSpeed(){
    const base=2.8, scoreBoost=(aiScore+meScore)*0.12, speedBoost=(speedMult-1.0)*0.9;
    return clamp(base+scoreBoost+speedBoost,2.8,5.6);
  }
  function drawPong(){
    ctx.clearRect(0,0,W,H);
    ctx.fillStyle="#0b0d12"; ctx.fillRect(0,0,W,H);
    ctx.globalAlpha=.35; ctx.fillStyle="#fff";
    for(let y=0;y<H;y+=18) ctx.fillRect(W/2-2,y,4,10);
    ctx.globalAlpha=1;
    ctx.fillStyle="#8cffc1"; ctx.fillRect(paddle.x,paddle.y,paddle.w,paddle.h);
    ctx.fillStyle="#9aa3b2"; ctx.fillRect(aiPaddle.x,aiPaddle.y,aiPaddle.w,aiPaddle.h);
    const now=performance.now(), powerActive=now<powerUntil;
    if(powerActive){ctx.globalAlpha=.18;ctx.fillStyle="#8cffc1";ctx.fillRect(0,H-90,W,90);ctx.globalAlpha=1;}
    ctx.beginPath(); ctx.arc(ball.x,ball.y,ball.r,0,Math.PI*2);
    ctx.fillStyle=powerActive?"#8cffc1":"#fff"; ctx.fill();
    ctx.globalAlpha=.9; ctx.font="800 16px system-ui"; ctx.fillStyle="#fff";
    ctx.fillText(`x${speedMult.toFixed(1)}  üî•${rally}`, W-92, 26);
    ctx.globalAlpha=1;
  }
  function endPong(){
    pongStop(); state.plays+=1;
    if(meScore>=5){state.wins+=1; addCoins(15); saveState(); toast("üèÜ –ü–æ–±–µ–¥–∞! +15 coins"); hNote("success"); sGoal()}
    else{saveState(); toast("–ü–æ—Ä–∞–∂–µ–Ω–∏–µ üòÑ"); hNote("error"); sMiss()}
    pongStartBtn.textContent="–°—ã–≥—Ä–∞—Ç—å –µ—â—ë";
  }
  function loop(){
    if(!pongRunning) return;
    const target=ball.x-aiPaddle.w/2, s=aiSpeed();
    aiPaddle.x += clamp(target-aiPaddle.x, -s, s);
    aiPaddle.x = clamp(aiPaddle.x, 0, W-aiPaddle.w);

    ball.x += ball.vx*speedMult;
    ball.y += ball.vy*speedMult;

    if(ball.x-ball.r<=0 || ball.x+ball.r>=W){ ball.vx*=-1; ball.x=clamp(ball.x, ball.r, W-ball.r); }

    if(ball.vy>0 && collideRectCircle(paddle.x,paddle.y,paddle.w,paddle.h,ball.x,ball.y,ball.r)){
      ball.vy*=-1;
      const hit=(ball.x-(paddle.x+paddle.w/2))/(paddle.w/2);
      ball.vx += hit*1.25;
      speedMult = clamp(speedMult + 0.06, 1.0, 2.1);
      rally += 1; lastHitByPlayer=true; comboBonus();

      const now=performance.now();
      if(now<powerUntil){
        ball.vx += hit*1.8;
        speedMult = clamp(speedMult + 0.18, 1.0, 2.4);
        hImpact("medium"); beep(520,0.06,0.06,"triangle");
        toast("‚ö° Power-shot!");
        powerUntil=0;
      } else {
        hImpact("light");
      }
      ball.vx = clamp(ball.vx, -6.2, 6.2);
      pongHud();
    }

    if(ball.vy<0 && collideRectCircle(aiPaddle.x,aiPaddle.y,aiPaddle.w,aiPaddle.h,ball.x,ball.y,ball.r)){
      ball.vy*=-1;
      const hit=(ball.x-(aiPaddle.x+aiPaddle.w/2))/(aiPaddle.w/2);
      ball.vx += hit*0.8;
      speedMult = clamp(speedMult + 0.03, 1.0, 2.2);
      if(lastHitByPlayer) lastHitByPlayer=false;
      ball.vx = clamp(ball.vx, -6.2, 6.2);
      pongHud();
    }

    if(ball.y-ball.r<=0){ meScore += 1; toast("–û—á–∫–æ —Ç–µ–±–µ!"); beep(740,0.05,0.05,"sine"); pongResetBall(false); }
    if(ball.y+ball.r>=H){ aiScore += 1; toast("–û—á–∫–æ –±–æ—Ç—É"); beep(190,0.08,0.05,"square"); pongResetBall(true); }
    pongHud();

    if(meScore>=5 || aiScore>=5){ endPong(); drawPong(); return; }

    drawPong();
    rafId = requestAnimationFrame(loop);
  }

  function setPaddleFromClientX(clientX){
    const rect=canvas.getBoundingClientRect();
    const x=(clientX-rect.left)*(W/rect.width);
    paddle.x=clamp(x-paddle.w/2,0,W-paddle.w);
  }
  canvas.addEventListener("mousemove",(e)=>setPaddleFromClientX(e.clientX));
  canvas.addEventListener("touchmove",(e)=>{e.preventDefault();setPaddleFromClientX(e.touches[0].clientX)},{passive:false});
  function triggerPower(){ if(!pongRunning) return; powerUntil=performance.now()+220; hImpact("light"); }
  canvas.addEventListener("mousedown",()=>{unlockAudio();triggerPower();});
  canvas.addEventListener("touchstart",(e)=>{e.preventDefault();unlockAudio();triggerPower();},{passive:false});

  // Boot
  renderWallet(); penRender(); pongReset();
  const initial=(location.hash||"#games").slice(1); go(pages.includes(initial)?initial:"games");
</script>
</body>
</html>


