<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>F1 Duel</title>
  <script src="https://telegram.org/js/telegram-web-app.js"></script>
  <style>
    :root{
      --bg1:#0E0F13; --bg2:#121624;

      --glass-bg: rgba(255,255,255,.06);
      --glass-border: rgba(255,255,255,.10);
      --glass-bg-strong: rgba(255,255,255,.08);
      --blur: 16px;

      --text:#fff;
      --text2: rgba(255,255,255,.68);
      --muted: rgba(255,255,255,.46);

      --accent:#8CFFC1;
      --accent-soft: rgba(140,255,193,.18);
      --accent-glow: rgba(140,255,193,.45);

      --danger:#FF7A7A;
      --danger-soft: rgba(255,92,92,.18);

      --shadow: 0 20px 40px rgba(0,0,0,.40);
      --r: 22px;
    }

    html,body{
      margin:0; height:100%;
      background: linear-gradient(180deg, var(--bg1), var(--bg2));
      color:var(--text);
      font-family: system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif;
      -webkit-user-select:none; user-select:none;
      -webkit-touch-callout:none;
      overscroll-behavior:none;
    }
    *{box-sizing:border-box; -webkit-tap-highlight-color:transparent}
    a{color:inherit}

    body:before{
      content:"";
      position:fixed; inset:0; pointer-events:none;
      background-image:url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='140' height='140'%3E%3Cfilter id='n'%3E%3CfeTurbulence type='fractalNoise' baseFrequency='.8' numOctaves='3' stitchTiles='stitch'/%3E%3C/filter%3E%3Crect width='140' height='140' filter='url(%23n)' opacity='.18'/%3E%3C/svg%3E");
      opacity:.22;
      mix-blend-mode: overlay;
    }

    .app{min-height:100vh; padding-bottom:86px}
    .topbar{
      position:sticky; top:0; z-index:20;
      padding:14px 16px;
      display:flex; align-items:center; justify-content:space-between; gap:12px;
      background: rgba(10,12,18,.45);
      backdrop-filter: blur(18px);
      border-bottom:1px solid rgba(255,255,255,.07);
    }
    .brand{display:flex; align-items:center; gap:10px; font-weight:900; letter-spacing:.2px}
    .chip{
      font-size:12px; padding:7px 10px; border-radius:999px;
      background: var(--glass-bg); border:1px solid var(--glass-border);
      backdrop-filter: blur(var(--blur));
      color:var(--text2);
      white-space:nowrap;
    }
    .container{padding:16px}
    .row{display:flex; gap:12px; flex-wrap:wrap}
    .glass{
      background: var(--glass-bg);
      border:1px solid var(--glass-border);
      backdrop-filter: blur(var(--blur));
      border-radius: var(--r);
      box-shadow: var(--shadow);
    }
    .card{padding:14px}
    .card h2{margin:0 0 8px 0; font-size:16px; letter-spacing:.2px}
    .muted{color:var(--muted); line-height:1.35}
    .text2{color:var(--text2)}
    .divider{height:1px; background: rgba(255,255,255,.08); margin:12px 0}

    .btn{
      width:100%;
      border:none; cursor:pointer;
      padding:12px 14px;
      border-radius:14px;
      font-weight:900;
      font-size:15px;
      transition: transform .12s ease, opacity .12s ease;
    }
    .btn:active{transform: scale(.98)}
    .btn.primary{background: linear-gradient(135deg, #8CFFC1, #4DFF9A); color:#07110c; box-shadow: 0 0 18px rgba(140,255,193,.25)}
    .btn.ghost{
      background: var(--glass-bg-strong);
      border:1px solid var(--glass-border);
      color:var(--text);
      backdrop-filter: blur(var(--blur));
    }
    .btn.danger{
      background: var(--danger-soft);
      border:1px solid rgba(255,92,92,.30);
      color: var(--danger);
      backdrop-filter: blur(var(--blur));
    }
    .btn[disabled]{opacity:.45; cursor:not-allowed; transform:none !important}

    .nav{
      position:fixed; left:0; right:0; bottom:0; height:72px;
      padding:10px 10px 14px;
      display:flex; gap:10px;
      background: rgba(10,12,18,.45);
      backdrop-filter: blur(18px);
      border-top:1px solid rgba(255,255,255,.07);
      z-index:25;
    }
    .nav button{
      flex:1;
      border:none; cursor:pointer;
      border-radius:16px;
      background: transparent;
      color: var(--muted);
      padding:10px 8px;
      display:flex; flex-direction:column; align-items:center; justify-content:center; gap:6px;
      font-size:12px;
    }
    .nav button.active{
      background: rgba(140,255,193,.10);
      border:1px solid rgba(140,255,193,.22);
      color: var(--text);
    }
    .icon{font-size:18px; line-height:1}
    .hidden{display:none!important}

    .toast{
      position:fixed; left:50%; bottom:86px; transform:translateX(-50%);
      max-width:92vw; text-align:center;
      padding:10px 12px; border-radius:14px;
      background: rgba(0,0,0,.65);
      border:1px solid rgba(255,255,255,.12);
      box-shadow: var(--shadow);
      opacity:0; pointer-events:none;
      transition: opacity .16s ease;
      z-index:99;
      font-size:13px;
    }
    .toast.show{opacity:1}

    .modalWrap{
      position:fixed; inset:0; z-index:100;
      display:none;
      align-items:center; justify-content:center;
      padding:16px;
      background: rgba(0,0,0,.55);
      backdrop-filter: blur(10px);
    }
    .modalWrap.show{display:flex}
    .modal{
      width:min(520px, 100%);
      padding:16px;
      border-radius:24px;
      background: rgba(20,24,36,.55);
      border:1px solid rgba(255,255,255,.10);
      box-shadow: 0 30px 70px rgba(0,0,0,.55);
      backdrop-filter: blur(18px);
    }
    .modal h3{margin:0 0 6px 0}
    .modal .muted{font-size:13px}

    .field{
      width:100%;
      padding:12px 14px;
      border-radius:14px;
      background: rgba(255,255,255,.06);
      border:1px solid rgba(255,255,255,.12);
      color: var(--text);
      outline:none;
      font-size:15px;
    }
    .field::placeholder{color: rgba(255,255,255,.35)}
    .checkboxRow{display:flex; gap:10px; align-items:flex-start}
    .checkboxRow input{margin-top:3px}

    .onlineBadge{
      display:flex; align-items:center; gap:8px;
      padding:10px 12px;
      border-radius: 16px;
      background: rgba(255,255,255,.06);
      border:1px solid rgba(255,255,255,.10);
      backdrop-filter: blur(16px);
    }
    .dot{
      width:9px; height:9px; border-radius:50%;
      background: #3DFF9E;
      box-shadow: 0 0 12px rgba(61,255,158,.60);
      flex:0 0 auto;
    }
    .bigNumber{font-weight:950; letter-spacing:.2px}
    .small{font-size:12px; color:var(--muted)}
    .titleXL{font-size:22px; font-weight:950; letter-spacing:.2px; margin:0 0 2px 0}
    .subtitle{color:var(--text2); margin:0; font-size:13px}

    .pill{
      display:flex; align-items:center; justify-content:space-between; gap:10px;
      padding:10px 12px;
      border-radius:16px;
      background: var(--glass-bg-strong);
      border:1px solid var(--glass-border);
      backdrop-filter: blur(var(--blur));
    }

    /* Game surface blocks */
    .gameSurface{
      border-radius: 22px;
      background: rgba(255,255,255,.04);
      border:1px solid rgba(255,255,255,.10);
      backdrop-filter: blur(10px);
      overflow:hidden;
    }
    .center{
      display:flex; align-items:center; justify-content:center; text-align:center;
    }
    .big{
      font-size:34px; font-weight:1000; letter-spacing:.2px;
    }
    .hint{color:var(--text2); font-size:13px; line-height:1.35}
    canvas{display:block; width:100%; height:auto; touch-action:none;}
  </style>
</head>
<body>
  <div class="app">
    <div class="topbar">
      <div class="brand">
        <span>üèÅ F1 Duel</span>
        <span id="envChip" class="chip">WebApp</span>
      </div>
      <div class="chip" id="userChip">–ì–æ—Å—Ç—å</div>
    </div>

    <main class="container">

      <!-- ONBOARDING: Rules -->
      <section id="page-onb-rules" class="hidden">
        <div class="glass card">
          <h2 class="titleXL">–ü—Ä–∞–≤–∏–ª–∞ –¥—É—ç–ª–µ–π</h2>
          <p class="subtitle">–ü–æ–∫–∞–∂–µ–º –æ–¥–∏–Ω —Ä–∞–∑ –ø—Ä–∏ —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏</p>
          <div class="divider"></div>
          <div class="muted" style="font-size:14px">
            ‚Ä¢ –ú–∞—Ç—á–∏ –Ω–∞—á–∏–Ω–∞—é—Ç—Å—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –ø–æ—Å–ª–µ –ø–æ–¥–±–æ—Ä–∞ —Å–æ–ø–µ—Ä–Ω–∏–∫–∞;<br>
            ‚Ä¢ –°—Ç–∞–≤–∫–∞ –±–ª–æ–∫–∏—Ä—É–µ—Ç—Å—è –Ω–∞ –≤—Ä–µ–º—è –º–∞—Ç—á–∞;<br>
            ‚Ä¢ –ü–æ–±–µ–¥–∏—Ç–µ–ª—å –ø–æ–ª—É—á–∞–µ—Ç –≤—ã–ø–ª–∞—Ç—É (–∫–æ–º–∏—Å—Å–∏—è —É–∂–µ —É—á—Ç–µ–Ω–∞);<br>
            ‚Ä¢ –í—ã—Ö–æ–¥ –∏–ª–∏ —Å–¥–∞—á–∞ —Å—á–∏—Ç–∞—é—Ç—Å—è –ø–æ—Ä–∞–∂–µ–Ω–∏–µ–º;<br>
            ‚Ä¢ –ü—Ä–∏ –≤—ã—Ö–æ–¥–µ –º–æ–∂–µ—Ç –ø—Ä–∏–º–µ–Ω—è—Ç—å—Å—è —à—Ç—Ä–∞—Ñ;<br>
            ‚Ä¢ –ß–µ—Å—Ç–Ω–∞—è –∏–≥—Ä–∞ ‚Äî –±–µ–∑ –Ω–∞–º–µ—Ä–µ–Ω–Ω—ã—Ö –≤—ã—Ö–æ–¥–æ–≤.
          </div>

          <div class="divider"></div>

          <div class="checkboxRow">
            <input id="rulesCheck" type="checkbox"/>
            <div>
              <div style="font-weight:800">–Ø –ø—Ä–∏–Ω–∏–º–∞—é –ø—Ä–∞–≤–∏–ª–∞</div>
              <div class="small">–ë–µ–∑ —Å–æ–≥–ª–∞—Å–∏—è –Ω–µ–ª—å–∑—è –ø–æ–ª—å–∑–æ–≤–∞—Ç—å—Å—è —Å–µ—Ä–≤–∏—Å–æ–º</div>
            </div>
          </div>

          <div style="margin-top:14px">
            <button id="rulesContinue" class="btn primary" disabled>–ü—Ä–æ–¥–æ–ª–∂–∏—Ç—å</button>
          </div>
        </div>
      </section>

      <!-- ONBOARDING: Nickname -->
      <section id="page-onb-nick" class="hidden">
        <div class="glass card">
          <h2 class="titleXL">–í—ã–±–µ—Ä–∏ –Ω–∏–∫</h2>
          <p class="subtitle">–ï–≥–æ –±—É–¥—É—Ç –≤–∏–¥–µ—Ç—å –¥—Ä—É–≥–∏–µ –∏–≥—Ä–æ–∫–∏ (–Ω–µ Telegram username)</p>
          <div class="divider"></div>

          <input id="nickInput" class="field" placeholder="–ù–∞–ø—Ä–∏–º–µ—Ä: NightFox" maxlength="16" />

          <div class="small" style="margin-top:10px">
            3‚Äì16 —Å–∏–º–≤–æ–ª–æ–≤ ‚Ä¢ –ª–∞—Ç–∏–Ω–∏—Ü–∞/—Ü–∏—Ñ—Ä—ã/_ ‚Ä¢ –±–µ–∑ –ø—Ä–æ–±–µ–ª–æ–≤
          </div>

          <div style="margin-top:14px" class="row">
            <button id="nickSave" class="btn primary">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
            <button id="nickSkip" class="btn ghost">–ü—Ä–æ–ø—É—Å—Ç–∏—Ç—å</button>
          </div>

          <div class="note small" id="nickError" style="margin-top:10px; color: var(--danger); display:none"></div>
        </div>
      </section>

      <!-- ONBOARDING: Referral -->
      <section id="page-onb-ref" class="hidden">
        <div class="glass card">
          <h2 class="titleXL">–ï—Å—Ç—å –∫–æ–¥ –ø—Ä–∏–≥–ª–∞—à–µ–Ω–∏—è?</h2>
          <p class="subtitle">–ï—Å–ª–∏ –¥—Ä—É–≥ –ø–æ–¥–µ–ª–∏–ª—Å—è –∫–æ–¥–æ–º ‚Äî –≤–≤–µ–¥–∏ –µ–≥–æ —Å–µ–π—á–∞—Å (–æ–¥–∏–Ω —Ä–∞–∑)</p>
          <div class="divider"></div>

          <input id="refInput" class="field" placeholder="–ö–æ–¥ (–Ω–µ–æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ)" maxlength="10" />

          <div class="small" style="margin-top:10px">
            –ó–∞ –ø—Ä–∏–≥–ª–∞—à—ë–Ω–Ω–æ–≥–æ –¥—Ä—É–≥–∞ –ø—Ä–∏–≥–ª–∞—Å–∏–≤—à–∏–π –ø–æ–ª—É—á–∞–µ—Ç <b>+100 coins</b> (–ø–æ—Å–ª–µ –ø–µ—Ä–≤–æ–π –¥—É—ç–ª–∏ –ø—Ä–∏–≥–ª–∞—à—ë–Ω–Ω–æ–≥–æ).
          </div>

          <div style="margin-top:14px" class="row">
            <button id="refApply" class="btn primary">–ü—Ä–∏–º–µ–Ω–∏—Ç—å</button>
            <button id="refSkip" class="btn ghost">–ü—Ä–æ–ø—É—Å—Ç–∏—Ç—å</button>
          </div>

          <div class="note small" id="refError" style="margin-top:10px; color: var(--danger); display:none"></div>
        </div>
      </section>

      <!-- HOME / GAMES -->
      <section id="page-games" class="hidden">
        <div class="glass card" style="margin-bottom:12px;">
          <div class="row" style="align-items:center; justify-content:space-between;">
            <div>
              <div class="titleXL" style="margin:0">–ò–≥—Ä—ã</div>
              <div class="subtitle">–í—ã–±–µ—Ä–∏ –∏–≥—Ä—É –∏ —Ç—Ä–µ–Ω–∏—Ä—É–π—Å—è</div>
            </div>
            <div class="onlineBadge">
              <div class="dot"></div>
              <div>
                <div class="small">–û–Ω–ª–∞–π–Ω —Å–µ–π—á–∞—Å</div>
                <div class="bigNumber" id="onlineNow">‚Äî</div>
              </div>
            </div>
          </div>
        </div>

        <!-- Reaction game -->
        <div class="glass card" style="margin-bottom:12px;">
          <h2>‚ö° –†–µ–∞–∫—Ü–∏—è</h2>
          <div class="muted">–ñ–¥–∏ ‚ÄúGO‚Äù –∏ —Ç–∞–ø–Ω–∏ –∫–∞–∫ –º–æ–∂–Ω–æ –±—ã—Å—Ç—Ä–µ–µ. –°–æ—Ö—Ä–∞–Ω—è–µ–º —Ä–µ–∫–æ—Ä–¥.</div>
          <div class="divider"></div>
          <div class="row">
            <div class="pill" style="flex:1">
              <span class="text2">–õ—É—á—à–µ–µ</span>
              <strong id="reactBest">‚Äî</strong>
            </div>
            <div class="pill" style="flex:1">
              <span class="text2">–ü–æ—Å–ª–µ–¥–Ω–µ–µ</span>
              <strong id="reactLast">‚Äî</strong>
            </div>
          </div>
          <div style="margin-top:14px">
            <button class="btn primary" id="openReaction">–ò–≥—Ä–∞—Ç—å</button>
          </div>
        </div>

        <!-- Pong game -->
        <div class="glass card" style="margin-bottom:12px;">
          <h2>üèì –ü–∏–Ω–≥-–ø–æ–Ω–≥</h2>
          <div class="muted">–ö–ª–∞—Å—Å–∏—á–µ—Å–∫–∏–π Pong. –£–ø—Ä–∞–≤–ª—è–π —Ä–∞–∫–µ—Ç–∫–æ–π –ø–∞–ª—å—Ü–µ–º. –ë–æ—Ç —É–º–Ω–µ–µ—Ç –∏ —É—Å–∫–æ—Ä—è–µ—Ç—Å—è.</div>
          <div class="divider"></div>
          <div class="row">
            <div class="pill" style="flex:1">
              <span class="text2">–†–µ–∑—É–ª—å—Ç–∞—Ç</span>
              <strong id="pongScore">0 : 0</strong>
            </div>
            <div class="pill" style="flex:1">
              <span class="text2">–î–æ –ø–æ–±–µ–¥—ã</span>
              <strong id="pongToWin">5</strong>
            </div>
          </div>
          <div style="margin-top:14px">
            <button class="btn primary" id="openPong">–ò–≥—Ä–∞—Ç—å</button>
          </div>
        </div>

        <!-- Frog Hunt PvP -->
        <div class="glass card" style="margin-bottom:12px;">
          <h2>üê∏ –û—Ö–æ—Ç–∞ –Ω–∞ –∂–∞–±—É</h2>
          <div class="muted">PvP: –æ–¥–∏–Ω –ø—Ä—è—á–µ—Ç –∂–∞–±—É –Ω–∞ –∫—É–≤—à–∏–Ω–∫–∞—Ö, –¥—Ä—É–≥–æ–π —Å—Ç—Ä–µ–ª—è–µ—Ç. BO2 + —Ç–∞–π–±—Ä–µ–π–∫.</div>
          <div class="divider"></div>
          <div class="row">
            <div class="pill" style="flex:1">
              <span class="text2">–ü–æ–±–µ–¥</span>
              <strong id="frogWins">‚Äî</strong>
            </div>
            <div class="pill" style="flex:1">
              <span class="text2">–ü–æ—Ä–∞–∂–µ–Ω–∏–π</span>
              <strong id="frogLosses">‚Äî</strong>
            </div>
            <div class="pill" style="flex:1">
              <span class="text2">–ò–≥—Ä</span>
              <strong id="frogGames">‚Äî</strong>
            </div>
          </div>
          <div style="margin-top:14px">
            <button class="btn primary" id="openFrogHunt">–ò–≥—Ä–∞—Ç—å</button>
          </div>
        </div>

        <!-- Obstacle Race PvP -->
        <div class="glass card">
          <h2>üèÅ –ü–æ–ª–æ—Å–∞ –ø—Ä–µ–ø—è—Ç—Å—Ç–≤–∏–π</h2>
          <div class="muted">PvP: —Ä–∞—Å—Å—Ç–∞–≤–ª—è–π –ª–æ–≤—É—à–∫–∏ –∏ –±–µ–≥–∏ –ø–æ –ø–æ–ª–æ—Å–µ —Å–æ–ø–µ—Ä–Ω–∏–∫–∞. –ö—Ç–æ –±—ã—Å—Ç—Ä–µ–µ!</div>
          <div class="divider"></div>
          <div class="row">
            <div class="pill" style="flex:1">
              <span class="text2">–ü–æ–±–µ–¥</span>
              <strong id="raceWins">‚Äî</strong>
            </div>
            <div class="pill" style="flex:1">
              <span class="text2">–ü–æ—Ä–∞–∂–µ–Ω–∏–π</span>
              <strong id="raceLosses">‚Äî</strong>
            </div>
            <div class="pill" style="flex:1">
              <span class="text2">–ò–≥—Ä</span>
              <strong id="raceGames">‚Äî</strong>
            </div>
          </div>
          <div style="margin-top:14px">
            <button class="btn primary" id="openObstacleRace">–ò–≥—Ä–∞—Ç—å</button>
          </div>
        </div>
      </section>

      <!-- REACTION GAME -->
      <section id="page-reaction" class="hidden">
        <div class="glass card">
          <div class="row" style="align-items:center; justify-content:space-between;">
            <div>
              <div class="titleXL" style="margin:0">‚ö° –†–µ–∞–∫—Ü–∏—è</div>
              <div class="subtitle">–¢–∞–ø–Ω–∏ –∫–∞–∫ –º–æ–∂–Ω–æ –±—ã—Å—Ç—Ä–µ–µ –ø–æ—Å–ª–µ ‚ÄúGO‚Äù</div>
            </div>
            <button class="btn ghost" style="width:auto; padding:10px 12px; font-size:13px" id="backFromReaction">–ù–∞–∑–∞–¥</button>
          </div>

          <div class="divider"></div>

          <div class="gameSurface center" id="reactSurface" style="height:320px;">
            <div>
              <div class="big" id="reactText">–ù–∞–∂–º–∏ ‚Äú–°—Ç–∞—Ä—Ç‚Äù</div>
              <div class="hint" id="reactHint" style="margin-top:10px">
                –ü–æ—Å–ª–µ —Å—Ç–∞—Ä—Ç–∞ –∂–¥–∏ —Å–∏–≥–Ω–∞–ª ‚ÄúGO‚Äù –∏ —Ç–∞–ø–Ω–∏ –ø–æ –ø–æ–ª—é.
              </div>
            </div>
          </div>

          <div class="divider"></div>

          <div class="row">
            <div class="pill" style="flex:1">
              <span class="text2">–õ—É—á—à–µ–µ</span>
              <strong id="reactBest2">‚Äî</strong>
            </div>
            <div class="pill" style="flex:1">
              <span class="text2">–ü–æ—Å–ª–µ–¥–Ω–µ–µ</span>
              <strong id="reactLast2">‚Äî</strong>
            </div>
          </div>

          <div style="margin-top:14px" class="row">
            <button class="btn primary" id="reactStart">–°—Ç–∞—Ä—Ç</button>
            <button class="btn ghost" id="reactReset">–°–±—Ä–æ—Å–∏—Ç—å</button>
          </div>
        </div>
      </section>

      <!-- PONG GAME -->
      <section id="page-pong" class="hidden">
        <div class="glass card">
          <div class="row" style="align-items:center; justify-content:space-between;">
            <div>
              <div class="titleXL" style="margin:0">üèì –ü–∏–Ω–≥-–ø–æ–Ω–≥</div>
              <div class="subtitle">–î–≤–∏–≥–∞–π –ø–∞–ª—å—Ü–µ–º –ø–æ —ç–∫—Ä–∞–Ω—É ‚Äî —Ä–∞–∫–µ—Ç–∫–∞ –ø–æ–≤—Ç–æ—Ä—è–µ—Ç</div>
            </div>
            <button class="btn ghost" style="width:auto; padding:10px 12px; font-size:13px" id="backFromPong">–ù–∞–∑–∞–¥</button>
          </div>

          <div class="divider"></div>

          <div class="gameSurface">
            <canvas id="pongCanvas" width="900" height="540"></canvas>
          </div>

          <div class="divider"></div>

          <div class="row">
            <div class="pill" style="flex:1">
              <span class="text2">–°—á—ë—Ç</span>
              <strong id="pongScore2">0 : 0</strong>
            </div>
            <div class="pill" style="flex:1">
              <span class="text2">–°–ª–æ–∂–Ω–æ—Å—Ç—å</span>
              <strong id="pongDiff">1.0√ó</strong>
            </div>
          </div>

          <div style="margin-top:14px" class="row">
            <button class="btn primary" id="pongRestart">–ù–∞—á–∞—Ç—å –∑–∞–Ω–æ–≤–æ</button>
            <button class="btn ghost" id="pongPause">–ü–∞—É–∑–∞</button>
          </div>

          <div class="small" style="margin-top:10px">
            –ü–æ–¥—Å–∫–∞–∑–∫–∞: —á–µ–º –¥–æ–ª—å—à–µ —Ä–æ–∑—ã–≥—Ä—ã—à ‚Äî —Ç–µ–º –±—ã—Å—Ç—Ä–µ–µ –º—è—á –∏ —É–º–Ω–µ–µ –±–æ—Ç.
          </div>
        </div>
      </section>

      <!-- WALLET -->
      <section id="page-wallet" class="hidden">
        <div class="glass card">
          <h2 class="titleXL">–ë–∞–ª–∞–Ω—Å</h2>
          <p class="subtitle">Coins ‚Ä¢ Stars (—Å–∫–æ—Ä–æ)</p>
          <div class="divider"></div>

          <div class="row">
            <div class="pill" style="flex:1">
              <span class="text2">ü™ô Coins</span>
              <strong id="coinsVal">0</strong>
            </div>
            <div class="pill" style="flex:1">
              <span class="text2">‚≠ê Stars</span>
              <strong id="starsVal">0</strong>
            </div>
          </div>

          <div class="divider"></div>
          <div class="muted">–ò—Å—Ç–æ—Ä–∏—è –æ–ø–µ—Ä–∞—Ü–∏–π (–ª–æ–∫–∞–ª—å–Ω–æ)</div>
          <div id="txList" style="margin-top:10px; display:flex; flex-direction:column; gap:10px"></div>

          <div class="divider"></div>
          <button class="btn danger" id="resetBtn">–°–±—Ä–æ—Å–∏—Ç—å –ø—Ä–æ–≥—Ä–µ—Å—Å (—Ç–µ—Å—Ç)</button>
        </div>
      </section>

      <!-- MATCHES -->
      <section id="page-matches" class="hidden">
        <div class="glass card">
          <div class="row" style="align-items:center; justify-content:space-between;">
            <div>
              <div class="titleXL" style="margin:0">–ú–∞—Ç—á–∏</div>
              <div class="subtitle">–ò—Å—Ç–æ—Ä–∏—è (–ø–æ–∫–∞ –¥–µ–º–æ)</div>
            </div>
            <div class="chip">MVP</div>
          </div>

          <div class="divider"></div>

          <div id="matchesEmpty" class="muted">
            –ü–æ–∫–∞ –∏—Å—Ç–æ—Ä–∏–∏ –Ω–µ—Ç.<br>
            (–ú—ã –≤–µ—Ä–Ω—ë–º PvP-–¥—É—ç–ª–∏ –ø–æ–∑–∂–µ, –∫–æ–≥–¥–∞ –ø–æ–¥–∫–ª—é—á–∏–º —Å–µ—Ä–≤–µ—Ä.)
          </div>

          <div id="matchesList" style="display:none; flex-direction:column; gap:10px"></div>
        </div>
      </section>

      <!-- PROFILE -->
      <section id="page-profile" class="hidden">
        <div class="glass card">
          <div class="row" style="align-items:center; justify-content:space-between;">
            <div>
              <div class="titleXL" id="profNick">‚Äî</div>
              <div class="subtitle" id="profId">‚Äî</div>
            </div>
            <button class="btn ghost" style="width:auto; padding:10px 12px; font-size:13px" id="editNickBtn">Edit</button>
          </div>

          <div class="divider"></div>

          <div class="row">
            <div class="pill" style="flex:1"><span class="text2">–†–µ–∞–∫—Ü–∏—è (best)</span><strong id="profReactBest">‚Äî</strong></div>
            <div class="pill" style="flex:1"><span class="text2">Pong</span><strong id="profPongBest">‚Äî</strong></div>
          </div>

          <div class="divider"></div>

          <div class="row">
            <div class="pill" style="flex:1">
              <span class="text2">–ü—Ä–∞–≤–∏–ª–∞</span>
              <strong id="rulesAcceptedLine">‚Äî</strong>
            </div>
            <div class="pill" style="flex:1">
              <span class="text2">–¢–≤–æ–π –∫–æ–¥</span>
              <strong id="myRefCode">‚Äî</strong>
            </div>
          </div>

          <div class="divider"></div>

          <h2 style="margin:0 0 8px 0; font-size:16px">–ù–∞—Å—Ç—Ä–æ–π–∫–∏</h2>
          <div class="row">
            <div class="pill" style="flex:1">
              <span class="text2">–ó–≤—É–∫</span>
              <input type="checkbox" id="setSound" />
            </div>
            <div class="pill" style="flex:1">
              <span class="text2">–í–∏–±—Ä–∞—Ü–∏—è</span>
              <input type="checkbox" id="setHaptic" />
            </div>
          </div>

          <div class="divider"></div>
          <div class="row">
            <button class="btn ghost" id="copyRefBtn">–°–∫–æ–ø–∏—Ä–æ–≤–∞—Ç—å –∫–æ–¥</button>
            <button class="btn primary" id="shareRefBtn">–ü–æ–¥–µ–ª–∏—Ç—å—Å—è</button>
          </div>
        </div>
      </section>

    </main>
  </div>

  <nav class="nav">
    <button id="tab-games" onclick="go('games')"><div class="icon">üéÆ</div><div>–ò–≥—Ä—ã</div></button>
    <button id="tab-wallet" onclick="go('wallet')"><div class="icon">üí∞</div><div>–ë–∞–ª–∞–Ω—Å</div></button>
    <button id="tab-matches" onclick="go('matches')"><div class="icon">üßæ</div><div>–ú–∞—Ç—á–∏</div></button>
    <button id="tab-profile" onclick="go('profile')"><div class="icon">üë§</div><div>–ü—Ä–æ—Ñ–∏–ª—å</div></button>
  </nav>

  <div id="toast" class="toast"></div>

  <div id="modalWrap" class="modalWrap">
    <div class="modal">
      <h3 id="modalTitle">–ü–æ–¥—Ç–≤–µ—Ä–¥–∏—Ç—å</h3>
      <div class="muted" id="modalText">‚Äî</div>
      <div class="row" style="margin-top:14px">
        <button id="modalOk" class="btn danger">–û–∫</button>
        <button id="modalCancel" class="btn ghost">–û—Ç–º–µ–Ω–∞</button>
      </div>
    </div>
  </div>

<script>
  const tg = window.Telegram?.WebApp;
  try{ tg?.ready(); tg?.expand(); }catch(e){}
  const envChip = document.getElementById("envChip");
  envChip.textContent = tg ? "Telegram WebApp" : "Browser";

  const KEY="f1duel_state_v2_games";
  const now = ()=>Date.now();

  function randCode(len=6){
    const a="ABCDEFGHJKLMNPQRSTUVWXYZ23456789";
    let s=""; for(let i=0;i<len;i++) s+=a[Math.floor(Math.random()*a.length)];
    return s;
  }
  function shortId(){ return randCode(4); }

  const defaultState = {
    onboarding: { rulesAccepted:false, nicknameSet:false, referralAsked:false },
    profile: {
      publicId: shortId(),
      nickname: "",
      rulesAcceptedAt: 0,
      nicknameChangedAt: 0,
      myRefCode: randCode(6),
      referredBy: "",
      refStatus: "none",
    },
    wallet: { coins: 120, stars: 0 },
    settings: { sound:true, haptic:true },
    tx: [],
    // games
    reaction: { bestMs: 0, lastMs: 0 },
    pong: { bestWins: 0, bestDiff: 1.0 }
  };

  const state = (()=> {
    try{
      const raw = localStorage.getItem(KEY);
      if(!raw) return structuredClone(defaultState);
      const s = JSON.parse(raw);
      return {
        ...defaultState,
        ...s,
        onboarding:{...defaultState.onboarding, ...(s.onboarding||{})},
        profile:{...defaultState.profile, ...(s.profile||{})},
        wallet:{...defaultState.wallet, ...(s.wallet||{})},
        settings:{...defaultState.settings, ...(s.settings||{})},
        reaction:{...defaultState.reaction, ...(s.reaction||{})},
        pong:{...defaultState.pong, ...(s.pong||{})},
        tx: Array.isArray(s.tx)? s.tx : []
      };
    }catch(e){
      return structuredClone(defaultState);
    }
  })();

  function save(){ localStorage.setItem(KEY, JSON.stringify(state)); renderAll(); }

  function hImpact(type="light"){ if(!state.settings.haptic) return; try{ tg?.HapticFeedback?.impactOccurred(type);}catch(e){} }
  function hNote(type="success"){ if(!state.settings.haptic) return; try{ tg?.HapticFeedback?.notificationOccurred(type);}catch(e){} }
  function hSelect(){ if(!state.settings.haptic) return; try{ tg?.HapticFeedback?.selectionChanged();}catch(e){} }

  const toastEl = document.getElementById("toast"); let toastTimer=null;
  function toast(t){ toastEl.textContent=t; toastEl.classList.add("show"); clearTimeout(toastTimer); toastTimer=setTimeout(()=>toastEl.classList.remove("show"), 1500); }

  const modalWrap = document.getElementById("modalWrap");
  const modalTitle = document.getElementById("modalTitle");
  const modalText = document.getElementById("modalText");
  const modalOk = document.getElementById("modalOk");
  const modalCancel = document.getElementById("modalCancel");

  function openModal(title, text, onOk){
    modalTitle.textContent = title;
    modalText.textContent = text;
    modalWrap.classList.add("show");
    modalOk.onclick = ()=>{
      modalWrap.classList.remove("show");
      onOk?.();
    };
    modalCancel.onclick = ()=> modalWrap.classList.remove("show");
  }

  const pages = ["onb-rules","onb-nick","onb-ref","games","reaction","pong","wallet","matches","profile"];
  function go(page){
    pages.forEach(p=>{
      const el = document.getElementById("page-"+p);
      if(el) el.classList.toggle("hidden", p!==page);
    });
    ["games","wallet","matches","profile"].forEach(t=>{
      const tab = document.getElementById("tab-"+t);
      if(tab) tab.classList.toggle("active", t===page);
    });
    location.hash = "#"+page;

    if(page==="pong") pongStart();
    if(page!=="pong") pongStop();
  }

  function needsOnboarding(){
    if(!state.onboarding.rulesAccepted) return "onb-rules";
    if(!state.onboarding.nicknameSet) return "onb-nick";
    if(!state.onboarding.referralAsked) return "onb-ref";
    return null;
  }

  const userChip = document.getElementById("userChip");
  const displayNick = ()=> (state.profile.nickname || "Player");
  function displayMe(){ return `${displayNick()} #${state.profile.publicId}`; }

  const onlineNow = document.getElementById("onlineNow");
  let onlineBase = 80 + Math.floor(Math.random()*140);
  function tickOnline(){
    const wobble = Math.floor((Math.random()*10)-5);
    onlineBase = Math.max(20, onlineBase + wobble);
    onlineNow.textContent = onlineBase;
  }
  setInterval(tickOnline, 8000);

  const rulesCheck = document.getElementById("rulesCheck");
  const rulesContinue = document.getElementById("rulesContinue");
  rulesCheck.onchange = ()=>{ rulesContinue.disabled = !rulesCheck.checked; };
  rulesContinue.onclick = ()=>{
    state.onboarding.rulesAccepted = true;
    state.profile.rulesAcceptedAt = now();
    save();
    go("onb-nick");
  };

  const nickInput = document.getElementById("nickInput");
  const nickSave = document.getElementById("nickSave");
  const nickSkip = document.getElementById("nickSkip");
  const nickError = document.getElementById("nickError");

  function setNick(nick){
    nickError.style.display="none";
    const n = (nick||"").trim();
    if(!n){
      state.profile.nickname = "Player_"+randCode(3);
    } else {
      if(!/^[A-Za-z0-9_]{3,16}$/.test(n)){
        nickError.textContent="–ù–µ–≤–µ—Ä–Ω—ã–π —Ñ–æ—Ä–º–∞—Ç. –¢–æ–ª—å–∫–æ –ª–∞—Ç–∏–Ω–∏—Ü–∞/—Ü–∏—Ñ—Ä—ã/_ (3‚Äì16)";
        nickError.style.display="block";
        return false;
      }
      state.profile.nickname = n;
    }
    state.onboarding.nicknameSet = true;
    state.profile.nicknameChangedAt = now();
    return true;
  }
  nickSave.onclick = ()=>{ if(setNick(nickInput.value)){ save(); go("onb-ref"); } };
  nickSkip.onclick = ()=>{ if(setNick("")){ save(); go("onb-ref"); } };

  const refInput = document.getElementById("refInput");
  const refApply = document.getElementById("refApply");
  const refSkip = document.getElementById("refSkip");
  const refError = document.getElementById("refError");

  function normalizeRef(code){ return (code||"").trim().toUpperCase().replace(/[^A-Z0-9]/g,""); }

  refApply.onclick = ()=>{
    refError.style.display="none";
    const code = normalizeRef(refInput.value);
    if(code && code === normalizeRef(state.profile.myRefCode)){
      refError.textContent="–ù–µ–ª—å–∑—è –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å —Å–≤–æ–π –∫–æ–¥";
      refError.style.display="block";
      return;
    }
    if(code){
      state.profile.referredBy = code;
      state.profile.refStatus = "pending";
      toast("–ö–æ–¥ –ø—Ä–∏–º–µ–Ω—ë–Ω");
    }
    state.onboarding.referralAsked = true;
    save();
    go("games");
  };
  refSkip.onclick = ()=>{
    state.onboarding.referralAsked = true;
    save();
    go("games");
  };

  document.getElementById("openReaction").onclick = ()=>{ hImpact("light"); go("reaction"); reactionResetUI(); };
  document.getElementById("openPong").onclick = ()=>{ hImpact("light"); go("pong"); };

  document.getElementById("backFromReaction").onclick = ()=>go("games");
  document.getElementById("backFromPong").onclick = ()=>go("games");

  const FROG_HUNT_API = "https://reliable-purpose-production-6509.up.railway.app";
  const OBSTACLE_RACE_API = "https://trap-runner-demo-production.up.railway.app";

  function getTgUserId(){
    try{
      const user = tg?.initDataUnsafe?.user;
      return user ? String(user.id) : null;
    }catch(e){ return null; }
  }

  document.getElementById("openFrogHunt").onclick = ()=>{
    hImpact("light");
    window.location.href = "/frog-hunt/";
  };
  document.getElementById("openObstacleRace").onclick = ()=>{
    hImpact("light");
    window.location.href = "/obstacle-race/";
  };

  // Fetch stats from game servers
  async function loadExternalStats(){
    const userId = getTgUserId();
    if(!userId) return;

    try{
      const res = await fetch(`${FROG_HUNT_API}/api/stats/${userId}`);
      const data = await res.json();
      document.getElementById("frogWins").textContent = data.wins || 0;
      document.getElementById("frogLosses").textContent = data.losses || 0;
      document.getElementById("frogGames").textContent = data.games || 0;
    }catch(e){}

    try{
      const res = await fetch(`${OBSTACLE_RACE_API}/api/stats/${userId}`);
      const data = await res.json();
      document.getElementById("raceWins").textContent = data.wins || 0;
      document.getElementById("raceLosses").textContent = data.losses || 0;
      document.getElementById("raceGames").textContent = data.games || 0;
    }catch(e){}
  }

  const coinsVal = document.getElementById("coinsVal");
  const starsVal = document.getElementById("starsVal");
  const txList = document.getElementById("txList");
  const resetBtn = document.getElementById("resetBtn");

  function addTx(label, amount=0){
    state.tx.unshift({ts: now(), label, amount});
    state.tx = state.tx.slice(0, 30);
  }

  resetBtn.onclick = ()=>{
    openModal("–°–±—Ä–æ—Å–∏—Ç—å –ø—Ä–æ–≥—Ä–µ—Å—Å?", "–≠—Ç–æ —É–¥–∞–ª–∏—Ç –ª–æ–∫–∞–ª—å–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ –Ω–∞ —ç—Ç–æ–º —É—Å—Ç—Ä–æ–π—Å—Ç–≤–µ.", ()=>{
      localStorage.removeItem(KEY);
      location.reload();
    });
  };

  function renderWallet(){
    coinsVal.textContent = state.wallet.coins;
    starsVal.textContent = state.wallet.stars;

    txList.innerHTML="";
    if(state.tx.length===0){
      const d=document.createElement("div");
      d.className="muted";
      d.textContent="–û–ø–µ—Ä–∞—Ü–∏–π –ø–æ–∫–∞ –Ω–µ—Ç.";
      txList.appendChild(d);
      return;
    }
    state.tx.slice(0,12).forEach(t=>{
      const item=document.createElement("div");
      item.className="pill";
      const sign = t.amount>0 ? "+" : "";
      item.innerHTML = `
        <div>
          <div style="font-weight:800">${t.label}</div>
          <div class="small">${new Date(t.ts).toLocaleString("ru-RU")}</div>
        </div>
        <div style="font-weight:950; color:${t.amount>=0?'var(--accent)':'var(--danger)'}">${sign}${t.amount}</div>
      `;
      txList.appendChild(item);
    });
  }

  const profNick = document.getElementById("profNick");
  const profId = document.getElementById("profId");
  const rulesAcceptedLine = document.getElementById("rulesAcceptedLine");
  const myRefCode = document.getElementById("myRefCode");
  const copyRefBtn = document.getElementById("copyRefBtn");
  const shareRefBtn = document.getElementById("shareRefBtn");
  const editNickBtn = document.getElementById("editNickBtn");
  const setSound = document.getElementById("setSound");
  const setHaptic = document.getElementById("setHaptic");
  const profReactBest = document.getElementById("profReactBest");
  const profPongBest = document.getElementById("profPongBest");

  function formatDate(ts){
    try{
      const d=new Date(ts);
      return d.toLocaleDateString("ru-RU",{day:"2-digit",month:"short",year:"numeric"});
    }catch(e){ return "‚Äî"; }
  }

  editNickBtn.onclick = ()=>{
    openModal("–ò–∑–º–µ–Ω–∏—Ç—å –Ω–∏–∫", "–ù–∏–∫: 3‚Äì16 —Å–∏–º–≤–æ–ª–æ–≤ (–ª–∞—Ç–∏–Ω–∏—Ü–∞/—Ü–∏—Ñ—Ä—ã/_)", ()=>{
      const next = prompt("–ù–æ–≤—ã–π –Ω–∏–∫:", state.profile.nickname || "");
      if(next===null) return;
      const n = next.trim();
      if(!/^[A-Za-z0-9_]{3,16}$/.test(n)){
        toast("–ù–µ–≤–µ—Ä–Ω—ã–π —Ñ–æ—Ä–º–∞—Ç –Ω–∏–∫–∞");
        return;
      }
      state.profile.nickname = n;
      state.profile.nicknameChangedAt = now();
      addTx("–ù–∏–∫ –æ–±–Ω–æ–≤–ª—ë–Ω");
      save();
      toast("–ù–∏–∫ –æ–±–Ω–æ–≤–ª—ë–Ω");
    });
  };

  copyRefBtn.onclick = async ()=>{
    try{
      await navigator.clipboard.writeText(state.profile.myRefCode);
      toast("–ö–æ–¥ —Å–∫–æ–ø–∏—Ä–æ–≤–∞–Ω");
    }catch(e){
      toast("–ù–µ —É–¥–∞–ª–æ—Å—å —Å–∫–æ–ø–∏—Ä–æ–≤–∞—Ç—å");
    }
  };

  shareRefBtn.onclick = ()=>{
    const text = `–ú–æ–π —Ä–µ—Ñ-–∫–æ–¥ –≤ F1 Duel: ${state.profile.myRefCode}`;
    try{
      if(tg?.shareText) tg.shareText(text);
      else {
        navigator.clipboard?.writeText(text);
        toast("–¢–µ–∫—Å—Ç —Å–∫–æ–ø–∏—Ä–æ–≤–∞–Ω");
      }
    }catch(e){
      toast("–ü–æ–¥–µ–ª–∏—Ç—å—Å—è –Ω–µ –ø–æ–ª—É—á–∏–ª–æ—Å—å");
    }
  };

  setSound.onchange = ()=>{ state.settings.sound = !!setSound.checked; save(); };
  setHaptic.onchange = ()=>{ state.settings.haptic = !!setHaptic.checked; save(); };

  function renderProfile(){
    profNick.textContent = displayNick();
    profId.textContent = `#${state.profile.publicId}`;
    rulesAcceptedLine.textContent = state.profile.rulesAcceptedAt ? `–ü—Ä–∏–Ω—è—Ç—ã: ${formatDate(state.profile.rulesAcceptedAt)}` : "‚Äî";
    myRefCode.textContent = state.profile.myRefCode;

    setSound.checked = !!state.settings.sound;
    setHaptic.checked = !!state.settings.haptic;

    profReactBest.textContent = state.reaction.bestMs ? `${state.reaction.bestMs} ms` : "‚Äî";
    profPongBest.textContent = state.pong.bestWins ? `Wins: ${state.pong.bestWins}` : "‚Äî";
  }

  function renderMatches(){
    // –æ—Å—Ç–∞–≤–∏–ª–∏ –∑–∞–≥–ª—É—à–∫—É
  }

  const reactBest = document.getElementById("reactBest");
  const reactLast = document.getElementById("reactLast");
  const reactBest2 = document.getElementById("reactBest2");
  const reactLast2 = document.getElementById("reactLast2");

  const reactSurface = document.getElementById("reactSurface");
  const reactText = document.getElementById("reactText");
  const reactHint = document.getElementById("reactHint");
  const reactStart = document.getElementById("reactStart");
  const reactReset = document.getElementById("reactReset");

  let reactState = "idle"; // idle | waiting | go | done
  let reactGoAt = 0;
  let reactTimer = null;

  function reactionResetUI(){
    clearTimeout(reactTimer);
    reactState = "idle";
    reactGoAt = 0;
    reactText.textContent = "–ù–∞–∂–º–∏ ‚Äú–°—Ç–∞—Ä—Ç‚Äù";
    reactHint.textContent = "–ü–æ—Å–ª–µ —Å—Ç–∞—Ä—Ç–∞ –∂–¥–∏ —Å–∏–≥–Ω–∞–ª ‚ÄúGO‚Äù –∏ —Ç–∞–ø–Ω–∏ –ø–æ –ø–æ–ª—é.";
    renderReactionStats();
  }

  function renderReactionStats(){
    reactBest.textContent = state.reaction.bestMs ? `${state.reaction.bestMs} ms` : "‚Äî";
    reactLast.textContent = state.reaction.lastMs ? `${state.reaction.lastMs} ms` : "‚Äî";
    reactBest2.textContent = reactBest.textContent;
    reactLast2.textContent = reactLast.textContent;

    document.getElementById("reactBest").textContent = reactBest.textContent;
    document.getElementById("reactLast").textContent = reactLast.textContent;
  }

  reactStart.onclick = ()=>{
    if(reactState==="waiting" || reactState==="go") return;
    hImpact("light");
    reactState = "waiting";
    reactText.textContent = "–ñ–¥–∏‚Ä¶";
    reactHint.textContent = "–ù–µ –Ω–∞–∂–∏–º–∞–π —Ä–∞–Ω—å—à–µ –≤—Ä–µ–º–µ–Ω–∏ üòÑ";
    const delay = 1200 + Math.floor(Math.random()*2200); // 1.2‚Äì3.4 sec
    clearTimeout(reactTimer);
    reactTimer = setTimeout(()=>{
      reactState = "go";
      reactGoAt = now();
      reactText.textContent = "GO!";
      reactHint.textContent = "–¢–∞–ø–Ω–∏ –ø–æ –ø–æ–ª—é!";
      hNote("success");
    }, delay);
  };

  reactReset.onclick = ()=>{
    openModal("–°–±—Ä–æ—Å–∏—Ç—å —Ä–µ–∫–æ—Ä–¥—ã?", "–≠—Ç–æ —Å–±—Ä–æ—Å–∏—Ç best/last –≤ –∏–≥—Ä–µ –†–µ–∞–∫—Ü–∏—è.", ()=>{
      state.reaction.bestMs = 0;
      state.reaction.lastMs = 0;
      addTx("–°–±—Ä–æ—Å: –†–µ–∞–∫—Ü–∏—è");
      save();
      reactionResetUI();
      toast("–°–±—Ä–æ—à–µ–Ω–æ");
    });
  };

  reactSurface.addEventListener("pointerdown", ()=>{
    if(reactState==="idle"){ toast("–ù–∞–∂–º–∏ ‚Äú–°—Ç–∞—Ä—Ç‚Äù"); return; }

    if(reactState==="waiting"){
      // too early
      hNote("error");
      reactState = "done";
      clearTimeout(reactTimer);
      reactText.textContent = "–°–ª–∏—à–∫–æ–º —Ä–∞–Ω–æ!";
      reactHint.textContent = "–ü–æ–ø—Ä–æ–±—É–π –µ—â—ë —Ä–∞–∑.";
      return;
    }

    if(reactState==="go"){
      const ms = Math.max(1, now() - reactGoAt);
      state.reaction.lastMs = ms;
      if(!state.reaction.bestMs || ms < state.reaction.bestMs) state.reaction.bestMs = ms;
      addTx(`–†–µ–∞–∫—Ü–∏—è: ${ms} ms`);
      save();
      hImpact("medium");
      reactState = "done";
      reactText.textContent = `${ms} ms`;
      reactHint.textContent = ms < 220 ? "üî• –û—á–µ–Ω—å –±—ã—Å—Ç—Ä–æ!" : (ms < 300 ? "–û—Ç–ª–∏—á–Ω–æ!" : "–ù–æ—Ä–º, –º–æ–∂–Ω–æ –±—ã—Å—Ç—Ä–µ–µ üòÑ");
      renderReactionStats();
    }
  });

  const pongCanvas = document.getElementById("pongCanvas");
  const ctx = pongCanvas.getContext("2d");
  const pongScore = document.getElementById("pongScore");
  const pongScore2 = document.getElementById("pongScore2");
  const pongDiff = document.getElementById("pongDiff");
  const pongToWin = document.getElementById("pongToWin");

  const pongRestart = document.getElementById("pongRestart");
  const pongPause = document.getElementById("pongPause");

  let pongRAF = null;
  let pongRunning = false;
  let pongPaused = false;

  const TO_WIN = 5;
  pongToWin.textContent = TO_WIN;

  const game = {
    w: pongCanvas.width, h: pongCanvas.height,
    scoreL: 0, scoreR: 0,
    diff: 1.0,
    rally: 0,
    ball: { x:0,y:0,vx:0,vy:0,r:10 },
    paddleL: { x:40, y:0, w:16, h:120 },
    paddleR: { x:0, y:0, w:16, h:120 },
    touchY: null
  };

  function clamp(v,min,max){ return Math.max(min, Math.min(max, v)); }

  function pongResetBall(dir=1){
    game.ball.x = game.w/2;
    game.ball.y = game.h/2;
    const speed = 6 + (game.diff-1)*3;
    const angle = (Math.random()*0.8 - 0.4); // -0.4..0.4
    game.ball.vx = dir * speed;
    game.ball.vy = speed * angle;
    game.rally = 0;
  }

  function pongReset(){
    game.scoreL = 0; game.scoreR = 0;
    game.diff = 1.0;
    game.paddleL.y = game.h/2 - game.paddleL.h/2;
    game.paddleR.x = game.w - 40 - game.paddleR.w;
    game.paddleR.y = game.h/2 - game.paddleR.h/2;
    pongResetBall(Math.random() < 0.5 ? -1 : 1);
    updatePongUI();
  }

  function updatePongUI(){
    pongScore.textContent = `${game.scoreL} : ${game.scoreR}`;
    pongScore2.textContent = pongScore.textContent;
    pongDiff.textContent = `${game.diff.toFixed(2)}√ó`;
    document.getElementById("pongScore").textContent = pongScore.textContent;
  }

  function pongDraw(){
    ctx.clearRect(0,0,game.w,game.h);

    // background field
    ctx.fillStyle = "rgba(255,255,255,0.04)";
    ctx.fillRect(0,0,game.w,game.h);

    // soft borders
    ctx.strokeStyle = "rgba(255,255,255,0.10)";
    ctx.lineWidth = 6;
    ctx.strokeRect(10,10,game.w-20,game.h-20);

    // paddles
    ctx.fillStyle = "rgba(255,255,255,0.85)";
    roundRect(ctx, game.paddleL.x, game.paddleL.y, game.paddleL.w, game.paddleL.h, 10, true, false);
    ctx.fillStyle = "rgba(255,255,255,0.55)";
    roundRect(ctx, game.paddleR.x, game.paddleR.y, game.paddleR.w, game.paddleR.h, 10, true, false);

    // ball
    ctx.beginPath();
    ctx.fillStyle = "rgba(140,255,193,0.95)";
    ctx.arc(game.ball.x, game.ball.y, game.ball.r, 0, Math.PI*2);
    ctx.fill();

    // score
    ctx.fillStyle = "rgba(255,255,255,0.55)";
    ctx.font = "900 44px system-ui";
    ctx.textAlign = "center";
    ctx.fillText(game.scoreL, game.w*0.35, 70);
    ctx.fillText(game.scoreR, game.w*0.65, 70);
  }

  function roundRect(ctx, x, y, w, h, r, fill, stroke) {
    if (w < 2 * r) r = w / 2;
    if (h < 2 * r) r = h / 2;
    ctx.beginPath();
    ctx.moveTo(x+r, y);
    ctx.arcTo(x+w, y,   x+w, y+h, r);
    ctx.arcTo(x+w, y+h, x,   y+h, r);
    ctx.arcTo(x,   y+h, x,   y,   r);
    ctx.arcTo(x,   y,   x+w, y,   r);
    ctx.closePath();
    if (fill) ctx.fill();
    if (stroke) ctx.stroke();
  }

  function pongStep(){
    if(!pongRunning){ return; }
    if(pongPaused){
      pongDraw();
      pongRAF = requestAnimationFrame(pongStep);
      return;
    }

    // player paddle follow
    const targetY = game.touchY ?? (game.ball.y);
    game.paddleL.y = clamp(targetY - game.paddleL.h/2, 20, game.h - game.paddleL.h - 20);

    // bot AI: smoother + slightly imperfect
    const botCenter = game.paddleR.y + game.paddleR.h/2;

    // bot target: predict a bit but with noise
    const noise = (Math.random()*2 - 1) * (10 + game.diff*6); // grows with diff
    const desired = game.ball.y + noise;

    // smoothness (lower = smoother)
    const aiSpeed = 0.08 + (game.diff-1)*0.03; // 0.08.. ~
    const next = botCenter + (desired - botCenter) * aiSpeed;
    game.paddleR.y = clamp(next - game.paddleR.h/2, 20, game.h - game.paddleR.h - 20);

    // ball move
    game.ball.x += game.ball.vx;
    game.ball.y += game.ball.vy;

    // wall bounce
    if(game.ball.y - game.ball.r < 20){
      game.ball.y = 20 + game.ball.r;
      game.ball.vy *= -1;
      hSelect();
    }
    if(game.ball.y + game.ball.r > game.h - 20){
      game.ball.y = game.h - 20 - game.ball.r;
      game.ball.vy *= -1;
      hSelect();
    }

    // paddle collision helper
    function hitPaddle(p){
      const bx = game.ball.x, by = game.ball.y, r = game.ball.r;
      if(bx + r < p.x || bx - r > p.x + p.w) return false;
      if(by + r < p.y || by - r > p.y + p.h) return false;
      return true;
    }

    // left paddle
    if(hitPaddle(game.paddleL) && game.ball.vx < 0){
      game.ball.x = game.paddleL.x + game.paddleL.w + game.ball.r;
      // reflect + add angle based on hit position
      const rel = (game.ball.y - (game.paddleL.y + game.paddleL.h/2)) / (game.paddleL.h/2);
      const speed = Math.min(16, Math.abs(game.ball.vx) + 0.4);
      game.ball.vx = speed;
      game.ball.vy = speed * rel * 0.9;
      game.rally++;

      // difficulty grows with rally (smooth, not too fast)
      game.diff = 1.0 + Math.min(1.8, game.rally * 0.05);
      hImpact("light");
    }

    // right paddle
    if(hitPaddle(game.paddleR) && game.ball.vx > 0){
      game.ball.x = game.paddleR.x - game.ball.r;
      const rel = (game.ball.y - (game.paddleR.y + game.paddleR.h/2)) / (game.paddleR.h/2);
      const speed = Math.min(16, Math.abs(game.ball.vx) + 0.4);
      game.ball.vx = -speed;
      game.ball.vy = speed * rel * 0.9;
      game.rally++;
      game.diff = 1.0 + Math.min(1.8, game.rally * 0.05);
      hImpact("light");
    }

    // scoring
    if(game.ball.x < -50){
      game.scoreR++;
      hNote("error");
      updatePongUI();
      if(checkPongEnd()) return;
      pongResetBall(1);
    }
    if(game.ball.x > game.w + 50){
      game.scoreL++;
      hNote("success");
      updatePongUI();
      if(checkPongEnd()) return;
      pongResetBall(-1);
    }

    pongDraw();
    pongRAF = requestAnimationFrame(pongStep);
  }

  function checkPongEnd(){
    if(game.scoreL >= TO_WIN || game.scoreR >= TO_WIN){
      pongPaused = true;
      pongDraw();

      const win = game.scoreL > game.scoreR;
      if(win){
        toast("–ü–æ–±–µ–¥–∞! üî•");
        state.pong.bestWins = Math.max(state.pong.bestWins, 1);
        addTx("Pong: –ø–æ–±–µ–¥–∞");
      } else {
        toast("–ü–æ—Ä–∞–∂–µ–Ω–∏–µ üòÑ");
        addTx("Pong: –ø–æ—Ä–∞–∂–µ–Ω–∏–µ");
      }
      state.pong.bestDiff = Math.max(state.pong.bestDiff, game.diff);
      save();
      return true;
    }
    return false;
  }

  function pongStart(){
    if(pongRunning) return;
    pongRunning = true;
    pongPaused = false;
    pongReset();
    pongRAF = requestAnimationFrame(pongStep);
  }

  function pongStop(){
    pongRunning = false;
    if(pongRAF) cancelAnimationFrame(pongRAF);
    pongRAF = null;
  }

  pongRestart.onclick = ()=>{
    hImpact("light");
    pongPaused = false;
    pongReset();
    toast("–ù–æ–≤—ã–π –º–∞—Ç—á");
  };

  pongPause.onclick = ()=>{
    pongPaused = !pongPaused;
    pongPause.textContent = pongPaused ? "–ü—Ä–æ–¥–æ–ª–∂–∏—Ç—å" : "–ü–∞—É–∑–∞";
    hSelect();
  };

  // Touch/mouse control
  function canvasToY(ev){
    const rect = pongCanvas.getBoundingClientRect();
    const clientY = ev.touches ? ev.touches[0].clientY : ev.clientY;
    const y = (clientY - rect.top) * (pongCanvas.height / rect.height);
    return y;
  }
  pongCanvas.addEventListener("pointerdown", (e)=>{ game.touchY = canvasToY(e); });
  pongCanvas.addEventListener("pointermove", (e)=>{ if(e.buttons || e.pointerType==="touch") game.touchY = canvasToY(e); });
  pongCanvas.addEventListener("pointerup", ()=>{ game.touchY = null; });

  pongCanvas.addEventListener("touchstart", (e)=>{ game.touchY = canvasToY(e); }, {passive:true});
  pongCanvas.addEventListener("touchmove", (e)=>{ game.touchY = canvasToY(e); }, {passive:true});
  pongCanvas.addEventListener("touchend", ()=>{ game.touchY = null; }, {passive:true});

  function renderAll(){
    userChip.textContent = displayMe();
    tickOnline();
    renderWallet();
    renderMatches();
    renderProfile();
    renderReactionStats();

    // games summary
    document.getElementById("reactBest").textContent = state.reaction.bestMs ? `${state.reaction.bestMs} ms` : "‚Äî";
    document.getElementById("reactLast").textContent = state.reaction.lastMs ? `${state.reaction.lastMs} ms` : "‚Äî";
    pongScore.textContent = pongScore2.textContent;
    loadExternalStats();
  }

  function initNav(){
    const required = needsOnboarding();
    if(required){ go(required); return; }
    const hash = (location.hash||"#games").slice(1);
    if(pages.includes(hash)) go(hash);
    else go("games");
  }

  reactionResetUI();
  renderAll();
  initNav();
</script>
</body>
</html>
