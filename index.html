<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>F1 Duel</title>
  <script src="https://telegram.org/js/telegram-web-app.js"></script>
  <style>
    :root{
      --bg1:#0E0F13; --bg2:#121624;

      --glass-bg: rgba(255,255,255,.06);
      --glass-border: rgba(255,255,255,.10);
      --glass-bg-strong: rgba(255,255,255,.08);
      --blur: 16px;

      --text:#fff;
      --text2: rgba(255,255,255,.68);
      --muted: rgba(255,255,255,.46);

      --accent:#8CFFC1;
      --accent-soft: rgba(140,255,193,.18);
      --accent-glow: rgba(140,255,193,.45);

      --danger:#FF7A7A;
      --danger-soft: rgba(255,92,92,.18);

      --line: rgba(255,255,255,.10);
      --shadow: 0 20px 40px rgba(0,0,0,.40);

      --r: 22px;
    }

    html,body{
      margin:0; height:100%;
      background: linear-gradient(180deg, var(--bg1), var(--bg2));
      color:var(--text);
      font-family: system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif;
      -webkit-user-select:none; user-select:none;
      -webkit-touch-callout:none;
      overscroll-behavior:none;
    }
    *{box-sizing:border-box; -webkit-tap-highlight-color:transparent}
    a{color:inherit}

    /* Subtle grain (optional) */
    body:before{
      content:"";
      position:fixed; inset:0; pointer-events:none;
      background-image:url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='140' height='140'%3E%3Cfilter id='n'%3E%3CfeTurbulence type='fractalNoise' baseFrequency='.8' numOctaves='3' stitchTiles='stitch'/%3E%3C/filter%3E%3Crect width='140' height='140' filter='url(%23n)' opacity='.18'/%3E%3C/svg%3E");
      opacity:.22;
      mix-blend-mode: overlay;
    }

    .app{min-height:100vh; padding-bottom:86px}
    .topbar{
      position:sticky; top:0; z-index:20;
      padding:14px 16px;
      display:flex; align-items:center; justify-content:space-between; gap:12px;
      background: rgba(10,12,18,.45);
      backdrop-filter: blur(18px);
      border-bottom:1px solid rgba(255,255,255,.07);
    }
    .brand{display:flex; align-items:center; gap:10px; font-weight:900; letter-spacing:.2px}
    .chip{
      font-size:12px; padding:7px 10px; border-radius:999px;
      background: var(--glass-bg); border:1px solid var(--glass-border);
      backdrop-filter: blur(var(--blur));
      color:var(--text2);
      white-space:nowrap;
    }
    .container{padding:16px}
    .row{display:flex; gap:12px; flex-wrap:wrap}
    .glass{
      background: var(--glass-bg);
      border:1px solid var(--glass-border);
      backdrop-filter: blur(var(--blur));
      border-radius: var(--r);
      box-shadow: var(--shadow);
    }
    .card{padding:14px}
    .card h2{margin:0 0 8px 0; font-size:16px; letter-spacing:.2px}
    .muted{color:var(--muted); line-height:1.35}
    .text2{color:var(--text2)}

    .btn{
      width:100%;
      border:none; cursor:pointer;
      padding:12px 14px;
      border-radius:14px;
      font-weight:900;
      font-size:15px;
      transition: transform .12s ease, opacity .12s ease;
    }
    .btn:active{transform: scale(.98)}
    .btn.primary{background: linear-gradient(135deg, #8CFFC1, #4DFF9A); color:#07110c; box-shadow: 0 0 18px rgba(140,255,193,.25)}
    .btn.ghost{
      background: var(--glass-bg-strong);
      border:1px solid var(--glass-border);
      color:var(--text);
      backdrop-filter: blur(var(--blur));
    }
    .btn.danger{
      background: var(--danger-soft);
      border:1px solid rgba(255,92,92,.30);
      color: var(--danger);
      backdrop-filter: blur(var(--blur));
    }
    .btn[disabled]{opacity:.45; cursor:not-allowed; transform:none !important}

    .nav{
      position:fixed; left:0; right:0; bottom:0; height:72px;
      padding:10px 10px 14px;
      display:flex; gap:10px;
      background: rgba(10,12,18,.45);
      backdrop-filter: blur(18px);
      border-top:1px solid rgba(255,255,255,.07);
      z-index:25;
    }
    .nav button{
      flex:1;
      border:none; cursor:pointer;
      border-radius:16px;
      background: transparent;
      color: var(--muted);
      padding:10px 8px;
      display:flex; flex-direction:column; align-items:center; justify-content:center; gap:6px;
      font-size:12px;
    }
    .nav button.active{
      background: rgba(140,255,193,.10);
      border:1px solid rgba(140,255,193,.22);
      color: var(--text);
    }
    .icon{font-size:18px; line-height:1}

    .hidden{display:none!important}
    .divider{height:1px; background: rgba(255,255,255,.08); margin:12px 0}
    .kv{display:flex; justify-content:space-between; gap:12px; padding:10px 0; border-top:1px solid rgba(255,255,255,.08)}
    .kv:first-child{border-top:none; padding-top:0}
    .pill{
      display:flex; align-items:center; justify-content:space-between; gap:10px;
      padding:10px 12px;
      border-radius:16px;
      background: var(--glass-bg-strong);
      border:1px solid var(--glass-border);
      backdrop-filter: blur(var(--blur));
    }

    /* chips row */
    .chipRow{
      display:flex; gap:10px;
      overflow:auto; padding-bottom:6px;
      scroll-snap-type:x mandatory;
    }
    .chipBet{
      flex:0 0 auto;
      padding:10px 14px;
      border-radius:999px;
      background: rgba(255,255,255,.08);
      border:1px solid rgba(255,255,255,.12);
      color: var(--text);
      font-weight:900;
      cursor:pointer;
      scroll-snap-align:start;
      transition: transform .12s ease, box-shadow .18s ease, background .18s ease, color .18s ease, opacity .18s ease;
    }
    .chipBet:active{transform: scale(.97)}
    .chipBet.selected{
      background: linear-gradient(135deg, #8CFFC1, #4DFF9A);
      color:#0B0E0C;
      box-shadow: 0 0 18px rgba(140,255,193,.35);
      border-color: rgba(140,255,193,.38);
    }
    .chipBet.disabled{
      opacity:.35; cursor:not-allowed;
      background: rgba(255,255,255,.04);
      border-color: rgba(255,255,255,.08);
    }

    /* toast */
    .toast{
      position:fixed; left:50%; bottom:86px; transform:translateX(-50%);
      max-width:92vw; text-align:center;
      padding:10px 12px; border-radius:14px;
      background: rgba(0,0,0,.65);
      border:1px solid rgba(255,255,255,.12);
      box-shadow: var(--shadow);
      opacity:0; pointer-events:none;
      transition: opacity .16s ease;
      z-index:99;
      font-size:13px;
    }
    .toast.show{opacity:1}

    /* modal */
    .modalWrap{
      position:fixed; inset:0; z-index:100;
      display:none;
      align-items:center; justify-content:center;
      padding:16px;
      background: rgba(0,0,0,.55);
      backdrop-filter: blur(10px);
    }
    .modalWrap.show{display:flex}
    .modal{
      width:min(520px, 100%);
      padding:16px;
      border-radius:24px;
      background: rgba(20,24,36,.55);
      border:1px solid rgba(255,255,255,.10);
      box-shadow: 0 30px 70px rgba(0,0,0,.55);
      backdrop-filter: blur(18px);
    }
    .modal h3{margin:0 0 6px 0}
    .modal .muted{font-size:13px}

    /* input */
    .field{
      width:100%;
      padding:12px 14px;
      border-radius:14px;
      background: rgba(255,255,255,.06);
      border:1px solid rgba(255,255,255,.12);
      color: var(--text);
      outline:none;
      font-size:15px;
    }
    .field::placeholder{color: rgba(255,255,255,.35)}
    .checkboxRow{display:flex; gap:10px; align-items:flex-start}
    .checkboxRow input{margin-top:3px}

    /* online badge */
    .onlineBadge{
      display:flex; align-items:center; gap:8px;
      padding:10px 12px;
      border-radius: 16px;
      background: rgba(255,255,255,.06);
      border:1px solid rgba(255,255,255,.10);
      backdrop-filter: blur(16px);
    }
    .dot{
      width:9px; height:9px; border-radius:50%;
      background: #3DFF9E;
      box-shadow: 0 0 12px rgba(61,255,158,.60);
      flex:0 0 auto;
    }
    .bigNumber{font-weight:950; letter-spacing:.2px}
    .small{font-size:12px; color:var(--muted)}
    .titleXL{font-size:22px; font-weight:950; letter-spacing:.2px; margin:0 0 2px 0}
    .subtitle{color:var(--text2); margin:0; font-size:13px}

    /* match status pills */
    .tag{
      display:inline-flex; align-items:center; gap:8px;
      padding:7px 10px;
      border-radius:999px;
      border:1px solid rgba(255,255,255,.12);
      background: rgba(255,255,255,.06);
      color: var(--text2);
      font-size:12px;
    }
    .tag.win{border-color: rgba(140,255,193,.28); background: rgba(140,255,193,.12); color: #d7ffe9}
    .tag.lose{border-color: rgba(255,122,122,.28); background: rgba(255,122,122,.12); color: #ffe0e0}
  </style>
</head>
<body>
  <div class="app">
    <div class="topbar">
      <div class="brand">
        <span>üèÅ F1 Duel</span>
        <span id="envChip" class="chip">WebApp</span>
      </div>
      <div class="chip" id="userChip">–ì–æ—Å—Ç—å</div>
    </div>

    <main class="container">

      <!-- ONBOARDING: Rules -->
      <section id="page-onb-rules" class="hidden">
        <div class="glass card">
          <h2 class="titleXL">–ü—Ä–∞–≤–∏–ª–∞ –¥—É—ç–ª–µ–π</h2>
          <p class="subtitle">–ü–æ–∫–∞–∂–µ–º –æ–¥–∏–Ω —Ä–∞–∑ –ø—Ä–∏ —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏</p>
          <div class="divider"></div>
          <div class="muted" style="font-size:14px">
            ‚Ä¢ –ú–∞—Ç—á–∏ –Ω–∞—á–∏–Ω–∞—é—Ç—Å—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –ø–æ—Å–ª–µ –ø–æ–¥–±–æ—Ä–∞ —Å–æ–ø–µ—Ä–Ω–∏–∫–∞;<br>
            ‚Ä¢ –°—Ç–∞–≤–∫–∞ –±–ª–æ–∫–∏—Ä—É–µ—Ç—Å—è –Ω–∞ –≤—Ä–µ–º—è –º–∞—Ç—á–∞;<br>
            ‚Ä¢ –ü–æ–±–µ–¥–∏—Ç–µ–ª—å –ø–æ–ª—É—á–∞–µ—Ç –≤—ã–ø–ª–∞—Ç—É (–∫–æ–º–∏—Å—Å–∏—è —É–∂–µ —É—á—Ç–µ–Ω–∞);<br>
            ‚Ä¢ –í—ã—Ö–æ–¥ –∏–ª–∏ —Å–¥–∞—á–∞ —Å—á–∏—Ç–∞—é—Ç—Å—è –ø–æ—Ä–∞–∂–µ–Ω–∏–µ–º;<br>
            ‚Ä¢ –ü—Ä–∏ –≤—ã—Ö–æ–¥–µ –º–æ–∂–µ—Ç –ø—Ä–∏–º–µ–Ω—è—Ç—å—Å—è —à—Ç—Ä–∞—Ñ;<br>
            ‚Ä¢ –ß–µ—Å—Ç–Ω–∞—è –∏–≥—Ä–∞ ‚Äî –±–µ–∑ –Ω–∞–º–µ—Ä–µ–Ω–Ω—ã—Ö –≤—ã—Ö–æ–¥–æ–≤.
          </div>

          <div class="divider"></div>

          <div class="checkboxRow">
            <input id="rulesCheck" type="checkbox"/>
            <div>
              <div style="font-weight:800">–Ø –ø—Ä–∏–Ω–∏–º–∞—é –ø—Ä–∞–≤–∏–ª–∞</div>
              <div class="small">–ë–µ–∑ —Å–æ–≥–ª–∞—Å–∏—è –Ω–µ–ª—å–∑—è –ø–æ–ª—å–∑–æ–≤–∞—Ç—å—Å—è —Å–µ—Ä–≤–∏—Å–æ–º</div>
            </div>
          </div>

          <div style="margin-top:14px">
            <button id="rulesContinue" class="btn primary" disabled>–ü—Ä–æ–¥–æ–ª–∂–∏—Ç—å</button>
          </div>
        </div>
      </section>

      <!-- ONBOARDING: Nickname -->
      <section id="page-onb-nick" class="hidden">
        <div class="glass card">
          <h2 class="titleXL">–í—ã–±–µ—Ä–∏ –Ω–∏–∫</h2>
          <p class="subtitle">–ï–≥–æ –±—É–¥—É—Ç –≤–∏–¥–µ—Ç—å –¥—Ä—É–≥–∏–µ –∏–≥—Ä–æ–∫–∏ (–Ω–µ Telegram username)</p>
          <div class="divider"></div>

          <input id="nickInput" class="field" placeholder="–ù–∞–ø—Ä–∏–º–µ—Ä: NightFox" maxlength="16" />

          <div class="small" style="margin-top:10px">
            3‚Äì16 —Å–∏–º–≤–æ–ª–æ–≤ ‚Ä¢ –ª–∞—Ç–∏–Ω–∏—Ü–∞/—Ü–∏—Ñ—Ä—ã/_ ‚Ä¢ –±–µ–∑ –ø—Ä–æ–±–µ–ª–æ–≤
          </div>

          <div style="margin-top:14px" class="row">
            <button id="nickSave" class="btn primary">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
            <button id="nickSkip" class="btn ghost">–ü—Ä–æ–ø—É—Å—Ç–∏—Ç—å</button>
          </div>

          <div class="note small" id="nickError" style="margin-top:10px; color: var(--danger); display:none"></div>
        </div>
      </section>

      <!-- ONBOARDING: Referral -->
      <section id="page-onb-ref" class="hidden">
        <div class="glass card">
          <h2 class="titleXL">–ï—Å—Ç—å –∫–æ–¥ –ø—Ä–∏–≥–ª–∞—à–µ–Ω–∏—è?</h2>
          <p class="subtitle">–ï—Å–ª–∏ –¥—Ä—É–≥ –ø–æ–¥–µ–ª–∏–ª—Å—è –∫–æ–¥–æ–º ‚Äî –≤–≤–µ–¥–∏ –µ–≥–æ —Å–µ–π—á–∞—Å (–æ–¥–∏–Ω —Ä–∞–∑)</p>
          <div class="divider"></div>

          <input id="refInput" class="field" placeholder="–ö–æ–¥ (–Ω–µ–æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ)" maxlength="10" />

          <div class="small" style="margin-top:10px">
            –ó–∞ –ø—Ä–∏–≥–ª–∞—à—ë–Ω–Ω–æ–≥–æ –¥—Ä—É–≥–∞ –ø—Ä–∏–≥–ª–∞—Å–∏–≤—à–∏–π –ø–æ–ª—É—á–∞–µ—Ç <b>+100 coins</b> (–ø–æ—Å–ª–µ –ø–µ—Ä–≤–æ–π –¥—É—ç–ª–∏ –ø—Ä–∏–≥–ª–∞—à—ë–Ω–Ω–æ–≥–æ).
          </div>

          <div style="margin-top:14px" class="row">
            <button id="refApply" class="btn primary">–ü—Ä–∏–º–µ–Ω–∏—Ç—å</button>
            <button id="refSkip" class="btn ghost">–ü—Ä–æ–ø—É—Å—Ç–∏—Ç—å</button>
          </div>

          <div class="note small" id="refError" style="margin-top:10px; color: var(--danger); display:none"></div>
        </div>
      </section>

      <!-- HOME / GAMES -->
      <section id="page-games" class="hidden">
        <div class="glass card" style="margin-bottom:12px;">
          <div class="row" style="align-items:center; justify-content:space-between;">
            <div>
              <div class="titleXL" style="margin:0">–ò–≥—Ä—ã</div>
              <div class="subtitle">–í—ã–±–µ—Ä–∏ –∏–≥—Ä—É –∏ —Å—Ç–∞–≤–∫—É</div>
            </div>
            <div class="onlineBadge">
              <div class="dot"></div>
              <div>
                <div class="small">–û–Ω–ª–∞–π–Ω —Å–µ–π—á–∞—Å</div>
                <div class="bigNumber" id="onlineNow">‚Äî</div>
              </div>
            </div>
          </div>
        </div>

        <div class="glass card">
          <h2>Ping Pong (–¥—É—ç–ª—å)</h2>
          <div class="muted">–°—Ç–∞–≤–∫–∞ ‚Üí –ø–æ–∏—Å–∫ —Å–æ–ø–µ—Ä–Ω–∏–∫–∞ ‚Üí –∞–≤—Ç–æ-—Å—Ç–∞—Ä—Ç</div>
          <div class="divider"></div>

          <div class="small">–í—ã–±–µ—Ä–∏ —Å—Ç–∞–≤–∫—É</div>
          <div style="margin-top:10px" class="chipRow" id="betRow"></div>

          <div class="divider"></div>

          <div class="row" style="align-items:flex-start;">
            <div class="pill" style="flex:1">
              <span class="text2">–°—Ç–∞–≤–∫–∞</span>
              <strong id="uiStake">‚Äî</strong>
            </div>
            <div class="pill" style="flex:1">
              <span class="text2">–ü–æ–±–µ–¥–∞</span>
              <strong id="uiPayout" style="color:var(--accent)">‚Äî</strong>
            </div>
          </div>
          <div class="small" style="margin-top:10px">–ö–æ–º–∏—Å—Å–∏—è —É–∂–µ —É—á—Ç–µ–Ω–∞</div>

          <div style="margin-top:14px">
            <button id="findBtn" class="btn primary" disabled>–ù–∞–π—Ç–∏ —Å–æ–ø–µ—Ä–Ω–∏–∫–∞</button>
          </div>
          <div class="small" id="insufText" style="margin-top:8px; display:none; color:var(--danger)">–ù–µ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ coins</div>
        </div>
      </section>

      <!-- SEARCHING -->
      <section id="page-search" class="hidden">
        <div class="glass card">
          <h2 class="titleXL">–ò—â–µ–º —Å–æ–ø–µ—Ä–Ω–∏–∫–∞‚Ä¶</h2>
          <p class="subtitle" id="searchGameLine">Ping Pong</p>
          <div class="divider"></div>

          <div class="row">
            <div class="pill" style="flex:1">
              <span class="text2">–°—Ç–∞–≤–∫–∞</span>
              <strong id="searchStake">‚Äî</strong>
            </div>
            <div class="pill" style="flex:1">
              <span class="text2">–ü–æ–±–µ–¥–∞</span>
              <strong id="searchPayout" style="color:var(--accent)">‚Äî</strong>
            </div>
          </div>

          <div class="divider"></div>

          <div class="row" style="justify-content:space-between; align-items:center">
            <div class="tag">‚åõ –ü–æ–∏—Å–∫</div>
            <div class="tag"><span class="small">—Ç–∞–π–º–µ—Ä</span> <strong id="searchTimer">01:00</strong></div>
          </div>

          <div style="margin-top:14px">
            <button id="cancelSearch" class="btn ghost">–û—Ç–º–µ–Ω–∏—Ç—å –ø–æ–∏—Å–∫</button>
          </div>
          <div class="small" style="margin-top:10px">–°—Ç–∞–≤–∫–∞ —É–∂–µ –∑–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞–Ω–∞ –Ω–∞ –≤—Ä–µ–º—è –ø–æ–∏—Å–∫–∞</div>
        </div>
      </section>

      <!-- MATCH (auto-started) -->
      <section id="page-match" class="hidden">
        <div class="glass card">
          <div class="row" style="align-items:center; justify-content:space-between;">
            <div>
              <div class="titleXL" style="margin:0">–ú–∞—Ç—á –Ω–∞—á–∞–ª—Å—è</div>
              <div class="subtitle">Ping Pong ‚Ä¢ –∞–≤—Ç–æ-—Å—Ç–∞—Ä—Ç</div>
            </div>
            <div class="tag" id="matchNet">üü¢ online</div>
          </div>

          <div class="divider"></div>

          <div class="row">
            <div class="pill" style="flex:1">
              <span class="text2">–¢—ã</span>
              <strong id="meLine">‚Äî</strong>
            </div>
            <div class="pill" style="flex:1">
              <span class="text2">–°–æ–ø–µ—Ä–Ω–∏–∫</span>
              <strong id="oppLine">‚Äî</strong>
            </div>
          </div>

          <div class="divider"></div>

          <div class="row">
            <div class="pill" style="flex:1">
              <span class="text2">–°—Ç–∞–≤–∫–∞</span>
              <strong id="matchStake">‚Äî</strong>
            </div>
            <div class="pill" style="flex:1">
              <span class="text2">–ü–æ–±–µ–¥–∞</span>
              <strong id="matchPayout" style="color:var(--accent)">‚Äî</strong>
            </div>
          </div>

          <div class="divider"></div>

          <div class="muted">
            –ó–¥–µ—Å—å –ø–æ–∑–∂–µ –±—É–¥–µ—Ç –∏–≥—Ä–∞. –°–µ–π—á–∞—Å ‚Äî —Ç–µ—Å—Ç–æ–≤—ã–π —Ä–µ–∂–∏–º —Ä–µ–∑—É–ª—å—Ç–∞—Ç–∞.
          </div>

          <div class="row" style="margin-top:14px">
            <button id="btnWin" class="btn primary">–¢–µ—Å—Ç: —è –ø–æ–±–µ–¥–∏–ª</button>
            <button id="btnLose" class="btn ghost">–¢–µ—Å—Ç: —è –ø—Ä–æ–∏–≥—Ä–∞–ª</button>
          </div>

          <div style="margin-top:10px">
            <button id="btnSurrender" class="btn danger">–°–¥–∞—Ç—å—Å—è</button>
            <div class="small" style="margin-top:8px">–í—ã—Ö–æ–¥/—Å–¥–∞—á–∞ = –ø–æ—Ä–∞–∂–µ–Ω–∏–µ. –ü–æ—Ç–µ—Ä—è —Å—Ç–∞–≤–∫–∏ + –≤–æ–∑–º–æ–∂–Ω—ã–π —à—Ç—Ä–∞—Ñ.</div>
          </div>

          <div class="divider"></div>
          <div class="small">
            –°–∏–º—É–ª—è—Ü–∏—è –≤—ã—Ö–æ–¥–∞ —Å–æ–ø–µ—Ä–Ω–∏–∫–∞: <button id="btnOppLeaves" class="btn ghost" style="width:auto; padding:8px 10px; font-size:13px">–°–æ–ø–µ—Ä–Ω–∏–∫ –≤—ã—à–µ–ª</button>
          </div>
        </div>
      </section>

      <!-- RESULT -->
      <section id="page-result" class="hidden">
        <div class="glass card">
          <div class="titleXL" id="resTitle">–†–µ–∑—É–ª—å—Ç–∞—Ç</div>
          <div class="subtitle" id="resSub">‚Äî</div>
          <div class="divider"></div>

          <div class="pill">
            <span class="text2">–ò—Ç–æ–≥</span>
            <strong id="resDelta">‚Äî</strong>
          </div>

          <div class="divider"></div>

          <div class="row">
            <button id="resAgain" class="btn primary">–°—ã–≥—Ä–∞—Ç—å –µ—â—ë</button>
            <button id="resToMatches" class="btn ghost">–í –∏—Å—Ç–æ—Ä–∏—é</button>
          </div>
        </div>
      </section>

      <!-- WALLET -->
      <section id="page-wallet" class="hidden">
        <div class="glass card">
          <h2 class="titleXL">–ë–∞–ª–∞–Ω—Å</h2>
          <p class="subtitle">Coins ‚Ä¢ Stars (—Å–∫–æ—Ä–æ)</p>
          <div class="divider"></div>

          <div class="row">
            <div class="pill" style="flex:1">
              <span class="text2">ü™ô Coins</span>
              <strong id="coinsVal">0</strong>
            </div>
            <div class="pill" style="flex:1">
              <span class="text2">‚≠ê Stars</span>
              <strong id="starsVal">0</strong>
            </div>
          </div>

          <div class="divider"></div>
          <div class="muted">–ò—Å—Ç–æ—Ä–∏—è –æ–ø–µ—Ä–∞—Ü–∏–π (–ª–æ–∫–∞–ª—å–Ω–æ)</div>
          <div id="txList" style="margin-top:10px; display:flex; flex-direction:column; gap:10px"></div>

          <div class="divider"></div>
          <button class="btn danger" id="resetBtn">–°–±—Ä–æ—Å–∏—Ç—å –ø—Ä–æ–≥—Ä–µ—Å—Å (—Ç–µ—Å—Ç)</button>
        </div>
      </section>

      <!-- MATCHES -->
      <section id="page-matches" class="hidden">
        <div class="glass card">
          <div class="row" style="align-items:center; justify-content:space-between;">
            <div>
              <div class="titleXL" style="margin:0">–ú–∞—Ç—á–∏</div>
              <div class="subtitle">–ò—Å—Ç–æ—Ä–∏—è –¥—É—ç–ª–µ–π</div>
            </div>
            <div class="tag">Ping Pong</div>
          </div>

          <div class="divider"></div>

          <div id="matchesEmpty" class="muted">
            –ú–∞—Ç—á–µ–π –ø–æ–∫–∞ –Ω–µ—Ç.<br>
            –°—ã–≥—Ä–∞–π –ø–µ—Ä–≤—É—é –¥—É—ç–ª—å ‚Äî –∏ –∏—Å—Ç–æ—Ä–∏—è –ø–æ—è–≤–∏—Ç—Å—è –∑–¥–µ—Å—å.
            <div style="margin-top:12px">
              <button class="btn primary" onclick="go('games')">–ü–µ—Ä–µ–π—Ç–∏ –∫ –∏–≥—Ä–∞–º</button>
            </div>
          </div>

          <div id="matchesList" style="display:none; flex-direction:column; gap:10px"></div>
        </div>
      </section>

      <!-- PROFILE -->
      <section id="page-profile" class="hidden">
        <div class="glass card">
          <div class="row" style="align-items:center; justify-content:space-between;">
            <div>
              <div class="titleXL" id="profNick">‚Äî</div>
              <div class="subtitle" id="profId">‚Äî</div>
            </div>
            <button class="btn ghost" style="width:auto; padding:10px 12px; font-size:13px" id="editNickBtn">Edit</button>
          </div>

          <div class="divider"></div>

          <div class="row">
            <div class="pill" style="flex:1"><span class="text2">–ü–æ–±–µ–¥—ã</span><strong id="stWins">0</strong></div>
            <div class="pill" style="flex:1"><span class="text2">–ü–æ—Ä–∞–∂–µ–Ω–∏—è</span><strong id="stLoss">0</strong></div>
          </div>
          <div class="row" style="margin-top:10px">
            <div class="pill" style="flex:1"><span class="text2">–ú–∞—Ç—á–∏</span><strong id="stMatches">0</strong></div>
            <div class="pill" style="flex:1"><span class="text2">–°–µ—Ä–∏—è</span><strong id="stStreak">0</strong></div>
          </div>

          <div class="divider"></div>

          <div class="kv">
            <span class="text2">–ü—Ä–∞–≤–∏–ª–∞ –¥—É—ç–ª–µ–π</span>
            <span class="small" id="rulesAcceptedLine">‚Äî</span>
          </div>

          <div class="divider"></div>

          <h2 style="margin:0 0 8px 0; font-size:16px">–†–µ—Ñ–µ—Ä–∞–ª—ã</h2>
          <div class="pill">
            <span class="text2">–¢–≤–æ–π –∫–æ–¥</span>
            <strong id="myRefCode">‚Äî</strong>
          </div>
          <div class="row" style="margin-top:10px">
            <button class="btn ghost" id="copyRefBtn">–°–∫–æ–ø–∏—Ä–æ–≤–∞—Ç—å –∫–æ–¥</button>
            <button class="btn primary" id="shareRefBtn">–ü–æ–¥–µ–ª–∏—Ç—å—Å—è</button>
          </div>
          <div class="small" style="margin-top:8px">
            –ó–∞ –¥—Ä—É–≥–∞: +100 coins (–ø–æ—Å–ª–µ –µ–≥–æ –ø–µ—Ä–≤–æ–π –¥—É—ç–ª–∏). –†–µ–∞–ª—å–Ω—ã–µ –Ω–∞—á–∏—Å–ª–µ–Ω–∏—è ‚Äî —á–µ—Ä–µ–∑ —Å–µ—Ä–≤–µ—Ä.
          </div>

          <div class="divider"></div>

          <h2 style="margin:0 0 8px 0; font-size:16px">–ù–∞—Å—Ç—Ä–æ–π–∫–∏</h2>
          <div class="kv">
            <span class="text2">–ó–≤—É–∫</span>
            <input type="checkbox" id="setSound" />
          </div>
          <div class="kv">
            <span class="text2">–í–∏–±—Ä–∞—Ü–∏—è</span>
            <input type="checkbox" id="setHaptic" />
          </div>
        </div>
      </section>

    </main>
  </div>

  <nav class="nav">
    <button id="tab-games" onclick="go('games')"><div class="icon">üéÆ</div><div>–ò–≥—Ä—ã</div></button>
    <button id="tab-wallet" onclick="go('wallet')"><div class="icon">üí∞</div><div>–ë–∞–ª–∞–Ω—Å</div></button>
    <button id="tab-matches" onclick="go('matches')"><div class="icon">üßæ</div><div>–ú–∞—Ç—á–∏</div></button>
    <button id="tab-profile" onclick="go('profile')"><div class="icon">üë§</div><div>–ü—Ä–æ—Ñ–∏–ª—å</div></button>
  </nav>

  <div id="toast" class="toast"></div>

  <!-- Modal confirm surrender -->
  <div id="modalWrap" class="modalWrap">
    <div class="modal">
      <h3 id="modalTitle">–ü–æ–¥—Ç–≤–µ—Ä–¥–∏—Ç—å</h3>
      <div class="muted" id="modalText">‚Äî</div>
      <div class="row" style="margin-top:14px">
        <button id="modalOk" class="btn danger">–û–∫</button>
        <button id="modalCancel" class="btn ghost">–û—Ç–º–µ–Ω–∞</button>
      </div>
    </div>
  </div>

<script>
  // ===== Telegram + Haptics
  const tg = window.Telegram?.WebApp;
  try{ tg?.ready(); tg?.expand(); }catch(e){}
  const envChip = document.getElementById("envChip");
  envChip.textContent = tg ? "Telegram WebApp" : "Browser";

  function hImpact(type="light"){ if(!state.settings.haptic) return; try{ tg?.HapticFeedback?.impactOccurred(type);}catch(e){} }
  function hNote(type="success"){ if(!state.settings.haptic) return; try{ tg?.HapticFeedback?.notificationOccurred(type);}catch(e){} }
  function hSelect(){ if(!state.settings.haptic) return; try{ tg?.HapticFeedback?.selectionChanged();}catch(e){} }

  // ===== Toast
  const toastEl = document.getElementById("toast"); let toastTimer=null;
  function toast(t){ toastEl.textContent=t; toastEl.classList.add("show"); clearTimeout(toastTimer); toastTimer=setTimeout(()=>toastEl.classList.remove("show"), 1500); }

  // ===== State (local)
  const KEY="f1duel_mvp_state_v1";
  const now = ()=>Date.now();

  function randCode(len=6){
    const a="ABCDEFGHJKLMNPQRSTUVWXYZ23456789";
    let s=""; for(let i=0;i<len;i++) s+=a[Math.floor(Math.random()*a.length)];
    return s;
  }
  function shortId(){
    return randCode(4);
  }

  const defaultState = {
    onboarding: { rulesAccepted:false, nicknameSet:false, referralAsked:false },
    profile: {
      publicId: shortId(),
      nickname: "",
      rulesAcceptedAt: 0,
      nicknameChangedAt: 0,
      myRefCode: randCode(6),
      referredBy: "",          // code entered at registration
      refStatus: "none",       // none | pending | activated
      refRewardGiven: false
    },
    wallet: { coins: 120, stars: 0, lockedCoins: 0 }, // give some coins for testing
    settings: { sound:true, haptic:true },
    stats: { wins:0, losses:0, matches:0, streak:0 },
    tx: [], // {ts,type,amount,label}
    matches: [], // {ts, game, stake, payout, opp, status, delta}
    session: {
      selectedStake: 0,
      current: null // {matchId, opp, stake, payout, startedAt}
    }
  };

  const state = (()=> {
    try{
      const raw = localStorage.getItem(KEY);
      if(!raw) return structuredClone(defaultState);
      const s = JSON.parse(raw);
      // shallow merge (simple)
      return {
        ...defaultState,
        ...s,
        onboarding:{...defaultState.onboarding, ...(s.onboarding||{})},
        profile:{...defaultState.profile, ...(s.profile||{})},
        wallet:{...defaultState.wallet, ...(s.wallet||{})},
        settings:{...defaultState.settings, ...(s.settings||{})},
        stats:{...defaultState.stats, ...(s.stats||{})},
        tx: Array.isArray(s.tx)? s.tx : [],
        matches: Array.isArray(s.matches)? s.matches : [],
        session:{...defaultState.session, ...(s.session||{})}
      };
    }catch(e){
      return structuredClone(defaultState);
    }
  })();

  function save(){ localStorage.setItem(KEY, JSON.stringify(state)); renderAll(); }

  function addTx(type, amount, label){
    state.tx.unshift({ts: now(), type, amount, label});
    state.tx = state.tx.slice(0, 40);
  }

  function coinsDelta(n, label){
    state.wallet.coins = Math.max(0, state.wallet.coins + n);
    addTx("coins", n, label);
  }

  // ===== UI routing
  const pages = ["onb-rules","onb-nick","onb-ref","games","search","match","result","wallet","matches","profile"];
  function go(page){
    pages.forEach(p=>{
      const el = document.getElementById("page-"+p);
      if(el) el.classList.toggle("hidden", p!==page);
    });
    ["games","wallet","matches","profile"].forEach(t=>{
      const tab = document.getElementById("tab-"+t);
      if(tab) tab.classList.toggle("active", t===page);
    });
    location.hash = "#"+page;
  }

  // ===== Onboarding gating
  function needsOnboarding(){
    if(!state.onboarding.rulesAccepted) return "onb-rules";
    if(!state.onboarding.nicknameSet) return "onb-nick";
    if(!state.onboarding.referralAsked) return "onb-ref";
    return null;
  }

  // ===== User chip (hide TG username)
  const userChip = document.getElementById("userChip");
  const tgUser = tg?.initDataUnsafe?.user;
  const displayNick = ()=> (state.profile.nickname || "Player");
  function displayMe(){
    return `${displayNick()} #${state.profile.publicId}`;
  }

  // ===== Bets and payout
  const BETS = [5,10,20,50,100];
  const FEE_RATE = 0.05; // 5% of pot (2*stake)
  function calcPayout(stake){
    const pot = stake*2;
    const fee = Math.floor(pot * FEE_RATE);
    return pot - fee;
  }

  // ===== Bet chips render
  const betRow = document.getElementById("betRow");
  const uiStake = document.getElementById("uiStake");
  const uiPayout = document.getElementById("uiPayout");
  const findBtn = document.getElementById("findBtn");
  const insufText = document.getElementById("insufText");

  function renderBets(){
    betRow.innerHTML="";
    const available = state.wallet.coins;
    BETS.forEach(v=>{
      const b = document.createElement("button");
      b.className="chipBet";
      b.textContent = v;
      const disabled = available < v;
      if(disabled) b.classList.add("disabled");
      if(state.session.selectedStake === v) b.classList.add("selected");

      b.onclick = ()=>{
        if(disabled) { hImpact("light"); toast("–ù–µ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ coins"); return; }
        state.session.selectedStake = v;
        hSelect();
        save();
      };
      betRow.appendChild(b);
    });

    const stake = state.session.selectedStake || 0;
    if(!stake){
      uiStake.textContent="‚Äî";
      uiPayout.textContent="‚Äî";
      findBtn.disabled=true;
      insufText.style.display="none";
      return;
    }
    uiStake.textContent = `${stake} coins`;
    uiPayout.textContent = `${calcPayout(stake)} coins`;

    const ok = state.wallet.coins >= stake;
    findBtn.disabled = !ok;
    insufText.style.display = ok ? "none" : "block";
  }

  // ===== SEARCH flow (MVP simulation)
  let searchInterval=null;
  let searchLeft=60;
  const searchStake = document.getElementById("searchStake");
  const searchPayout = document.getElementById("searchPayout");
  const searchTimer = document.getElementById("searchTimer");
  const cancelSearch = document.getElementById("cancelSearch");

  function fmtTime(sec){
    const m = String(Math.floor(sec/60)).padStart(2,"0");
    const s = String(sec%60).padStart(2,"0");
    return `${m}:${s}`;
  }

  function lockStake(stake){
    // lock immediately (A)
    state.wallet.coins -= stake;
    state.wallet.lockedCoins += stake;
    addTx("lock", -stake, `–°—Ç–∞–≤–∫–∞ –∑–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞–Ω–∞ (${stake})`);
  }
  function unlockStake(stake, reason="–°—Ç–∞–≤–∫–∞ –≤–æ–∑–≤—Ä–∞—â–µ–Ω–∞"){
    state.wallet.lockedCoins = Math.max(0, state.wallet.lockedCoins - stake);
    state.wallet.coins += stake;
    addTx("unlock", +stake, reason);
  }

  function startSearch(){
    const stake = state.session.selectedStake;
    if(!stake) return;
    if(state.wallet.coins < stake){ toast("–ù–µ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ coins"); return; }

    lockStake(stake);
    save();

    // show search screen
    searchLeft = 60;
    searchStake.textContent = `${stake} coins`;
    searchPayout.textContent = `${calcPayout(stake)} coins`;
    searchTimer.textContent = fmtTime(searchLeft);
    go("search");
    hImpact("medium");
    toast("–ü–æ–∏—Å–∫ —Å–æ–ø–µ—Ä–Ω–∏–∫–∞‚Ä¶");

    // simulate opponent found between 2..8 sec
    const foundAt = 2 + Math.floor(Math.random()*7);
    const startedAt = now();

    clearInterval(searchInterval);
    searchInterval = setInterval(()=>{
      const elapsed = Math.floor((now()-startedAt)/1000);
      searchLeft = Math.max(0, 60 - elapsed);
      searchTimer.textContent = fmtTime(searchLeft);

      if(elapsed >= foundAt){
        clearInterval(searchInterval);
        autoStartMatch();
        return;
      }
      if(searchLeft<=0){
        clearInterval(searchInterval);
        // timeout ‚Üí unlock
        unlockStake(stake, "–ü–æ–∏—Å–∫: —Å–æ–ø–µ—Ä–Ω–∏–∫ –Ω–µ –Ω–∞–π–¥–µ–Ω");
        state.session.selectedStake = stake; // keep selected
        save();
        toast("–°–æ–ø–µ—Ä–Ω–∏–∫ –Ω–µ –Ω–∞–π–¥–µ–Ω");
        go("games");
      }
    }, 250);
  }

  cancelSearch.onclick = ()=>{
    clearInterval(searchInterval);
    const stake = state.session.selectedStake;
    unlockStake(stake, "–ü–æ–∏—Å–∫ –æ—Ç–º–µ–Ω—ë–Ω: —Å—Ç–∞–≤–∫–∞ –≤–æ–∑–≤—Ä–∞—â–µ–Ω–∞");
    save();
    toast("–ü–æ–∏—Å–∫ –æ—Ç–º–µ–Ω—ë–Ω");
    go("games");
  };

  // ===== MATCH (auto-start)
  const meLine = document.getElementById("meLine");
  const oppLine = document.getElementById("oppLine");
  const matchStake = document.getElementById("matchStake");
  const matchPayout = document.getElementById("matchPayout");
  const btnWin = document.getElementById("btnWin");
  const btnLose = document.getElementById("btnLose");
  const btnSurrender = document.getElementById("btnSurrender");
  const btnOppLeaves = document.getElementById("btnOppLeaves");
  const matchNet = document.getElementById("matchNet");

  function genOpponent(){
    const names=["Ghost","Blitz","Kappa","Nova","Raven","Vega","Pulse","Neon","Drift","Bison"];
    return `${names[Math.floor(Math.random()*names.length)]} #${shortId()}`;
  }

  // 10 sec disconnect rule (we simulate by marking "offline" if page hidden too long)
  let hiddenAt=0;
  document.addEventListener("visibilitychange", ()=>{
    if(document.hidden) hiddenAt = now();
    else{
      if(hiddenAt && state.session.current && (now()-hiddenAt) > 10000){
        // treat as you left
        finishMatch("YOU_LEFT_TIMEOUT");
      }
      hiddenAt=0;
    }
  });

  function autoStartMatch(){
    const stake = state.session.selectedStake;
    const payout = calcPayout(stake);
    const opp = genOpponent();
    const matchId = "m_"+randCode(8);

    state.session.current = {matchId, opp, stake, payout, startedAt: now()};
    save();

    meLine.textContent = displayMe();
    oppLine.textContent = opp;
    matchStake.textContent = `${stake} coins`;
    matchPayout.textContent = `${payout} coins`;
    matchNet.textContent = "üü¢ online";

    go("match");
    hNote("success");
    toast("–ú–∞—Ç—á –Ω–∞—á–∞–ª—Å—è");
  }

  // ===== Result + History
  const resTitle = document.getElementById("resTitle");
  const resSub = document.getElementById("resSub");
  const resDelta = document.getElementById("resDelta");
  const resAgain = document.getElementById("resAgain");
  const resToMatches = document.getElementById("resToMatches");

  function pushMatch(status, delta, label){
    const cur = state.session.current;
    state.matches.unshift({
      ts: now(),
      game:"Ping Pong",
      stake: cur?.stake || 0,
      payout: cur?.payout || 0,
      opp: cur?.opp || "‚Äî",
      status,
      delta,
      label
    });
    state.matches = state.matches.slice(0, 50);
  }

  function finishMatch(type){
    const cur = state.session.current;
    if(!cur) return;

    const stake = cur.stake;
    const payout = cur.payout;

    // Resolve locked stake (always remove from locked)
    state.wallet.lockedCoins = Math.max(0, state.wallet.lockedCoins - stake);

    let title="–†–µ–∑—É–ª—å—Ç–∞—Ç", subtitle="‚Äî", delta=0, status="";

    const pot = stake*2;
    const fee = Math.floor(pot * FEE_RATE);
    const penalty = fee*2;

    if(type==="WIN"){
      // winner gets payout (stake already locked -> not in coins). Give payout to available.
      coinsDelta(+payout, `–ü–æ–±–µ–¥–∞ (–≤—ã–ø–ª–∞—Ç–∞ ${payout})`);
      title="–ü–æ–±–µ–¥–∞";
      subtitle=`Ping Pong ‚Ä¢ —Å—Ç–∞–≤–∫–∞ ${stake}`;
      delta = +payout;
      status="WIN";
      state.stats.wins += 1;
      state.stats.matches += 1;
      state.stats.streak = Math.max(0, state.stats.streak) + 1;
      pushMatch(status, delta, "–ü–æ–±–µ–¥–∞");

      // referral activation trigger (invitee first duel)
      maybeActivateReferralAfterFirstDuel();

    } else if(type==="LOSE"){
      // you lose your locked stake (already removed from locked). No coins returned.
      addTx("lose", 0, `–ü–æ—Ä–∞–∂–µ–Ω–∏–µ (—Å—Ç–∞–≤–∫–∞ ${stake} —Å–≥–æ—Ä–µ–ª–∞)`);
      title="–ü–æ—Ä–∞–∂–µ–Ω–∏–µ";
      subtitle=`Ping Pong ‚Ä¢ —Å—Ç–∞–≤–∫–∞ ${stake}`;
      delta = -stake;
      status="LOSE";
      state.stats.losses += 1;
      state.stats.matches += 1;
      state.stats.streak = 0;
      pushMatch(status, delta, "–ü–æ—Ä–∞–∂–µ–Ω–∏–µ");

      maybeActivateReferralAfterFirstDuel();

    } else if(type==="OPP_LEFT"){
      // opponent left: return your stake
      coinsDelta(+stake, `–°–æ–ø–µ—Ä–Ω–∏–∫ –≤—ã—à–µ–ª (—Å—Ç–∞–≤–∫–∞ –≤–æ–∑–≤—Ä–∞—â–µ–Ω–∞ ${stake})`);
      title="–°–æ–ø–µ—Ä–Ω–∏–∫ –ø–æ–∫–∏–Ω—É–ª –º–∞—Ç—á";
      subtitle="–¢–≤–æ—è —Å—Ç–∞–≤–∫–∞ –≤–æ–∑–≤—Ä–∞—â–µ–Ω–∞";
      delta = +stake;
      status="OPPONENT_LEFT";
      state.stats.matches += 1;
      // streak not affected
      pushMatch(status, delta, "–°–æ–ø–µ—Ä–Ω–∏–∫ –≤—ã—à–µ–ª");

    } else if(type==="YOU_LEFT" || type==="YOU_LEFT_TIMEOUT"){
      // you left: lose stake + penalty
      // stake already gone; apply penalty from available coins
      const before = state.wallet.coins;
      state.wallet.coins = Math.max(0, state.wallet.coins - penalty);
      addTx("penalty", -penalty, `–®—Ç—Ä–∞—Ñ –∑–∞ –≤—ã—Ö–æ–¥ (${penalty})`);
      title="–¢—ã –ø–æ–∫–∏–Ω—É–ª –º–∞—Ç—á";
      subtitle = type==="YOU_LEFT_TIMEOUT" ? "–û—Ç–∫–ª—é—á–µ–Ω–∏–µ > 10 —Å–µ–∫" : "–°–¥–∞—á–∞";
      delta = -(stake + penalty);
      status="YOU_LEFT";
      state.stats.losses += 1;
      state.stats.matches += 1;
      state.stats.streak = 0;
      pushMatch(status, delta, "–í—ã—Ö–æ–¥/—Å–¥–∞—á–∞");

      // return stake to the other player (we don't track them). In real backend.
      // house takes fee*2 (penalty) in real backend.
    }

    // clear current match
    state.session.current = null;

    // UI
    resTitle.textContent = title;
    resSub.textContent = subtitle;
    resDelta.textContent = `${delta>0?"+":""}${delta} coins`;
    resDelta.style.color = delta>=0 ? "var(--accent)" : "var(--danger)";

    save();
    go("result");
    hNote(delta>=0 ? "success" : "error");
  }

  btnWin.onclick = ()=> finishMatch("WIN");
  btnLose.onclick = ()=> finishMatch("LOSE");
  btnOppLeaves.onclick = ()=> {
    // return your stake and end
    finishMatch("OPP_LEFT");
  };

  // ===== Modal confirm surrender
  const modalWrap = document.getElementById("modalWrap");
  const modalTitle = document.getElementById("modalTitle");
  const modalText = document.getElementById("modalText");
  const modalOk = document.getElementById("modalOk");
  const modalCancel = document.getElementById("modalCancel");

  function openModal(title, text, onOk){
    modalTitle.textContent = title;
    modalText.textContent = text;
    modalWrap.classList.add("show");
    modalOk.onclick = ()=>{
      modalWrap.classList.remove("show");
      onOk?.();
    };
    modalCancel.onclick = ()=> modalWrap.classList.remove("show");
  }
  btnSurrender.onclick = ()=>{
    const cur = state.session.current;
    if(!cur) return;
    const pot = cur.stake*2;
    const fee = Math.floor(pot * FEE_RATE);
    const penalty = fee*2;
    openModal(
      "–°–¥–∞—Ç—å—Å—è?",
      `–¢—ã –ø–æ—Ç–µ—Ä—è–µ—à—å —Å—Ç–∞–≤–∫—É –∏ –ø–æ–ª—É—á–∏—à—å —à—Ç—Ä–∞—Ñ ${penalty} coins.`,
      ()=> finishMatch("YOU_LEFT")
    );
  };

  resAgain.onclick = ()=> go("games");
  resToMatches.onclick = ()=> go("matches");

  // ===== Referral (MVP UI)
  // Note: Without backend, we can't credit inviter across users. We still store referredBy + pending.
  function normalizeRef(code){ return (code||"").trim().toUpperCase().replace(/[^A-Z0-9]/g,""); }

  function maybeActivateReferralAfterFirstDuel(){
    // If user entered referral code at registration, mark activated after first duel (any result)
    if(state.profile.referredBy && state.profile.refStatus==="pending"){
      state.profile.refStatus="activated";
      addTx("ref", 0, "–†–µ—Ñ–µ—Ä–∞–ª –∞–∫—Ç–∏–≤–∏—Ä–æ–≤–∞–Ω (–Ω–∞—á–∏—Å–ª–µ–Ω–∏–µ –ø—Ä–∏–≥–ª–∞—Å–∏–≤—à–µ–º—É ‚Äî –Ω–∞ —Å–µ—Ä–≤–µ—Ä–µ)");
      toast("–†–µ—Ñ–µ—Ä–∞–ª –∞–∫—Ç–∏–≤–∏—Ä–æ–≤–∞–Ω");
    }
  }

  // ===== Profile screen
  const profNick = document.getElementById("profNick");
  const profId = document.getElementById("profId");
  const rulesAcceptedLine = document.getElementById("rulesAcceptedLine");
  const myRefCode = document.getElementById("myRefCode");
  const copyRefBtn = document.getElementById("copyRefBtn");
  const shareRefBtn = document.getElementById("shareRefBtn");
  const editNickBtn = document.getElementById("editNickBtn");

  function formatDate(ts){
    try{
      const d=new Date(ts);
      return d.toLocaleDateString("ru-RU",{day:"2-digit",month:"short",year:"numeric"});
    }catch(e){ return "‚Äî"; }
  }

  editNickBtn.onclick = ()=>{
    openModal(
      "–ò–∑–º–µ–Ω–∏—Ç—å –Ω–∏–∫",
      "–í–≤–µ–¥–∏ –Ω–æ–≤—ã–π –Ω–∏–∫ –≤ —Å–ª–µ–¥—É—é—â–µ–º –æ–∫–Ω–µ.",
      ()=>{
        const next = prompt("–ù–æ–≤—ã–π –Ω–∏–∫ (3‚Äì16, –ª–∞—Ç–∏–Ω–∏—Ü–∞/—Ü–∏—Ñ—Ä—ã/_):", state.profile.nickname || "");
        if(next===null) return;
        const nick = next.trim();
        if(!/^[A-Za-z0-9_]{3,16}$/.test(nick)){
          toast("–ù–µ–≤–µ—Ä–Ω—ã–π —Ñ–æ—Ä–º–∞—Ç –Ω–∏–∫–∞");
          return;
        }
        state.profile.nickname = nick;
        state.profile.nicknameChangedAt = now();
        save();
        toast("–ù–∏–∫ –æ–±–Ω–æ–≤–ª—ë–Ω");
      }
    );
  };

  copyRefBtn.onclick = async ()=>{
    try{
      await navigator.clipboard.writeText(state.profile.myRefCode);
      toast("–ö–æ–¥ —Å–∫–æ–ø–∏—Ä–æ–≤–∞–Ω");
    }catch(e){
      toast("–ù–µ —É–¥–∞–ª–æ—Å—å —Å–∫–æ–ø–∏—Ä–æ–≤–∞—Ç—å");
    }
  };

  shareRefBtn.onclick = ()=>{
    const text = `–ú–æ–π —Ä–µ—Ñ-–∫–æ–¥ –≤ F1 Duel: ${state.profile.myRefCode}`;
    try{
      if(tg?.shareText) tg.shareText(text);
      else {
        navigator.clipboard?.writeText(text);
        toast("–¢–µ–∫—Å—Ç —Å–∫–æ–ø–∏—Ä–æ–≤–∞–Ω");
      }
    }catch(e){
      toast("–ü–æ–¥–µ–ª–∏—Ç—å—Å—è –Ω–µ –ø–æ–ª—É—á–∏–ª–æ—Å—å");
    }
  };

  // ===== Wallet render
  const coinsVal = document.getElementById("coinsVal");
  const starsVal = document.getElementById("starsVal");
  const txList = document.getElementById("txList");
  const resetBtn = document.getElementById("resetBtn");

  resetBtn.onclick = ()=>{
    localStorage.removeItem(KEY);
    location.reload();
  };

  function renderWallet(){
    coinsVal.textContent = state.wallet.coins;
    starsVal.textContent = state.wallet.stars;

    txList.innerHTML="";
    if(state.tx.length===0){
      const d=document.createElement("div");
      d.className="muted";
      d.textContent="–û–ø–µ—Ä–∞—Ü–∏–π –ø–æ–∫–∞ –Ω–µ—Ç.";
      txList.appendChild(d);
      return;
    }
    state.tx.slice(0,12).forEach(t=>{
      const item=document.createElement("div");
      item.className="pill";
      const sign = t.amount>0 ? "+" : "";
      item.innerHTML = `
        <div>
          <div style="font-weight:800">${t.label}</div>
          <div class="small">${new Date(t.ts).toLocaleString("ru-RU")}</div>
        </div>
        <div style="font-weight:950; color:${t.amount>=0?'var(--accent)':'var(--danger)'}">${sign}${t.amount}</div>
      `;
      txList.appendChild(item);
    });
  }

  // ===== Matches render
  const matchesEmpty = document.getElementById("matchesEmpty");
  const matchesList = document.getElementById("matchesList");
  function renderMatches(){
    if(state.matches.length===0){
      matchesEmpty.style.display="block";
      matchesList.style.display="none";
      return;
    }
    matchesEmpty.style.display="none";
    matchesList.style.display="flex";
    matchesList.innerHTML="";

    state.matches.slice(0,20).forEach(m=>{
      const card=document.createElement("div");
      card.className="pill";
      const color = m.delta>=0 ? "var(--accent)" : "var(--danger)";
      const sign = m.delta>0 ? "+" : "";
      const tagClass = m.status==="WIN" ? "win" : (m.status==="LOSE" || m.status==="YOU_LEFT" ? "lose" : "");
      const statusLabel =
        m.status==="WIN" ? "–ü–æ–±–µ–¥–∞" :
        m.status==="LOSE" ? "–ü–æ—Ä–∞–∂–µ–Ω–∏–µ" :
        m.status==="OPPONENT_LEFT" ? "–°–æ–ø–µ—Ä–Ω–∏–∫ –≤—ã—à–µ–ª" :
        m.status==="YOU_LEFT" ? "–í—ã—Ö–æ–¥/—Å–¥–∞—á–∞" : "–ú–∞—Ç—á";

      card.innerHTML = `
        <div style="min-width:0">
          <div style="display:flex; gap:8px; align-items:center; flex-wrap:wrap">
            <strong>${m.game}</strong>
            <span class="tag ${tagClass}">${statusLabel}</span>
          </div>
          <div class="small">vs ${m.opp} ‚Ä¢ —Å—Ç–∞–≤–∫–∞ ${m.stake} ‚Ä¢ ${new Date(m.ts).toLocaleString("ru-RU")}</div>
        </div>
        <div style="font-weight:950; color:${color}">${sign}${m.delta} coins</div>
      `;
      matchesList.appendChild(card);
    });
  }

  // ===== Settings
  const setSound = document.getElementById("setSound");
  const setHaptic = document.getElementById("setHaptic");
  setSound.onchange = ()=>{ state.settings.sound = !!setSound.checked; save(); };
  setHaptic.onchange = ()=>{ state.settings.haptic = !!setHaptic.checked; save(); };

  // ===== Online counter (simulated)
  const onlineNow = document.getElementById("onlineNow");
  let onlineBase = 80 + Math.floor(Math.random()*140);
  function tickOnline(){
    const wobble = Math.floor((Math.random()*10)-5);
    onlineBase = Math.max(20, onlineBase + wobble);
    onlineNow.textContent = onlineBase;
  }
  setInterval(tickOnline, 8000);

  // ===== Onboarding actions
  const rulesCheck = document.getElementById("rulesCheck");
  const rulesContinue = document.getElementById("rulesContinue");
  rulesCheck.onchange = ()=>{ rulesContinue.disabled = !rulesCheck.checked; };
  rulesContinue.onclick = ()=>{
    state.onboarding.rulesAccepted = true;
    state.profile.rulesAcceptedAt = now();
    save();
    go("onb-nick");
  };

  const nickInput = document.getElementById("nickInput");
  const nickSave = document.getElementById("nickSave");
  const nickSkip = document.getElementById("nickSkip");
  const nickError = document.getElementById("nickError");

  function setNick(nick){
    nickError.style.display="none";
    const n = (nick||"").trim();
    if(!n){
      // allow skip -> random
      const auto = "Player_"+randCode(3);
      state.profile.nickname = auto;
    } else {
      if(!/^[A-Za-z0-9_]{3,16}$/.test(n)){
        nickError.textContent="–ù–µ–≤–µ—Ä–Ω—ã–π —Ñ–æ—Ä–º–∞—Ç. –¢–æ–ª—å–∫–æ –ª–∞—Ç–∏–Ω–∏—Ü–∞/—Ü–∏—Ñ—Ä—ã/_ (3‚Äì16)";
        nickError.style.display="block";
        return false;
      }
      state.profile.nickname = n;
    }
    state.onboarding.nicknameSet = true;
    state.profile.nicknameChangedAt = now();
    return true;
  }

  nickSave.onclick = ()=>{
    if(setNick(nickInput.value)){
      save();
      go("onb-ref");
    }
  };
  nickSkip.onclick = ()=>{
    if(setNick("")){
      save();
      go("onb-ref");
    }
  };

  const refInput = document.getElementById("refInput");
  const refApply = document.getElementById("refApply");
  const refSkip = document.getElementById("refSkip");
  const refError = document.getElementById("refError");

  function applyReferral(){
    refError.style.display="none";
    const code = normalizeRef(refInput.value);
    if(!code){
      state.onboarding.referralAsked = true;
      save();
      go("games");
      return;
    }
    if(code === normalizeRef(state.profile.myRefCode)){
      refError.textContent="–ù–µ–ª—å–∑—è –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å —Å–≤–æ–π –∫–æ–¥";
      refError.style.display="block";
      return;
    }
    // In MVP we accept any non-empty code (backend will validate).
    state.profile.referredBy = code;
    state.profile.refStatus = "pending";
    addTx("ref_pending", 0, `–†–µ—Ñ-–∫–æ–¥ –ø—Ä–∏–º–µ–Ω—ë–Ω: ${code}`);
    state.onboarding.referralAsked = true;
    save();
    toast("–ö–æ–¥ –ø—Ä–∏–º–µ–Ω—ë–Ω");
    go("games");
  }

  refApply.onclick = applyReferral;
  refSkip.onclick = ()=>{
    state.onboarding.referralAsked = true;
    save();
    go("games");
  };

  // ===== Main button
  findBtn.onclick = startSearch;

  // ===== Render all
  function renderProfile(){
    profNick.textContent = displayNick();
    profId.textContent = `#${state.profile.publicId}`;
    rulesAcceptedLine.textContent = state.profile.rulesAcceptedAt ? `–ü—Ä–∏–Ω—è—Ç—ã: ${formatDate(state.profile.rulesAcceptedAt)}` : "‚Äî";
    myRefCode.textContent = state.profile.myRefCode;

    document.getElementById("stWins").textContent = state.stats.wins;
    document.getElementById("stLoss").textContent = state.stats.losses;
    document.getElementById("stMatches").textContent = state.stats.matches;
    document.getElementById("stStreak").textContent = state.stats.streak;

    setSound.checked = !!state.settings.sound;
    setHaptic.checked = !!state.settings.haptic;
  }

  function renderTopUserChip(){
    userChip.textContent = displayMe();
  }

  function renderAll(){
    renderTopUserChip();
    renderBets();
    renderWallet();
    renderMatches();
    renderProfile();
    tickOnline();
  }

  // ===== Init navigation + start page
  function initNav(){
    const required = needsOnboarding();
    if(required){
      go(required);
      return;
    }
    const hash = (location.hash||"#games").slice(1);
    if(pages.includes(hash)) go(hash);
    else go("games");
  }

  // ===== Start
  renderAll();
  initNav();

  // If telegram user exists, keep hidden info only for backend later (we don't show username)
  if(tgUser){
    // could store tg_id locally for debug (not shown)
    // state.profile.tgId = tgUser.id; // optional
  }
</script>
</body>
</html>
